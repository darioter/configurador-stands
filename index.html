<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DALI | Diseñador de Stands (Público)</title>
<style>
  /* Estilos base existentes... (deja los tuyos) */

  /* layout lateral */
  .kpi{display:flex;align-items:center;justify-content:space-between;padding:6px 0;font-size:14px}
  .hr{height:1px;background:#e5e7eb;margin:6px 0}
  .btn{padding:8px 12px;border:0;border-radius:10px;background:#111827;color:#fff;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .hint{font-size:12px;color:#6b7280}
</style>
</head>
<body>

<!-- ==========================
     TU APP ORIGINAL
     (toolbar, canvas SVG con id="svg", sidebar con id="summary", etc.)
     Importante: mantené los mismos IDs de tus botones si los tenías:
       - btnDownloadPNG (Descargar PNG)
       - btnQuote       (Solicitar cotización)
     ========================== -->

<header>
  <!-- tus controles / toolbars -->
  <button id="btnDownloadPNG" class="btn">Descargar PNG</button>
  <button id="btnQuote" class="btn">Solicitar cotización</button>
</header>

<main style="display:grid;grid-template-columns:1fr 320px;gap:12px;margin-top:10px">
  <section>
    <!-- Tu lienzo existente: IMPORTANTE mantener id="svg" -->
    <svg id="svg" width="100%" height="600" viewBox="0 0 1600 1200"></svg>
  </section>

  <aside>
    <h3>Resumen</h3>
    <div id="summary"></div>
  </aside>
</main>

<!-- (si tu versión original tiene más HTML, mantenelo aquí tal cual) -->

<script>
/* =========================================================
   BLOQUE MODO PÚBLICO (NO ROMPE EL EDITOR)
   - PUBLIC_MODE=true: renderiza Resumen sin precios.
   - PUBLIC_MODE=false: usa tu renderSummary original (admin).
   ========================================================= */
window.PUBLIC_MODE = true; // ← cambiar a false para versión admin

// Guarda la versión original (si ya existe) y crea un wrapper seguro
(function(){
  try{
    // Si tu app define renderSummary más adelante, esta captura igual funciona
    var originalDefined = (typeof window.renderSummary === 'function');
    if(originalDefined && !window.renderSummaryPrivate){
      window.renderSummaryPrivate = window.renderSummary;
    }
  }catch(_){}
})();

// Wrapper que decide según PUBLIC_MODE sin tocar tu editor
(function(){
  function renderPublicOnly(){
    try{
      var x = (typeof countsAndCosts==='function') ? countsAndCosts() : {lines:[]};
      var lines = x.lines || [];
      var html  = '<div class="kpi"><strong>Concepto</strong><strong>Cant.</strong></div><div class="hr"></div>';
      for (var i=0;i<lines.length;i++){
        var L = lines[i];
        if (L && L.qty && L.qty>0){
          html += '<div class="kpi"><span>'+ (L.label||'-') +'</span><span>'+ L.qty +'</span></div>';
        }
      }
      var el = document.getElementById('summary');
      if (el) el.innerHTML = html;
    }catch(e){
      // si algo falla, mejor no romper UI
      try{ if (typeof window.renderSummaryPrivate==='function') return window.renderSummaryPrivate(); }catch(_){}
    }
  }

  // Instalamos fachada que respeta tu original si existe
  var tryInstall = function(){
    try{
      if (typeof window.renderSummary === 'function' && window.renderSummary !== renderPublicOnly){
        if (!window.renderSummaryPrivate) window.renderSummaryPrivate = window.renderSummary;
        window.renderSummary = function(){
          if (!window.PUBLIC_MODE && typeof window.renderSummaryPrivate==='function'){
            return window.renderSummaryPrivate(); // admin
          }
          return renderPublicOnly(); // público
        };
      } else if (typeof window.renderSummary !== 'function') {
        // si no existe, definimos una pública simple
        window.renderSummary = renderPublicOnly;
      }
    }catch(_){}
  };

  // Intento inmediato y al DOMContentLoaded por si tu app carga luego
  tryInstall();
  document.addEventListener('DOMContentLoaded', tryInstall);
})();
</script>

<script>
/* ==============================================
   BOTONES: descargar PNG y abrir modal de contacto
   (no cambian tu lógica; sólo agregan handlers)
   ============================================== */
const reEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

async function getPreviewJPEG(){
  const svg = document.getElementById('svg'); if(!svg) return "";
  const xml = new XMLSerializer().serializeToString(svg);
  const svg64 = btoa(unescape(encodeURIComponent(xml)));
  const img = new Image(); img.src = "data:image/svg+xml;base64," + svg64;
  await new Promise(res=>{ img.onload=res; img.onerror=res; });
  const w = img.naturalWidth || (svg.viewBox&&svg.viewBox.baseVal.width)  || 1600;
  const h = img.naturalHeight|| (svg.viewBox&&svg.viewBox.baseVal.height) || 1200;
  const c = document.createElement('canvas'); c.width=w; c.height=h;
  const ctx = c.getContext('2d'); ctx.fillStyle="#fff"; ctx.fillRect(0,0,w,h);
  try{ ctx.drawImage(img,0,0,w,h); }catch(_){}
  return c.toDataURL("image/jpeg", 0.92);
}

(function wireButtons(){
  const btnPNG = document.getElementById('btnDownloadPNG');
  if(btnPNG){
    btnPNG.addEventListener('click', async ()=>{
      const data = await getPreviewJPEG();
      if(!data){ alert("No pude generar la imagen del boceto"); return; }
      const a = document.createElement('a');
      a.href = data.replace("image/jpeg","image/png");
      a.download = "boceto_dali.png";
      document.body.appendChild(a); a.click(); a.remove();
    });
  }
  const btnQuote = document.getElementById('btnQuote');
  if(btnQuote){
    btnQuote.addEventListener('click', ()=>{
      document.getElementById('contactModal').style.display='flex';
      const el=document.getElementById('q_info'); if(el) el.textContent='';
    });
  }
})();
</script>

<!-- ===== MODAL DE CONTACTO (público) ===== -->
<div id="contactModal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(17,24,39,.55);z-index:9999">
  <div style="background:#fff;border-radius:14px;padding:16px;min-width:320px;max-width:520px;box-shadow:0 12px 40px rgba(0,0,0,.25)">
    <h3 style="margin:0 0 10px">Solicitar cotización</h3>
    <div style="display:grid;gap:10px">
      <label>Nombre / Empresa
        <input id="c_name" type="text" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:10px">
      </label>
      <label>Contacto (email o WhatsApp)
        <input id="c_contact" type="text" placeholder="email@dominio.com o 54911..." style="width:100%;padding:8px;border:1px solid #ddd;border-radius:10px">
      </label>
      <label>Enviar por
        <select id="c_channel" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:10px">
          <option value="email">Email</option>
          <option value="whatsapp">WhatsApp</option>
        </select>
      </label>
      <label>Mensaje (opcional)
        <textarea id="c_msg" rows="3" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:10px"></textarea>
      </label>
      <div id="q_info" class="hint" style="min-height:18px;color:#6b7280"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="c_cancel" class="btn" type="button">Cancelar</button>
        <button id="c_send"   class="btn" type="button">Enviar</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ==============================
   PACK DE CONTACTO (Email/WhatsApp)
   - Usa CONTACT.webhook_url y to_email existentes.
   - CC al cliente si pone email.
   - Copia la imagen al portapapeles para pegarla en WhatsApp.
   ============================== */
const WHATSAPP_NUMBER = "5491160410607";
const CONTACT = window.CONTACT || CONTACT || {};
const WEBHOOK_URL = CONTACT.webhook_url || "";  // dejá tu URL de Apps Script
const DEST_EMAIL  = CONTACT.to_email   || "dario@dali-arquitectura.com.ar";

const $ = (id)=>document.getElementById(id);
function setInfo(m){ const el=$('q_info'); if(el) el.textContent=m||''; }

async function postWebhook(payload){
  if(!WEBHOOK_URL) return {ok:false};
  try{
    const r = await fetch(WEBHOOK_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
    if(r.ok) return {ok:true, via:"json"};
  }catch(_){}
  try{
    await fetch(WEBHOOK_URL,{method:"POST",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify(payload),mode:"no-cors"});
    return {ok:true, via:"text/plain-no-cors"};
  }catch(_){}
  try{
    let ifr=$('send_target_iframe'); if(!ifr){ ifr=document.createElement('iframe'); ifr.name=ifr.id='send_target_iframe'; ifr.style.display='none'; document.body.appendChild(ifr); }
    const f=document.createElement('form'); f.action=WEBHOOK_URL; f.method='POST'; f.enctype='text/plain'; f.target='send_target_iframe';
    const t=document.createElement('textarea'); t.name='raw'; t.value=JSON.stringify(payload);
    f.appendChild(t); document.body.appendChild(f); f.submit(); setTimeout(()=>{try{f.remove()}catch{}},600);
    return {ok:true, via:"form-post"};
  }catch(_){}
  return {ok:false};
}

async function copyImageToClipboard(jpegDataUrl){
  try{
    if(!jpegDataUrl) return;
    if(navigator.clipboard && window.ClipboardItem){
      const res = await fetch(jpegDataUrl);
      const blob = await res.blob();
      await navigator.clipboard.write([new ClipboardItem({[blob.type]: blob})]);
      setInfo("Imagen del boceto copiada. Pegala en WhatsApp.");
    }
  }catch(_){}
}

async function openWhatsApp(payload){
  const texto = encodeURIComponent(
    `Quiero cotizar este diseño.\n\nNombre/Empresa: ${payload.contact.name}\nContacto: ${payload.contact.contact}\n${payload.contact.msg||""}`
  );
  await copyImageToClipboard(payload.image);
  const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${texto}`;
  window.open(url, "_blank");
}

async function sendLeadEmailCopy(payload){
  const copy = {
    meta:{ channel: payload.channel, ts: new Date().toISOString() },
    contact: payload.contact,
    design: payload.design || {},
    image: payload.image || ""
  };
  // CC al cliente si su contacto es mail
  if(/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(payload.contact.contact)){
    copy.to_email = DEST_EMAIL;
    copy.cc_email = payload.contact.contact;
  }else{
    copy.to_email = DEST_EMAIL;
  }
  try{ await postWebhook(copy); }catch(_){}
}

function buildPayloadMinimal(){
  try{
    return {
      design:{
        grid:{w:(S&&S.gridW)||0,h:(S&&S.gridH)||0},
        lot:{type:S.lotType, orient:S.lotOrient},
        sides:S.sides, pantallas:S.pantallas,
        items:S.cells, overlays:S.cenefas
      }
    };
  }catch(_){ return {design:{}, image:""}; }
}

(function wireContactModal(){
  const modal  = $('contactModal');
  const cancel = $('c_cancel');
  const send   = $('c_send');

  cancel?.addEventListener('click', ()=>{ modal.style.display='none'; });

  send?.addEventListener('click', async ()=>{
    const name    = ($('c_name').value||"").trim();
    const contact = ($('c_contact').value||"").trim();
    const channel = ($('c_channel').value||"email");
    const msg     = ($('c_msg').value||"").trim();
    if(!name){ setInfo("Completá tu nombre / empresa"); $('c_name').focus(); return; }
    if(!contact){ setInfo("Completá un contacto (email o WhatsApp)"); $('c_contact').focus(); return; }

    setInfo("Generando boceto…");
    const image = await getPreviewJPEG();
    const base  = buildPayloadMinimal();
    const payload = Object.assign({}, base, { channel, image, contact:{name,contact,msg} });

    if(channel==='email' || /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(contact)){
      setInfo("Enviando por email…");
      payload.channel  = 'email';
      payload.to_email = DEST_EMAIL;
      if(/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(contact)) payload.cc_email = contact;
      const r = await postWebhook(payload);
      setInfo(r.ok ? "Enviado ✅" : "No se pudo confirmar el envío");
    }else{
      setInfo("Abriendo WhatsApp…");
      payload.channel='whatsapp';
      await openWhatsApp(payload);     // abre chat
      await sendLeadEmailCopy(payload);// copia por mail al estudio
      setInfo("Listo. Te copié el boceto al portapapeles ✅");
    }
    setTimeout(()=>{ modal.style.display='none'; setInfo(""); }, 1200);
  });
})();
</script>

</body>
</html>
