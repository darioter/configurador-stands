<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DALI | Diseñador de Stands (Full)</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#111827; --muted:#6b7280; --line:#e5e7eb; --accent:#38bdf8;
      --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
    }
    body{margin:0;background:#0b1220;color:#e5e7eb;font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
    header{display:flex;gap:8px;padding:10px;border-bottom:1px solid #111827;background:#0e1628;position:sticky;top:0;z-index:2}
    .btn{background:#111827;color:#fff;border:0;border-radius:10px;padding:8px 12px;cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
    .grid{display:grid;grid-template-columns:1fr 320px;gap:14px;padding:14px}
    aside{background:#0e1628;border:1px solid #111827;border-radius:14px;padding:12px}
    h3{margin:0 0 8px 0}
    .kpi{display:flex;align-items:center;justify-content:space-between;padding:6px 0}
    .hr{height:1px;background:#111827;margin:6px 0}
    svg{width:100%;height:70vh;background:#0e1628;border:1px solid #111827;border-radius:14px}
    .card{background:#0e1628;border:1px solid #111827;border-radius:12px;padding:10px;margin:8px 0}
    .row{display:grid;grid-template-columns:1fr 120px;gap:8px;align-items:center;padding:4px 0}
    .row input{width:100%;padding:6px;border:1px solid #1f2937;background:#0b1220;color:#e5e7eb;border-radius:10px}
    .hint{color:#9ca3af;font-size:12px}
  </style>
</head>
<body>

  <header>
    <button id="btnDownloadPNG" class="btn">Descargar PNG</button>
    <button id="btnQuote" class="btn">Solicitar cotización</button>
    <button id="btnCosts" class="btn">Editor de costos</button>
  </header>

  <div class="grid">
    <section>
      <!-- Lienzo principal -->
      <svg id="svg" viewBox="0 0 1600 1200"></svg>
    </section>
    <aside>
      <h3>Resumen</h3>
      <div id="summary"></div>
      <div class="hr"></div>
      <div class="hint">En modo público se muestran solo cantidades (sin precios).</div>
    </aside>
  </div>

  <!-- ================= CONFIG & ESTADO ================ -->
  <script>
  // Config global
  var CFG = {
    cell: 100,           // tamaño de celda para dibujo
    palette: {
      tabique: '#94a3b8',
      corner:  '#93c5fd',
      cenefaApo: '#f59e0b',
      cenefaSus: '#38bdf8'
    },
    prices: {
      // (ejemplo de base; el usuario puede editar en modal)
      tabique1m: 100,
      corner50:  40,
      // NUEVOS
      mesaR30: 60,
      mesaR50: 90,
      cenefaCornerApo: 50,
      cenefaCornerSus: 60
    }
  };

  // Estado simple de ejemplo
  var S = {
    gridW: 8, gridH: 6,
    lotType: 'simple', lotOrient: 0,
    sides: [], pantallas: [],
    cells: [],     // items de mobiliario en celdas
    cenefas: []    // cenefas y esquineros
  };

  // Grupo/paleta para editor de costos dinámico
  var GROUPS = {
    cenefas: [
      {key:'cenefaApo100',label:'Cenefa apoyada'},
      {key:'cenefaSus100',label:'Cenefa suspendida'},
      // NUEVOS
      {key:'cenefaCornerApo',label:'Esquinero cenefa (apoyada)'},
      {key:'cenefaCornerSus',label:'Esquinero cenefa (suspendida)'}
    ],
    mobiliario: [
      {key:'banqueta',label:'Banqueta'},
      // NUEVOS
      {key:'mesaR30',label:'Mesa ratona Ø30cm'},
      {key:'mesaR50',label:'Mesa alta Ø50cm'}
    ]
  };

  window.CFG = CFG; window.GROUPS = GROUPS;

  // MIGRACIÓN/DEFAULTS (por si viene de storage viejo)
  (function(){
    try{
      var p = CFG.prices = CFG.prices || {};
      if(typeof p.mesaR30!== 'number') p.mesaR30 = 60;
      if(typeof p.mesaR50!== 'number') p.mesaR50 = 90;
      if(typeof p.cenefaCornerApo!== 'number') p.cenefaCornerApo = 50;
      if(typeof p.cenefaCornerSus!== 'number') p.cenefaCornerSus = 60;
    }catch(e){}
  })();

  // Modo público: oculta precios del resumen, sin romper admin
  window.PUBLIC_MODE = true; // poner false para admin
  </script>

  <!-- ===================== DIBUJO ====================== -->
  <script>
  var svg = document.getElementById('svg');
  var NS = 'http://www.w3.org/2000/svg';

  function clearSVG(){ while(svg.firstChild) svg.removeChild(svg.firstChild); }

  // Helpers
  function rect(x,y,w,h,fill,stroke,sw){
    var r = document.createElementNS(NS,'rect');
    r.setAttribute('x',x); r.setAttribute('y',y);
    r.setAttribute('width',w); r.setAttribute('height',h);
    if(fill)   r.setAttribute('fill',fill);
    if(stroke){r.setAttribute('stroke',stroke); r.setAttribute('stroke-width',sw||2);}
    return r;
  }
  function line(x1,y1,x2,y2,stroke,sw, dash){
    var l = document.createElementNS(NS,'line');
    l.setAttribute('x1',x1); l.setAttribute('y1',y1);
    l.setAttribute('x2',x2); l.setAttribute('y2',y2);
    l.setAttribute('stroke',stroke||'#fff');
    if(sw) l.setAttribute('stroke-width',sw);
    l.setAttribute('stroke-linecap','round');
    if(dash) l.setAttribute('stroke-dasharray', dash);
    return l;
  }
  function circle(cx,cy,r,fill,stroke,sw){
    var c = document.createElementNS(NS,'circle');
    c.setAttribute('cx',cx); c.setAttribute('cy',cy); c.setAttribute('r',r);
    if(fill) c.setAttribute('fill',fill);
    if(stroke){ c.setAttribute('stroke',stroke); c.setAttribute('stroke-width',sw||2); }
    return c;
  }

  // Para construir coords de celda
  function cellXY(i,j){ return {x: i*CFG.cell, y: j*CFG.cell}; }

  // ============ CREACIÓN DE PIEZAS DE EJEMPLO ============
  // CENEFA_KEYS que se pueden poner en overlays
  var CENEFA_KEYS = ['cenefaApo100','cenefaSus100','cenefaCornerApo','cenefaCornerSus'];

  // setPos: orientación para corner y esquineros de cenefa
  function setPos(it, i, j, o){ it.i=i; it.j=j; it.o=o||0; return it; }

  // Dibujo de cenefas y esquineros
  function drawCenefas(){
    var thick = 6; // grosor referencia
    for(var k=0;k<S.cenefas.length;k++){
      var it = S.cenefas[k];
      var pos = cellXY(it.i||0, it.j||0);
      var px = pos.x, py = pos.y;

      // --- Esquineros punteados ---
      if(it.kind==='cenefaCornerApo' || it.kind==='cenefaCornerSus'){
        var tC = thick;
        var o  = it.o||0;
        var col = (it.kind==='cenefaCornerApo') ? CFG.palette.cenefaApo : CFG.palette.cenefaSus;
        // dos brazos desde la esquina
        if(o===0){
          svg.appendChild(line(px, py+tC/2, px+CFG.cell/2, py+tC/2, col, tC, '1 6'));
          svg.appendChild(line(px+tC/2, py, px+tC/2, py+CFG.cell/2, col, tC, '1 6'));
        }else if(o===1){
          svg.appendChild(line(px, py+tC/2, px+CFG.cell/2, py+tC/2, col, tC, '1 6'));
          svg.appendChild(line(px+CFG.cell-tC/2, py, px+CFG.cell-tC/2, py+CFG.cell/2, col, tC, '1 6'));
        }else if(o===2){
          svg.appendChild(line(px, py+CFG.cell - tC/2, px+CFG.cell/2, py+CFG.cell - tC/2, col, tC, '1 6'));
          svg.appendChild(line(px+CFG.cell - tC/2, py, px+CFG.cell - tC/2, py+CFG.cell/2, col, tC, '1 6'));
        }else{ // o===3
          svg.appendChild(line(px, py+CFG.cell - tC/2, px+CFG.cell/2, py+CFG.cell - tC/2, col, tC, '1 6'));
          svg.appendChild(line(px+tC/2, py, px+tC/2, py+CFG.cell/2, col, tC, '1 6'));
        }
        continue;
      }

      // --- Cenefa lineal simple (apoyada/suspendida) ---
      if(it.kind==='cenefaApo100'){
        svg.appendChild(line(px, py+CFG.cell/2, px+CFG.cell, py+CFG.cell/2, CFG.palette.cenefaApo, thick));
      }else if(it.kind==='cenefaSus100'){
        svg.appendChild(line(px, py+CFG.cell/2, px+CFG.cell, py+CFG.cell/2, CFG.palette.cenefaSus, thick));
      }
    }
  }

  // Dibujo de mobiliario en celdas
  function drawCircleInCell(i,j,relRadius, fill, stroke){
    var pos = cellXY(i,j); var cx = pos.x+CFG.cell/2; var cy = pos.y+CFG.cell/2;
    var r = (CFG.cell/2) * relRadius;
    svg.appendChild(circle(cx,cy,r, fill, stroke, 2));
  }

  function drawCells(){
    for(var k=0;k<S.cells.length;k++){
      var it=S.cells[k]; var i=it.i||0, j=it.j||0; var kind=it.kind;
      if(kind==='banqueta'){
        drawCircleInCell(i,j,0.35,'#0b1220','#64748b');
      }else if(kind==='mesaR30'){
        drawCircleInCell(i,j,0.6,'#0b1220','#6b7280');
      }else if(kind==='mesaR50'){
        drawCircleInCell(i,j,1.0,'#0b1220','#374151');
      }
    }
  }

  function render(){
    clearSVG();
    // cuadricula de referencia
    for(var i=0;i<=S.gridW;i++) svg.appendChild(line(i*CFG.cell,0,i*CFG.cell,S.gridH*CFG.cell,'#172033',1));
    for(var j=0;j<=S.gridH;j++) svg.appendChild(line(0,j*CFG.cell,S.gridW*CFG.cell,j*CFG.cell,'#172033',1));

    drawCenefas();
    drawCells();
  }
  </script>

  <!-- ============== CONTEO & RESUMEN (admin + público) ============== -->
  <script>
  // Cuenta elementos por tipo y calcula totales
  function countsAndCosts(){
    var p = CFG.prices||{};
    var c = { };
    function inc(key,n){ c[key] = (c[key]||0) + (n||1); }

    // conteo cenefas/esquineros
    for(var i=0;i<S.cenefas.length;i++){
      var k = S.cenefas[i].kind; inc(k,1);
    }
    // conteo mobiliario en celdas
    for(var j=0;j<S.cells.length;j++){
      var k2 = S.cells[j].kind; inc(k2,1);
    }

    // armar líneas (label, qty, total)
    var lines = []; function push(label, qty, total){ lines.push({label:label, qty:qty||0, total:total||0}); }

    // ejemplos base
    if(c.tabique1m) push('Tabique 1 m', c.tabique1m, (c.tabique1m*(p.tabique1m||0)));
    if(c.corner50)  push('Esquinero tabique 0.50', c.corner50, (c.corner50*(p.corner50||0)));

    // NUEVOS cenefas esquineros
    if(c.cenefaCornerApo) push('Esquinero cenefa (apoyada)', c.cenefaCornerApo, c.cenefaCornerApo*(p.cenefaCornerApo||0));
    if(c.cenefaCornerSus) push('Esquinero cenefa (suspendida)', c.cenefaCornerSus, c.cenefaCornerSus*(p.cenefaCornerSus||0));

    // NUEVOS mesas
    if(c.mesaR30) push('Mesa ratona Ø30cm', c.mesaR30, c.mesaR30*(p.mesaR30||0));
    if(c.mesaR50) push('Mesa alta Ø50cm', c.mesaR50, c.mesaR50*(p.mesaR50||0));

    // total general (admin)
    var total = 0; for(var t=0;t<lines.length;t++) total += (lines[t].total||0);

    return {counts:c, lines:lines, total:total};
  }

  // Resumen ADMIN (con costos) — versión base
  function renderSummary(){
    var x = countsAndCosts();
    var html = '<div class="kpi"><strong>Concepto</strong><strong>Cant.</strong></div><div class="hr"></div>';
    for(var i=0;i<x.lines.length;i++){
      var L=x.lines[i]; if(!L.qty) continue;
      html += '<div class="kpi"><span>'+L.label+'</span><span>'+L.qty+'</span></div>';
    }
    // ADMIN podría añadir total; en público lo ocultamos vía wrapper
    var el = document.getElementById('summary'); if(el) el.innerHTML = html;
  }

  // Wrapper: si PUBLIC_MODE=true, no muestra costos
  (function(){
    window.renderSummaryPrivate = window.renderSummary;
    window.renderSummary = function(){
      if(!window.PUBLIC_MODE){ return window.renderSummaryPrivate(); }
      var x = countsAndCosts();
      var html = '<div class="kpi"><strong>Concepto</strong><strong>Cant.</strong></div><div class="hr"></div>';
      for(var i=0;i<x.lines.length;i++){
        var L=x.lines[i]; if(!L.qty) continue;
        html += '<div class="kpi"><span>'+L.label+'</span><span>'+L.qty+'</span></div>';
      }
      var el = document.getElementById('summary'); if(el) el.innerHTML = html;
    };
  })();
  </script>

  <!-- =================== EDITOR DE COSTOS =================== -->
  <div id="costsModal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:99">
    <div style="background:#0e1628;border:1px solid #111827;border-radius:14px;padding:14px;min-width:360px;max-width:640px">
      <h3 style="margin:0 0 8px">Editor de costos</h3>
      <div id="costsDyn"></div>
      <div class="hr"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="costsClose" class="btn">Cerrar</button>
        <button id="costsSave" class="btn">Guardar</button>
      </div>
    </div>
  </div>

  <script>
  function buildField(label, key, val){
    return '<div class="row">'
      + '<div>'+label+'</div>'
      + '<div><input type="number" step="1" min="0" data-price-key="'+key+'" value="'+(val||0)+'"></div>'
      + '</div>';
  }

  function renderDynEditor(){
    var host = document.getElementById('costsDyn'); if(!host) return;
    host.innerHTML='';
    function section(title){
      var card = document.createElement('div'); card.className='card';
      var h = document.createElement('div'); h.className='row';
      var s = document.createElement('strong'); s.textContent = title; h.appendChild(s);
      card.appendChild(h); host.appendChild(card); return card;
    }

    // Cenefas
    var cardC = section('CENEFAS');
    (GROUPS.cenefas||[]).forEach(function(it){
      var k=it.key, lbl=it.label; var val = (CFG.prices||{})[k]||0;
      cardC.insertAdjacentHTML('beforeend', buildField(lbl,k,val));
    });

    // Mobiliario
    var cardM = section('MOBILIARIO');
    (GROUPS.mobiliario||[]).forEach(function(it){
      var k=it.key, lbl=it.label; var val = (CFG.prices||{})[k]||0;
      cardM.insertAdjacentHTML('beforeend', buildField(lbl,k,val));
    });

    // listeners
    host.querySelectorAll('input[data-price-key]').forEach(function(inp){
      inp.addEventListener('change', function(){
        var k = this.getAttribute('data-price-key');
        var v = parseFloat(this.value); if(!isFinite(v)) v=0;
        CFG.prices[k]=v; try{ localStorage.setItem('CFG', JSON.stringify(CFG)); }catch(e){}
        renderSummary();
      });
    });
  }

  (function wireCosts(){
    var modal = document.getElementById('costsModal');
    document.getElementById('btnCosts').addEventListener('click', function(){
      modal.style.display='flex'; renderDynEditor();
    });
    document.getElementById('costsClose').addEventListener('click', function(){ modal.style.display='none'; });
    document.getElementById('costsSave').addEventListener('click', function(){ modal.style.display='none'; });
  })();
  </script>

  <!-- ================ INTERACCIÓN DEMO (agregar elementos) ================ -->
  <script>
  // Demo: click en la grilla coloca piezas alternando para poder probar
  svg.addEventListener('click', function(ev){
    var pt = svg.createSVGPoint(); pt.x = ev.clientX; pt.y = ev.clientY;
    var loc = pt.matrixTransform(svg.getScreenCTM().inverse());
    var i = Math.max(0, Math.min(S.gridW-1, Math.floor(loc.x/CFG.cell)));
    var j = Math.max(0, Math.min(S.gridH-1, Math.floor(loc.y/CFG.cell)));

    var modes = ['mesaR30','mesaR50','cenefaCornerApo','cenefaCornerSus'];
    var pick = modes[(S.cells.length + S.cenefas.length) % modes.length];
    if(pick.indexOf('mesa')===0){ S.cells.push({kind:pick, i:i, j:j}); }
    else { S.cenefas.push(setPos({kind:pick}, i, j, (S.cenefas.length%4))); }

    render(); renderSummary();
  });

  // Arranque
  render(); renderSummary();
  </script>

  <!-- ==================== CONTACTO (Email/WhatsApp) ==================== -->
  <div id="contactModal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(17,24,39,.55);z-index:9999">
    <div style="background:#0e1628;border:1px solid #111827;border-radius:14px;padding:16px;min-width:320px;max-width:520px;box-shadow:0 12px 40px rgba(0,0,0,.25)">
      <h3 style="margin:0 0 10px">Solicitar cotización</h3>
      <div style="display:grid;gap:10px">
        <label>Nombre / Empresa
          <input id="c_name" type="text" style="width:100%;padding:8px;border:1px solid #1f2937;border-radius:10px;background:#0b1220;color:#e5e7eb">
        </label>
        <label>Contacto (email o WhatsApp)
          <input id="c_contact" type="text" placeholder="email@dominio.com o 54911..." style="width:100%;padding:8px;border:1px solid #1f2937;border-radius:10px;background:#0b1220;color:#e5e7eb">
        </label>
        <label>Enviar por
          <select id="c_channel" style="width:100%;padding:8px;border:1px solid #1f2937;border-radius:10px;background:#0b1220;color:#e5e7eb">
            <option value="email">Email</option>
            <option value="whatsapp">WhatsApp</option>
          </select>
        </label>
        <label>Mensaje (opcional)
          <textarea id="c_msg" rows="3" style="width:100%;padding:8px;border:1px solid #1f2937;border-radius:10px;background:#0b1220;color:#e5e7eb"></textarea>
        </label>
        <div id="q_info" class="hint" style="min-height:18px;color:#9ca3af"></div>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="c_cancel" class="btn" type="button">Cancelar</button>
          <button id="c_send"   class="btn" type="button">Enviar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  const WHATSAPP_NUMBER = '5491160410607';
  // Si tu proyecto define CONTACT en otro script, se respeta; si no, defaults
  window.CONTACT = window.CONTACT || {
    webhook_url: '',                         // ⬅️ pegá aquí tu URL de Apps Script si querés hardcodear
    to_email:    'dario@dali-arquitectura.com.ar'
  };

  const reEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  const $ = (id)=>document.getElementById(id);
  function setInfo(m){ const el=$('q_info'); if(el) el.textContent=m||''; }

  async function getPreviewJPEG(){
    const svg = document.getElementById('svg'); if(!svg) return '';
    const xml = new XMLSerializer().serializeToString(svg);
    const svg64 = btoa(unescape(encodeURIComponent(xml)));
    const img = new Image(); img.src = 'data:image/svg+xml;base64,' + svg64;
    await new Promise(res=>{ img.onload=res; img.onerror=res; });
    const w = img.naturalWidth || (svg.viewBox&&svg.viewBox.baseVal.width)  || 1600;
    const h = img.naturalHeight|| (svg.viewBox&&svg.viewBox.baseVal.height) || 1200;
    const c = document.createElement('canvas'); c.width=w; c.height=h;
    const ctx = c.getContext('2d'); ctx.fillStyle='#fff'; ctx.fillRect(0,0,w,h);
    try{ ctx.drawImage(img,0,0,w,h); }catch(_){}
    return c.toDataURL('image/jpeg', 0.92);
  }

  async function postWebhook(payload){
    const url = (window.CONTACT&&CONTACT.webhook_url)||''; if(!url) return {ok:false};
    try{
      const r = await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      if(r.ok) return {ok:true,via:'json'};
    }catch(e){}
    try{
      await fetch(url,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(payload),mode:'no-cors'});
      return {ok:true,via:'text/plain-no-cors'};
    }catch(e){}
    try{
      let ifr=$('send_target_iframe'); if(!ifr){ ifr=document.createElement('iframe'); ifr.name=ifr.id='send_target_iframe'; ifr.style.display='none'; document.body.appendChild(ifr); }
      const f=document.createElement('form'); f.action=url; f.method='POST'; f.enctype='text/plain'; f.target='send_target_iframe';
      const t=document.createElement('textarea'); t.name='raw'; t.value=JSON.stringify(payload);
      f.appendChild(t); document.body.appendChild(f); f.submit(); setTimeout(()=>{try{f.remove()}catch{}},600);
      return {ok:true,via:'form-post'};
    }catch(e){}
    return {ok:false};
  }

  async function copyImageToClipboard(jpegDataUrl){
    try{
      if(!jpegDataUrl) return;
      if(navigator.clipboard && window.ClipboardItem){
        const res = await fetch(jpegDataUrl); const blob = await res.blob();
        await navigator.clipboard.write([new ClipboardItem({[blob.type]: blob})]);
        setInfo('Imagen del boceto copiada. Pegala en WhatsApp.');
      }
    }catch(e){}
  }

  async function openWhatsApp(payload){
    const texto = encodeURIComponent(
      `Quiero cotizar este diseño.\n\nNombre/Empresa: ${payload.contact.name}\nContacto: ${payload.contact.contact}\n${payload.contact.msg||''}`
    );
    await copyImageToClipboard(payload.image);
    const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${texto}`;
    window.open(url, '_blank');
  }

  async function sendLeadEmailCopy(payload){
    const copy = {
      meta:{ channel: payload.channel, ts: new Date().toISOString() },
      contact: payload.contact,
      design: payload.design || {},
      image: payload.image || ''
    };
    if(reEmail.test(payload.contact.contact)){
      copy.to_email = (window.CONTACT&&CONTACT.to_email)||'dario@dali-arquitectura.com.ar';
      copy.cc_email = payload.contact.contact;
    }else{
      copy.to_email = (window.CONTACT&&CONTACT.to_email)||'dario@dali-arquitectura.com.ar';
    }
    try{ await postWebhook(copy); }catch(e){}
  }

  function buildPayloadMinimal(){
    try{
      return {
        design:{
          grid:{w:(S&&S.gridW)||0,h:(S&&S.gridH)||0},
          lot:{type:S.lotType, orient:S.lotOrient},
          sides:S.sides, pantallas:S.pantallas,
          items:S.cells, overlays:S.cenefas
        }
      };
    }catch(e){ return {design:{}, image:''}; }
  }

  (function wireContact(){
    var modal = document.getElementById('contactModal');
    document.getElementById('c_cancel').addEventListener('click', function(){ modal.style.display='none'; });
    document.getElementById('c_send').addEventListener('click', async function(){
      var name = (document.getElementById('c_name').value||'').trim();
      var contact = (document.getElementById('c_contact').value||'').trim();
      var channel = (document.getElementById('c_channel').value||'email');
      var msg = (document.getElementById('c_msg').value||'').trim();
      if(!name){ setInfo('Completá tu nombre / empresa'); document.getElementById('c_name').focus(); return; }
      if(!contact){ setInfo('Completá un contacto (email o WhatsApp)'); document.getElementById('c_contact').focus(); return; }

      setInfo('Generando boceto…');
      var image = await getPreviewJPEG();
      var base = buildPayloadMinimal();
      var payload = Object.assign({}, base, { channel, image, contact:{name,contact,msg} });

      if(channel==='email' || reEmail.test(contact)){
        setInfo('Enviando por email…');
        payload.channel='email';
        payload.to_email = (window.CONTACT&&CONTACT.to_email)||'dario@dali-arquitectura.com.ar';
        if(reEmail.test(contact)) payload.cc_email = contact;
        var r = await postWebhook(payload);
        setInfo(r.ok? 'Enviado ✅' : 'No se pudo confirmar el envío');
      }else{
        setInfo('Abriendo WhatsApp…');
        payload.channel='whatsapp';
        await openWhatsApp(payload);
        await sendLeadEmailCopy(payload);
        setInfo('Listo. Te copié el boceto al portapapeles ✅');
      }
      setTimeout(()=>{ modal.style.display='none'; setInfo(''); }, 1200);
    });

    // Botones de la cabecera
    document.getElementById('btnDownloadPNG').addEventListener('click', async function(){
      const data = await getPreviewJPEG();
      if(!data){ alert('No pude generar la imagen del boceto'); return; }
      const a = document.createElement('a'); a.href = data.replace('image/jpeg','image/png'); a.download = 'boceto_dali.png';
      document.body.appendChild(a); a.click(); a.remove();
    });
    document.getElementById('btnQuote').addEventListener('click', function(){ modal.style.display='flex'; setInfo(''); });
  })();
  </script>

</body>
</html>
