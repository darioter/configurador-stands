<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Dal√≠ Configurador SVG ‚Äî Plain v10.2</title>
<style>
  :root{
    --grid:#e6e7ee; --gridMajor:#b7bfd9;
    --wall:#ff00a8; --screen:#2b6cff;
    --sel:#00a7ff; --sel2:#7c3aed; --face:#767676;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f6f7fb;color:#101010}
  .wrap{display:grid;grid-template-columns:400px 1fr;gap:12px;padding:12px;min-height:100vh}
  .card{background:#fff;border:1px solid #e6e7ee;border-radius:14px;box-shadow:0 2px 12px rgba(0,0,0,.05)}
  .left{padding:12px;display:flex;flex-direction:column;gap:10px}
  .right{display:flex;flex-direction:column}
  .title{display:flex;justify-content:space-between;align-items:center;padding:8px 10px}
  .badge{font-size:12px;background:#f0f2f8;border:1px solid #e6e7ee;padding:6px 8px;border-radius:999px}
  h3{margin:6px 0 8px;font-size:12px;text-transform:uppercase;letter-spacing:.08em;color:#444}
  .row{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
  button{padding:8px 10px;border-radius:10px;border:1px solid #e0e2ea;background:#fff;cursor:pointer;font-size:13px}
  button.active{border-color:#111;box-shadow:0 0 0 2px #111 inset}
  label{font-size:13px;color:#333}
  input[type="number"],select{padding:6px 8px;border-radius:8px;border:1px solid #ddd;font-size:13px}
  .hr{height:1px;background:#eee;margin:8px 0}
  .gridwrap{position:relative;margin:10px}
  #svg{background:#fff;border:1px solid #e5e7ee;border-radius:12px;display:block}
  .toolbar{position:absolute;top:10px;right:10px;display:flex;gap:6px}
  .sum{padding:10px;font-size:14px}
  .kpi{display:grid;grid-template-columns:1fr auto auto;gap:6px;align-items:center}
  .faceLabel{font-size:16px;font-weight:600;opacity:.5}
  .section{padding:8px 10px}
  .hint{font-size:12px;color:#666}
  .groupbar{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px}
  .toolgrid{display:grid;grid-template-columns:1fr;gap:6px}
  .toolgrid button{width:100%;justify-content:flex-start}
</style>
<style>
.ui-controls-grid{display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;margin:.5rem 0 .75rem}
.ui-controls-grid button{padding:.5rem .75rem;border-radius:.6rem;border:1px solid rgba(0,0,0,.12);background:#fff;line-height:1;white-space:nowrap}
.ui-controls-grid .btn--arrow{min-width:2.35rem;text-align:center;padding:.48rem 0}
.ui-controls-meta{margin-top:.25rem;font:500 12px/1.35 system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;opacity:.8}
#gw,#gh{display:none!important}
</style>
<style>
/* === 3-column layout enhancement === */
:root{
  --left-w: 320px;
  --right-w: 360px;
  --gap: 16px;
  --pane-pad: 12px;
  --pane-radius: 14px;
  --pane-shadow: 0 6px 18px rgba(0,0,0,.06);
}
.app-3col{
  display: grid;
  grid-template-columns: var(--left-w) 1fr var(--right-w);
  grid-template-rows: auto 1fr;
  grid-template-areas: "topbar topbar topbar" "left center right";
  gap: var(--gap);
  height: 100vh;
  padding: 12px;
  box-sizing: border-box;
}
.app-topbar{
  grid-area: topbar;
  display:flex; align-items:center; gap:8px;
  padding:8px 10px; border:1px solid #eee; border-radius:12px;
  background:#fff; box-shadow: var(--pane-shadow);
  position: sticky; top:8px; z-index: 5;
}
.app-left{ grid-area: left; }
.app-center{ grid-area: center; min-width:0; }
.app-right{ grid-area: right; }

.pane{
  background:#fff; border:1px solid #eee; border-radius: var(--pane-radius);
  padding: var(--pane-pad); box-shadow: var(--pane-shadow);
  height: calc(100vh - 88px);
  overflow:auto;
}
.pane h3{ margin: 8px 0 10px; font-size: 14px; opacity:.8; }

.canvas-wrap{
  background:#fafafa; border:1px dashed #ddd; border-radius: var(--pane-radius);
  height: calc(100vh - 88px);
  overflow: auto;
  display: grid;
  place-items: center;
}
.btn{
  display:inline-flex; align-items:center; gap:8px;
  padding:8px 12px; border-radius:10px; border:1px solid #e5e7eb;
  background:#fff; cursor:pointer; user-select:none;
}
.btn:hover{ background:#f8f9fa; }
.spacer{ flex:1; }

@media (max-width: 1280px){
  :root{ --left-w: 280px; --right-w: 320px; }
}
@media (max-width: 1024px){
  .app-3col{ grid-template-columns: 1fr; grid-template-areas: "topbar" "center"; }
  .app-left, .app-right{ display:none; }
  .app-3col.compact-off .app-left, .app-3col.compact-off .app-right{ display:block; }
  .app-3col.compact-off{
    grid-template-columns: var(--left-w) 1fr var(--right-w);
    grid-template-areas: "topbar topbar topbar" "left center right";
  }
}
</style>
<script>(function(){try{window.CFG=window.CFG||{};window.CFG.prices=window.CFG.prices||{};
if(typeof window.CFG.prices.medianeraPerM!=='number'){window.CFG.prices.medianeraPerM=45;}}catch(e){}})();</script>
<script>(function(){
  try{
    window.CFG=window.CFG||{}; window.CFG.prices=window.CFG.prices||{};
    if(typeof window.CFG.prices.pantallaMedianeraPerM!=='number'){ window.CFG.prices.pantallaMedianeraPerM=110; }
  }catch(e){}
})();</script>



<style>
#unlockCosts{ cursor:pointer; }
#costPanel input{ pointer-events:auto; background:#fff; }
</style>

<style>
#unlockCosts{ cursor:pointer; }
#unlockRow input, #costPanel input{ pointer-events:auto; background:#fff; position:relative; z-index:5; }
#costPanel{ position:relative; z-index:4; }
.topbar, .app-topbar{ position:relative; z-index:3; }
</style>

<style>
/* Elevate summary controls to avoid overlays blocking clicks */
#summary, #summary * {
  pointer-events: auto !important;
  position: relative;
  z-index: 50;
}
#unlockCosts, #unlockRow, #costPanel { pointer-events: auto !important; }
</style>

<style>
/* Ocultar bot√≥n superior "Editar precios" si existe */
#editPrices, .btn-edit-prices { display:none !important; }
.app-topbar .btn:has(> span), .app-topbar .btn { }
</style>
<script>
(function(){
  // Intento adicional: ocultar por texto "Editar precios"
  try{
    var btns = Array.from(document.querySelectorAll('.app-topbar .btn, .app-topbar button'));
    btns.forEach(function(b){
      var t = (b.textContent||'').trim().toLowerCase();
      if(t.indexOf('editar precios')>=0){ b.style.display='none'; b.id='editPrices'; }
    });
  }catch(_){}
})();
</script>

<style>
/* FIX14 modal scroll */
#costsModal .card{ border:1px solid #eee; border-radius:12px; }
#costsDyn{ max-height:60vh; overflow:auto; padding-right:6px; }
#costsModal input[type="number"]{ width:120px; }
</style>

<style>
/* === Top bar input visibility fix === */
header, .topbar, #topbar, .toolbar, .controls { overflow: visible !important; }
header input, .topbar input, #topbar input, .toolbar input, .controls input {
  min-width: 120px !important;
  max-width: 160px;
}
header .row, .topbar .row, #topbar .row, .toolbar .row, .controls .row {
  gap: 10px;
  flex-wrap: wrap; /* allow wrapping instead of clipping */
}
/* Keep chips/buttons from crowding inputs */
header .chip, .topbar .chip, #topbar .chip, .toolbar .chip {
  margin-right: 6px;
}
</style>


<style id="dali-buttons-css">
/* Base font */
:root{ --fs: clamp(13px,1.55vw,15px); }
body{ font-size: var(--fs); font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif; }

/* 1) CHIP / TAB buttons (small pill) */
.sidebar .chipbar button,
.sidebar .toolbar button,
.sidebar .tabs button,
.sidebar .filters button,
.sidebar .control-row button,
.sidebar .selection-controls button {
  border-radius: 999px;
  padding: .42em .9em;
  line-height: 1.1;
  border: 1px solid rgba(0,0,0,.18);
  background: #fff;
  box-shadow: 0 1px 2px rgba(0,0,0,.06);
  white-space: nowrap;
  font-weight: 600;
}
/* Group layout centered with wrap */
.sidebar .chipbar, .sidebar .toolbar, .sidebar .tabs, .sidebar .filters,
.sidebar .control-row, .sidebar .selection-controls {
  display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;
  margin: 6px 0 12px;
}

/* 2) ELEMENT buttons (full width rounded) */
.sidebar .element-list button,
.sidebar .elements button,
.sidebar .stack button,
.sidebar .catalog button {
  width: 100%;
  padding: .62em 1em;
  border-radius: 14px;
  border: 1px solid rgba(0,0,0,.12);
  background: #fff;
  text-align: center;
  box-shadow: 0 1px 2px rgba(0,0,0,.05);
  font-weight: 600;
}

/* 3) PACKS qty bubble small and aligned */
.packs-section .qty-row{
  display:flex; align-items:center; gap:10px; margin:8px 0;
}
.packs-section .qty-row label{ flex:1 1 auto; margin:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.packs-section .qty-row input{
  width: 72px; max-width:72px; min-width:72px;
  text-align:center; padding: .42em .5em; border-radius: 12px;
  border: 1px solid rgba(0,0,0,.16); background:#fff;
}

/* Tighten inputs to match aesthetic */
.sidebar input, .sidebar select { border-radius: 12px; padding: .5em .65em; border: 1px solid rgba(0,0,0,.16); }
.sidebar h2, .sidebar h3 { text-transform: uppercase; color:#666; letter-spacing:.04em; font-weight:800; margin:18px 0 10px; }
</style>

<style id="sidebar-packs-stack-css">
  /* --- SOLO BARRA IZQUIERDA: normaliza PACKS a 't√≠tulo arriba / globito abajo' --- */
  .left.card .packs--field{ display:flex; flex-direction:column; gap:6px; margin:8px 0 12px; }
  .left.card .packs--label{ font-size:13px; color:#333; line-height:1.1; }
  .left.card .packs--input{ width:100%; max-width:100%; box-sizing:border-box; }
  /* Evitar que contenedores empujen y provoquen saltos */
  .left.card .packs--field, .left.card .packs--field *{ min-width:0; }
</style>


<style id="packs-aesthetic-detail">
  /* Est√©tica solicitada para PACKS:
     T√≠tulo (arriba), l√≠nea fina, globo entre par√©ntesis */
  .left.card .packs--field{ display:flex; flex-direction:column; gap:6px; margin:8px 0 12px; }
  .left.card .packs--label{ font-size:13px; color:#333; line-height:1.1; font-weight:600; }
  .left.card .packs--divider{ height:1px; background:#e5e7eb; }
  .left.card .pack-wrap{ position:relative; display:flex; align-items:center; justify-content:flex-start; }
  .left.card .pack-wrap::before{ content:"("; margin-right:6px; color:#9ca3af; }
  .left.card .pack-wrap::after{ content:")"; margin-left:6px; color:#9ca3af; }
  .left.card .pack-wrap input[type="number"]{
    width:72px; min-width:72px; max-width:72px;
    text-align:center;
  }
</style>


<style id="public-mode-css">
  /* Modo p√∫blico: ocultar costos y totales visibles */
  #summary .kpi > :nth-child(3),
  #summary .kpi:last-child,
  #unlockCosts, #unlockRow, #costPanel,
  .btn-edit-prices, #editPrices {
    display: none !important;
  }
  #summary::before{
    content: "Versi√≥n p√∫blica ‚Äî precios ocultos. Envi√° tu dise√±o para cotizar.";
    display:block; margin:6px 0 8px; padding:8px 10px;
    background:#f8fafc; border:1px solid #e5e7eb; border-radius:10px;
    font: 600 12px/1.35 system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    color:#374151;
  }
  /* Botonera p√∫blica por si no existe topbar */
  .public-controls{
    display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    padding:8px; border:1px solid #e5e7eb; border-radius:10px; background:#fff; margin:8px 0;
  }
  .public-controls .btn, .btn{
    padding:8px 12px; border:1px solid #d1d5db; border-radius:10px; background:#fff; cursor:pointer;
    font:600 12px system-ui;
  }
</style>


<script>
// === Env√≠o: configuraci√≥n ===
window.CONTACT = {
  webhook_url: "https://script.google.com/macros/s/AKfycbyY-3lPwi9lZ_JhU8LvQbQrvDd4mFDcp1XcvC3MOA5hy-jHzxV9R13LuZZ0LkakN0h21g/exec",
  emailjs: { service_id: "", template_id: "", public_key: "" }, // opcional
  to_email: "dario@dali-arquitectura.com.ar"
};
</script>

</head>
<body>
<div class="app-3col" id="layout3">
<div class="app-topbar">

<!-- Controles p√∫blicos -->
<button class="btn" id="btnDownloadPNG">Descargar PNG</button>
<button class="btn" id="btnQuote">Solicitar cotizaci√≥n</button>

<strong>DAL√ç Configurador</strong>
<span class="spacer"></span>
<button class="btn" id="toggleCompact" title="Mostrar/Ocultar sidebars en pantallas chicas">üß© Compactar</button>
</div>
<aside class="app-left"><div class="pane"><div id="leftMount"></div></div></aside>
<main class="app-center"><div class="canvas-wrap"><div id="canvasMount"></div></div></main>
<aside class="app-right"><div class="pane"><div id="rightMountTop"></div><hr style="margin:10px 0; border:none; border-top:1px solid #eee;"/><div id="rightMountBottom"></div></div></aside>
</div>
<div id="legacyApp" style="display:none">
<div class="wrap">
<div class="left card">
<div class="title"><strong>Configurador Dal√≠ (Plain SVG)</strong><span class="badge">Celda 0,5 m</span></div>
<!-- 1) LOTE -->
<div class="section">
<h3>Tipo de lote (idioma stand)</h3>
<div class="row">
<label>Tipo
          <select id="lotType">
<option value="isla">Isla (4 frentes)</option>
<option value="peninsula">Pen√≠nsula (3 frentes)</option>
<option value="punta">Punta de isla (2 frentes)</option>
<option value="medianeras">Entre medianeras (1 frente)</option>
</select>
</label>
<label id="lotOrientWrap" style="display:none">Orientaci√≥n
          <select id="lotOrient"></select>
</label>
</div>
<div class="row hint">Caras: A (arriba), B (derecha), C (abajo), D (izquierda)</div>
</div>
<div class="section">
<h3>Grilla</h3>
<div class="row">
<label>W (celdas 0.5 m) <input id="gw" max="60" min="2" type="number"/></label>
<label>H (celdas 0.5 m) <input id="gh" max="60" min="2" type="number"/></label>
<button id="resize">Redimensionar</button>
</div>
<div class="section">
<h3>Per√≠metro</h3>
<div class="row" id="sides">
<label><input data-side="A" type="checkbox"/> A</label>
<label><input data-side="A-pantalla" type="checkbox"/> Pantalla</label>
<label><input data-side="B" type="checkbox"/> B</label>
<label><input data-side="B-pantalla" type="checkbox"/> Pantalla</label>
<label><input data-side="C" type="checkbox"/> C</label>
<label><input data-side="C-pantalla" type="checkbox"/> Pantalla</label>
<label><input data-side="D" type="checkbox"/> D</label>
<label><input data-side="D-pantalla" type="checkbox"/> Pantalla</label>
</div>
</div>
<!-- 2) TARIMA + GR√ÅFICA -->
<div class="section">
<h3>Tarima y gr√°fica</h3>
<div class="row">
<label>Tipo de tarima
          <select id="floor">
<option value="carpet">Alfombra</option>
<option value="lowAggCarpet">Tarima baja + alfombra</option>
<option value="lowMelamine">Melamina baja</option>
<option value="highModular">Tarima modular alta</option>
</select>
</label>
</div>
<div class="row">
<label>Vinilo mate (m¬≤) <input id="gfxVinilo" min="0" type="number" value="0"/></label>
<label>Lona mate (m¬≤) <input id="gfxLona" min="0" type="number" value="0"/></label>
<label>Esmerilado (m¬≤) <input id="gfxEsmerilado" min="0" type="number" value="0"/></label>
</div>
<div class="hint">El costo de tarima se calcula por m¬≤ del stand. Las gr√°ficas suman por m¬≤ ingresado.</div>
</div>
<!-- Packs -->
<div class="section">
<h3>Packs</h3>
<div class="row">
<label>Light Pack <input id="lightPack" min="0" type="number" value="0"/></label>
<label>RA Pack <input id="raPack" min="0" type="number" value="0"/></label>
<label>Audio Pack <input id="audioPack" min="0" type="number" value="0"/></label>
</div>
</div>
<!-- 3) ELEMENTOS + CONTROLES -->
<div class="section">
<h3>Herramientas (elementos)</h3>
<div class="groupbar">
<button class="group active" data-group="tabiques">Tabiques</button>
<button class="group" data-group="tecnologia">Tecnolog√≠a</button>
<button class="group" data-group="mobiliario">Mobiliario</button>
<button class="group" data-group="torres">Torres</button>
<button class="group" data-group="cenefas">Cenefas</button>
<button id="selectTool">Seleccionar</button>
<button id="erase">Borrar</button>
<button id="reset">Limpiar todo</button>
</div>
<div class="toolgrid" id="tools"></div>
<div class="hint">Cenefas (apoyadas/suspendidas) se colocan <b>aunque la celda est√© ocupada</b> (overlay a√©reo).</div>
</div>
<div class="section">
<h3>Controles de selecci√≥n</h3>
<div class="row">
<button id="selRotate">Rotar 90¬∞</button>
<button id="selMirrorH">Espejar H</button>
<button id="selMirrorV">Espejar V</button>
</div>
<div class="row">
<button id="posTop">‚Üë</button>
<button id="posLeft">‚Üê</button>
<button id="posCenter">Centrar</button>
<button id="posRight">‚Üí</button>
<button id="posBottom">‚Üì</button>
</div>
<div class="hint" id="selInfo">Sin selecci√≥n</div>
</div>
<div class="row hint">L√≠neas <b>gruesas</b> cada 1 m (2 celdas). Numeraci√≥n en metros.</div>
</div>
<div class="section">
<h3>Datos</h3>
<div class="row">
<button id="export">Exportar JSON</button>
<button id="import">Importar JSON</button>
</div>
</div>
</div>
<div class="right">
<div class="card">
<div class="gridwrap">
<div class="toolbar"><span class="badge" id="toolLabel">Seleccionar</span></div>
<svg id="svg"></svg>
</div>
</div>
<div class="card" style="margin:8px 10px 12px">
<div class="sum" id="summary">
<div class="row" style="margin:8px 0">
  <button id="unlockCosts" class="btn">üîí Costos</button>
</div>
<div id="unlockRow" class="row" style="display:none; gap:8px; align-items:center; margin:6px 0">
  <input id="unlockPass" type="password" placeholder="Clave costos" style="width:140px"/>
  <button id="unlockGo" class="btn">Desbloquear</button>
</div>

<div id="costPanel" class="card" style="display:none; padding:8px; margin-bottom:8px">
  <div class="row"><strong>Editor de costos</strong></div>
  <div class="row" style="margin-top:6px">
    <label>Precio medianera ($/m)
      <input id="medianeraPrice2" type="number" inputmode="decimal" autocomplete="off" min="0" step="1" style="width:110px"/>
    </label>
  </div>
  <div class="row"><small>Se multiplica por la suma (m) de medianeras fucsias.</small></div>
</div>
</div>
</div>
</div>
</div>
<script>
(function(){
  'use strict';
  var CFG = {
    gridW: 12, gridH: 12,
    cell: 48, pad: 40,
    prices:{ panel100:90, panel50:55, corner50:40, puerta:180, vidrio:150, columna50:80, columna40c:70,
      cenefaApo100:70, cenefaApo50:40, cenefaSus100:90, cenefaSus50:55,
      torre:250, torre3:250, torre35:250, torre4:250, torre45:250, torre5:250, torre55:250, torre6:250, led:400, counter:180, counter50:120, banqueta:60,
      sofa2:220, sofa1:140, p48:320, p55:360, p65:420,
      pantalla:400,
      graphics:{ vinilo:30, lona:30, esmerilado:30 },
      floor:{ carpet:18, lowMelamine:40, lowAggCarpet:38, highModular:65 },
      lightPack:250, raPack:180, audioPack:120
    },
    colors:{ grid:'#e6e7ee', gridMajor:'#b7bfd9', wall:'#ff00a8', screen:'#2b6cff', selection:'#00a7ff', selectionOverlay:'#7c3aed', face:'#767676' },
    palette:{
      panel100:'#1f2937', panel50:'#374151', corner50:'#4b5563', puerta:'#eab308', vidrio:'#27a6ee',
      columna50:'#334155', columna40c:'#64748b', cenefaApo:'#0d9488', cenefaSus:'#7c3aed',
      torre:'#2563eb', led:'#0ea5e9', counter:'#16a34a', counter50:'#22c55e', banqueta:'#a855f7',
      sofa2:'#f97316', sofa1:'#fb923c', p48:'#ef4444', p55:'#10b981', p65:'#3b82f6'
    }
  };
window.CFG = CFG;

  var GROUPS = {
    "tabiques":[
      {key:'panel100',label:'Panel 1.00 m (2 celdas)'},
      {key:'panel50',label:'Panel 0.50 m (1 celda)'},
      {key:'corner50',label:'Esquinero 0.50√ó0.50'},
      {key:'puerta',label:'Puerta (1.00 m)'},
      {key:'vidrio',label:'Vidrio 1.00 m'},
      {key:'columna50',label:'Columna 0.50√ó0.50 (1√ó1)'},
      {key:'columna40c',label:'Columna √ò0.40 (en 1√ó1)'}
    ],
    "tecnologia":[
      {key:'led',label:'LED Wall (0.50√ó0.50)'},
      {key:'p48',label:'Pantalla 48" (1.00√ó0.20)'},
      {key:'p55',label:'Pantalla 55" (1.20√ó0.20)'},
      {key:'p65',label:'Pantalla 65" (1.40√ó0.20)'}
    ],
    "mobiliario":[
      {key:'counter',label:'Mostrador 1.00 (2√ó1)'},
      {key:'counter50',label:'Mostrador 0.50 (1√ó1)'},
      {key:'banqueta',label:'Banqueta (0.4√ó0.4)'},
      {key:'sofa2',label:'Sill√≥n 2 cuerpos (2√ó1)'},
      {key:'sofa1',label:'Sill√≥n 1 cuerpo (1√ó1)'}
    ],
    "torres":[{key:'torre',label:'Torre (1√ó0.5 = 2√ó1)'},
      {key:'torre3',label:'Torre 3.0 m (1√ó0.5 = 2√ó1)'},
      {key:'torre35',label:'Torre 3.5 m (1√ó0.5 = 2√ó1)'},
      {key:'torre4',label:'Torre 4.0 m (1√ó0.5 = 2√ó1)'},
      {key:'torre45',label:'Torre 4.5 m (1√ó0.5 = 2√ó1)'},
      {key:'torre5',label:'Torre 5.0 m (1√ó0.5 = 2√ó1)'},
      {key:'torre55',label:'Torre 5.5 m (1√ó0.5 = 2√ó1)'},
      {key:'torre6',label:'Torre 6.0 m (1√ó0.5 = 2√ó1)'}
    ],
    "cenefas":[
      {key:'cenefaApo100',label:'Cenefa apoyada 1.00 m'},
      {key:'cenefaApo50',label:'Cenefa apoyada 0.50 m'},
      {key:'cenefaSus100',label:'Cenefa suspendida 1.00 m'},
      {key:'cenefaSus50',label:'Cenefa suspendida 0.50 m'}
    ]
  };
  var ALL_ITEMS=[]; Object.keys(GROUPS).forEach(function(g){ GROUPS[g].forEach(function(it){ ALL_ITEMS.push(it); }); });
  var ALL_KEYS = ALL_ITEMS.map(function(i){return i.key;});
  var CENEFA_KEYS=['cenefaApo100','cenefaApo50','cenefaSus100','cenefaSus50'];

  var S = {
    gridW: CFG.gridW, gridH: CFG.gridH,
    tool:'select', group:'tabiques',
    cells:{}, cenefas:[],
    sides:{A:false,B:false,C:false,D:false},
    pantallas:{A:false,B:false,C:false,D:false},
    floor:'carpet',
    gfxVinilo:0, gfxLona:0, gfxEsmerilado:0,
    lightPack:0, raPack:0, audioPack:0,
    selectedKey:null, selectedOverlayIdx:null,
    lotType:'isla', lotOrient:null
  };

  var svg = document.getElementById('svg');
  var toolLabel = document.getElementById('toolLabel');

  function renderGroupButtons(){
    var groupBtns = document.querySelectorAll('.group');
    for(var i=0;i<groupBtns.length;i++){
      groupBtns[i].addEventListener('click', (function(btn){
        return function(){
          for(var j=0;j<groupBtns.length;j++) groupBtns[j].classList.remove('active');
          btn.classList.add('active');
          S.group = btn.getAttribute('data-group');
          renderToolButtons();
        };
      })(groupBtns[i]));
    }
  }
  function renderToolButtons(){
    var ctr=document.getElementById('tools'); ctr.innerHTML='';
    var items = GROUPS[S.group];
    for(var i=0;i<items.length;i++){
      (function(it){
        var b=document.createElement('button');
        b.textContent = it.label; b.setAttribute('data-tool', it.key);
        if(S.tool===it.key) b.classList.add('active');
        b.addEventListener('click', function(){
          var bs = ctr.querySelectorAll('button');
          for(var k=0;k<bs.length;k++) bs[k].classList.remove('active');
          b.classList.add('active'); S.tool=it.key; syncToolLabel();
        });
        ctr.appendChild(b);
      })(items[i]);
    }
  }
  function syncToolLabel(){
    var it=null; for(var i=0;i<ALL_ITEMS.length;i++){ if(ALL_ITEMS[i].key===S.tool){ it=ALL_ITEMS[i]; break; } }
    toolLabel.textContent = it? it.label : (S.tool==='erase'?'Borrar':'Seleccionar');
  }

  // Lote
  function refreshLotOrientationUI(){
    var wrap=document.getElementById('lotOrientWrap');
    var sel=document.getElementById('lotOrient');
    sel.innerHTML='';
    if(S.lotType==='punta'){
      wrap.style.display='inline-block';
      ['AB','BC','CD','DA'].forEach(function(o){
        var op=document.createElement('option'); op.value=o; op.textContent='Frentes '+o[0]+' + '+o[1]; sel.appendChild(op);
      });
      S.lotOrient=S.lotOrient||'AB';
    }else if(S.lotType==='peninsula' || S.lotType==='medianeras'){
      wrap.style.display='inline-block';
      ['A','B','C','D'].forEach(function(o){
        var op=document.createElement('option'); op.value=o;
        op.textContent = (S.lotType==='peninsula')? ('Medianera en '+o) : ('Frente en '+o);
        sel.appendChild(op);
      });
      S.lotOrient=S.lotOrient||'A';
    }else{ wrap.style.display='none'; S.lotOrient=null; }
    if(S.lotOrient) sel.value=S.lotOrient;
    applyLotPreset();
  }
  function applyLotPreset(){
    var Sides={A:false,B:false,C:false,D:false};
    if(S.lotType==='peninsula'){ Sides[S.lotOrient||'A']=true; }
    else if(S.lotType==='punta'){ var o=(S.lotOrient||'AB').split(''); ['A','B','C','D'].forEach(function(k){ Sides[k] = o.indexOf(k)>=0; }); }else if(S.lotType==='medianeras'){
      var f=S.lotOrient||'A'; ['A','B','C','D'].forEach(function(k){ if(k!==f) Sides[k]=true; });
    }
    S.sides=Sides;
    ['A','B','C','D'].forEach(function(k){
      var el = document.querySelector('input[data-side="'+k+'"]'); if(el) el.checked=!!Sides[k];
    });
  }

  // SVG helpers
  function resizeSVG(){
    var w = S.gridW*CFG.cell + CFG.pad*2;
    var h = S.gridH*CFG.cell + CFG.pad*2;
    svg.setAttribute('viewBox','0 0 '+w+' '+h);
    svg.setAttribute('width', w); svg.setAttribute('height', h);
  }
  
  function updateGridMeters(){
    var mW = (S.gridW/2);
    var mH = (S.gridH/2);
    // formateo: quitar .0 si es entero
    function fmt(n){ return (Math.abs(n - Math.round(n)) < 1e-9) ? String(Math.round(n)) : String(n); }
    var el = document.getElementById('gridMeters');
    if(el){ el.textContent = 'Medida: ' + fmt(mW) + ' √ó ' + fmt(mH) + ' m'; }
  }

  function clearSVG(){ while(svg.firstChild) svg.removeChild(svg.firstChild); }
  function defs(){
    var d = document.createElementNS('http://www.w3.org/2000/svg','defs');
    var hatch = document.createElementNS(d.namespaceURI,'pattern');
    hatch.setAttribute('id','hatch'); hatch.setAttribute('patternUnits','userSpaceOnUse');
    hatch.setAttribute('width','6'); hatch.setAttribute('height','6');
    var p1 = document.createElementNS(d.namespaceURI,'path');
    p1.setAttribute('d','M-2,2 l4,-4 M0,6 l6,-6 M4,10 l6,-6');
    p1.setAttribute('stroke', CFG.palette.vidrio); p1.setAttribute('stroke-width','1'); hatch.appendChild(p1); d.appendChild(hatch);
    var led = document.createElementNS(d.namespaceURI,'pattern');
    led.setAttribute('id','leddots'); led.setAttribute('patternUnits','userSpaceOnUse');
    led.setAttribute('width','6'); led.setAttribute('height','6');
    var c = document.createElementNS(d.namespaceURI,'circle');
    c.setAttribute('cx','1.5'); c.setAttribute('cy','1.5'); c.setAttribute('r','1'); c.setAttribute('fill','#111');
    led.appendChild(c); d.appendChild(led);
    return d;
  }
  function drawGrid(){
    var gMinor = document.createElementNS(svg.namespaceURI,'g');
    gMinor.setAttribute('stroke', CFG.colors.grid); gMinor.setAttribute('stroke-width','1'); gMinor.setAttribute('stroke-dasharray','4 6');
    for(var x=0;x<=S.gridW;x++){
      var l = document.createElementNS(svg.namespaceURI,'line');
      l.setAttribute('x1', CFG.pad + x*CFG.cell); l.setAttribute('y1', CFG.pad);
      l.setAttribute('x2', CFG.pad + x*CFG.cell); l.setAttribute('y2', CFG.pad + S.gridH*CFG.cell); gMinor.appendChild(l);
    }
    for(var y=0;y<=S.gridH;y++){
      var l2 = document.createElementNS(svg.namespaceURI,'line');
      l2.setAttribute('x1', CFG.pad); l2.setAttribute('y1', CFG.pad + y*CFG.cell);
      l2.setAttribute('x2', CFG.pad + S.gridW*CFG.cell); l2.setAttribute('y2', CFG.pad + y*CFG.cell); gMinor.appendChild(l2);
    }
    svg.appendChild(gMinor);
    var gMajor = document.createElementNS(svg.namespaceURI,'g');
    gMajor.setAttribute('stroke', CFG.colors.gridMajor); gMajor.setAttribute('stroke-width','2');
    for(var x2=0;x2<=S.gridW;x2+=2){
      var l3 = document.createElementNS(svg.namespaceURI,'line');
      l3.setAttribute('x1', CFG.pad + x2*CFG.cell); l3.setAttribute('y1', CFG.pad);
      l3.setAttribute('x2', CFG.pad + x2*CFG.cell); l3.setAttribute('y2', CFG.pad + S.gridH*CFG.cell); gMajor.appendChild(l3);
    }
    for(var y2=0;y<=S.gridH;y+=2){
      var l4 = document.createElementNS(svg.namespaceURI,'line');
      l4.setAttribute('x1', CFG.pad); l4.setAttribute('y1', CFG.pad + y2*CFG.cell);
      l4.setAttribute('x2', CFG.pad + S.gridW*CFG.cell); l4.setAttribute('y2', CFG.pad + y2*CFG.cell); gMajor.appendChild(l4);
    }
    svg.appendChild(gMajor);
    var gLab=document.createElementNS(svg.namespaceURI,'g');
    for(var ix=0;ix<S.gridW/2;ix++){
      var t=document.createElementNS(svg.namespaceURI,'text');
      t.textContent=String(ix+1);
      t.setAttribute('x', CFG.pad + (ix*2+1)*CFG.cell); t.setAttribute('y', CFG.pad - 12);
      t.setAttribute('font-size','12'); t.setAttribute('fill','#727a96'); t.setAttribute('text-anchor','middle');
      gLab.appendChild(t);
    }
    for(var iy=0;iy<S.gridH/2;iy++){
      var t2=document.createElementNS(svg.namespaceURI,'text');
      t2.textContent=String(iy+1);
      t2.setAttribute('x', CFG.pad - 12); t2.setAttribute('y', CFG.pad + (iy*2+1)*CFG.cell + 4);
      t2.setAttribute('font-size','12'); t2.setAttribute('fill','#727a96'); t2.setAttribute('text-anchor','end');
      gLab.appendChild(t2);
    }
    svg.appendChild(gLab);
  }
  function drawPerimeter(){
    var W=S.gridW*CFG.cell, H=S.gridH*CFG.cell;
    var edges = { A:[CFG.pad,CFG.pad,CFG.pad+W,CFG.pad], B:[CFG.pad+W,CFG.pad,CFG.pad+W,CFG.pad+H], C:[CFG.pad+W,CFG.pad+H,CFG.pad,CFG.pad+H], D:[CFG.pad,CFG.pad+H,CFG.pad,CFG.pad] };
    var gWall = document.createElementNS(svg.namespaceURI,'g');
    gWall.setAttribute('stroke', CFG.colors.wall); gWall.setAttribute('stroke-width','5'); gWall.setAttribute('stroke-linecap','square');
    ['A','B','C','D'].forEach(function(k){
      if(S.sides[k]){
        var ln=document.createElementNS(svg.namespaceURI,'line');
        var e=edges[k]; ln.setAttribute('x1',e[0]); ln.setAttribute('y1',e[1]); ln.setAttribute('x2',e[2]); ln.setAttribute('y2',e[3]); gWall.appendChild(ln);
      }
    });
    svg.appendChild(gWall);
    var gScr=document.createElementNS(svg.namespaceURI,'g');
    gScr.setAttribute('stroke', CFG.colors.screen); gScr.setAttribute('stroke-width','3'); gScr.setAttribute('stroke-linecap','square'); gScr.setAttribute('stroke-dasharray','10 8');
    ['A','B','C','D'].forEach(function(k){
      if(S.sides[k] && S.pantallas[k]){
        var ln=document.createElementNS(svg.namespaceURI,'line');
        var e=edges[k]; ln.setAttribute('x1',e[0]); ln.setAttribute('y1',e[1]); ln.setAttribute('x2',e[2]); ln.setAttribute('y2',e[3]); gScr.appendChild(ln);
      }
    });
    svg.appendChild(gScr);
    var labels={A:[(edges.A[0]+edges.A[2])/2,edges.A[1]-14], B:[edges.B[0]+14,(edges.B[1]+edges.B[3])/2], C:[(edges.C[0]+edges.C[2])/2,edges.C[1]+20], D:[edges.D[0]-14,(edges.D[1]+edges.D[3])/2]};
    ['A','B','C','D'].forEach(function(k){
      var t=document.createElementNS(svg.namespaceURI,'text');
      t.textContent=k; t.setAttribute('x', labels[k][0]); t.setAttribute('y', labels[k][1]);
      t.setAttribute('fill', CFG.colors.face); t.setAttribute('class','faceLabel');
      t.setAttribute('text-anchor', (k==='A'||k==='C')?'middle': (k==='B'?'start':'end')); svg.appendChild(t);
    });
  }

  // Geometry helpers
  function dims(kind, o){
    var H=(o===1||o===3);
    if(kind==='torre'||kind==='counter'||kind==='sofa2') return {w:H?2:1, h:H?1:2};
    if(kind==='counter50'||kind==='sofa1'||kind==='led'||kind==='corner50'||kind==='banqueta'||kind==='columna50'||kind==='columna40c') return {w:1,h:1};
    if(kind==='p48') return H?{w:2.0,h:0.4}:{w:0.4,h:2.0};
    if(kind==='p55') return H?{w:2.5,h:0.4}:{w:0.4,h:2.5};
    if(kind==='p65') return H?{w:2.8,h:0.4}:{w:0.4,h:2.8};
    if(kind==='panel50') return {w:H?1:0, h:H?0:1};
    if(kind==='panel100'||kind==='vidrio'||kind==='puerta') return {w:H?2:0, h:H?0:2};
    if(kind==='cenefaApo50'||kind==='cenefaSus50') return {w:H?1:0, h:H?0:1};
    if(kind==='cenefaApo100'||kind==='cenefaSus100') return {w:H?2:0, h:H?0:2};
    return null;
  }
  function snapPos(kind,o,posX,posY){
    var d=dims(kind,o), x=posX||'center', y=posY||'center'; if(!d) return {x:x,y:y};
    if(d.w>1) x='left'; else if(d.w===1 && ['left','center','right'].indexOf(x)<0) x='center';
    if(d.h>1) y='top';  else if(d.h===1 && ['top','center','bottom'].indexOf(y)<0) y='center';
    return {x:x,y:y};
  }

  function drawBoxRect(g, gx,gy, wC,hC, posX,posY, fill, stroke, label){
    var px=gx*CFG.cell, py=gy*CFG.cell;
    var w=Math.floor(wC*CFG.cell), h=Math.floor(hC*CFG.cell);
    var tx=px, ty=py;
    if(wC<=1){ tx = px + (posX==='left'?2: posX==='right'?(CFG.cell - w - 2):(CFG.cell - w)/2); } else { if(px + w > S.gridW*CFG.cell) tx = px - (w - CFG.cell); }
    if(hC<=1){ ty = py + (posY==='top'?2: posY==='bottom'?(CFG.cell - h - 2):(CFG.cell - h)/2); } else { if(py + h > S.gridH*CFG.cell) ty = py - (h - CFG.cell); }
    var r=document.createElementNS(g.namespaceURI,'rect');
    r.setAttribute('x',tx); r.setAttribute('y',ty);
    r.setAttribute('width',w); r.setAttribute('height',h);
    r.setAttribute('fill',fill); if(stroke){ r.setAttribute('stroke',stroke); r.setAttribute('stroke-width','1'); }
    g.appendChild(r);
    if(label){
      var t=document.createElementNS(g.namespaceURI,'text');
      t.setAttribute('x', tx + w/2); t.setAttribute('y', ty + h/2 + 4);
      t.setAttribute('text-anchor','middle'); t.setAttribute('font-size','10'); t.setAttribute('fill','#fff'); t.textContent=label; g.appendChild(t);
    }
    return {tx:tx,ty:ty,w:w,h:h};
  }
  function drawCircleInCell(g,gx,gy, dCell,posX,posY, fill, stroke){
    var px=gx*CFG.cell, py=gy*CFG.cell;
    var dpx=dCell*CFG.cell; var cx=px+CFG.cell/2, cy=py+CFG.cell/2;
    if(posX==='left') cx = px + dpx/2 + 2;
    if(posX==='right') cx = px + CFG.cell - dpx/2 - 2;
    if(posY==='top') cy = py + dpx/2 + 2;
    if(posY==='bottom') cy = py + CFG.cell - dpx/2 - 2;
    var c=document.createElementNS(g.namespaceURI,'circle');
    c.setAttribute('cx',cx); c.setAttribute('cy',cy); c.setAttribute('r',dpx/2);
    c.setAttribute('fill',fill||'transparent'); if(stroke){ c.setAttribute('stroke',stroke); c.setAttribute('stroke-width','1.5'); }
    g.appendChild(c);
  }

  function drawCells(){
    var g=document.createElementNS(svg.namespaceURI,'g');
    g.setAttribute('transform','translate('+CFG.pad+','+CFG.pad+')');
    var thick=Math.max(2, Math.floor(CFG.cell/5));
    for(var key in S.cells){
      var it=S.cells[key]; var sp=key.split(','), x=parseInt(sp[0]), y=parseInt(sp[1]);
      if(x<0||y<0||x>=S.gridW||y>=S.gridH) continue;
      var px=x*CFG.cell, py=y*CFG.cell;
      if(S.selectedKey===key){
        var sel=document.createElementNS(g.namespaceURI,'rect');
        sel.setAttribute('x',px+2); sel.setAttribute('y',py+2); sel.setAttribute('width',CFG.cell-4); sel.setAttribute('height',CFG.cell-4);
        sel.setAttribute('fill','none'); sel.setAttribute('stroke',CFG.colors.selection); sel.setAttribute('stroke-width','2'); sel.setAttribute('stroke-dasharray','6 6'); g.appendChild(sel);
      }
      var posX=it.posX||'center', posY=it.posY||'center'; var s=snapPos(it.kind, it.o||0, posX,posY); posX=s.x; posY=s.y;

      if(it.kind==='panel50'||it.kind==='panel100'||it.kind==='vidrio'){
        var H=(it.o===1||it.o===3), len=(it.kind==='panel50')? CFG.cell : (CFG.cell*2);
        var bar=document.createElementNS(g.namespaceURI,'rect');
        if(H){
          var yLine = py + (posY==='top'?0: (posY==='bottom'? CFG.cell - thick : Math.floor(CFG.cell/2 - thick/2)));
          var xStart = px; if(len===CFG.cell*2 && (px + len > S.gridW*CFG.cell)) xStart=px - CFG.cell;
          bar.setAttribute('x',xStart); bar.setAttribute('y',yLine); bar.setAttribute('width',len); bar.setAttribute('height',thick);
        }else{
          var xLine = px + (posX==='left'?0: (posX==='right'? CFG.cell - thick : Math.floor(CFG.cell/2 - thick/2)));
          var yStart = py; if(len===CFG.cell*2 && (py + len > S.gridH*CFG.cell)) yStart=py - CFG.cell;
          bar.setAttribute('x',xLine); bar.setAttribute('y',yStart); bar.setAttribute('width',thick); bar.setAttribute('height',len);
        }
        bar.setAttribute('fill', (it.kind==='vidrio')? 'url(#hatch)' : (it.kind==='panel50'? CFG.palette.panel50 : CFG.palette.panel100));
        if(it.kind==='vidrio'){ bar.setAttribute('stroke', CFG.palette.vidrio); bar.setAttribute('stroke-width','1.5'); }
        g.appendChild(bar);
      }else if(it.kind==='puerta'){
        var thick2 = thick, gapLen = Math.floor(CFG.cell*1.4);
        if(it.o===1||it.o===3){
          var yLine2 = py + (posY==='top'?0:(posY==='bottom'? CFG.cell - thick2 : Math.floor(CFG.cell/2 - thick2/2)));
          var xStart2 = px; var width2=CFG.cell*2; if(px + width2 > S.gridW*CFG.cell) xStart2 = px - CFG.cell;
          var L=document.createElementNS(g.namespaceURI,'rect');
          var gs = xStart2 + Math.max(0,(width2-gapLen)/2);
          L.setAttribute('x',xStart2); L.setAttribute('y',yLine2); L.setAttribute('width',Math.max(0, gs-xStart2)); L.setAttribute('height',thick2); L.setAttribute('fill',CFG.palette.puerta); g.appendChild(L);
          var R=document.createElementNS(g.namespaceURI,'rect');
          var ge = xStart2 + Math.min(width2,(width2+gapLen)/2);
          R.setAttribute('x',ge); R.setAttribute('y',yLine2); R.setAttribute('width',Math.max(0, xStart2+width2-ge)); R.setAttribute('height',thick2); R.setAttribute('fill',CFG.palette.puerta); g.appendChild(R);
        }else{
          var xLine2 = px + (posX==='left'?0:(posX==='right'? CFG.cell - thick2 : Math.floor(CFG.cell/2 - thick2/2)));
          var yStart2 = py; var height2=CFG.cell*2; if(py + height2 > S.gridH*CFG.cell) yStart2 = py - CFG.cell;
          var T=document.createElementNS(g.namespaceURI,'rect');
          var gs2 = yStart2 + Math.max(0,(height2-gapLen)/2);
          T.setAttribute('x',xLine2); T.setAttribute('y',yStart2); T.setAttribute('width',thick2); T.setAttribute('height',Math.max(0, gs2-yStart2)); T.setAttribute('fill',CFG.palette.puerta); g.appendChild(T);
          var B=document.createElementNS(g.namespaceURI,'rect');
          var ge2 = yStart2 + Math.min(height2,(height2+gapLen)/2);
          B.setAttribute('x',xLine2); B.setAttribute('y',ge2); B.setAttribute('width',thick2); B.setAttribute('height',Math.max(0, yStart2+height2-ge2)); B.setAttribute('fill',CFG.palette.puerta); g.appendChild(B);
        }
      }else if(it.kind==='corner50'){
        var t=thick, half=CFG.cell;
        var r1=document.createElementNS(g.namespaceURI,'rect');
        var r2=document.createElementNS(g.namespaceURI,'rect');
        var o=it.o||0;
        if(o===0){ r1.setAttribute('x',px); r1.setAttribute('y',py); r1.setAttribute('width',half); r1.setAttribute('height',t);
                   r2.setAttribute('x',px); r2.setAttribute('y',py); r2.setAttribute('width',t); r2.setAttribute('height',half); }
        else if(o===1){ r1.setAttribute('x',px); r1.setAttribute('y',py); r1.setAttribute('width',half); r1.setAttribute('height',t);
                        r2.setAttribute('x',px + CFG.cell - t); r2.setAttribute('y',py); r2.setAttribute('width',t); r2.setAttribute('height',half); }
        else if(o===2){ r1.setAttribute('x',px); r1.setAttribute('y',py + CFG.cell - t); r1.setAttribute('width',half); r1.setAttribute('height',t);
                        r2.setAttribute('x',px + CFG.cell - t); r2.setAttribute('y',py); r2.setAttribute('width',t); r2.setAttribute('height',half); }
        else{ r1.setAttribute('x',px); r1.setAttribute('y',py + CFG.cell - t); r1.setAttribute('width',half); r1.setAttribute('height',t);
              r2.setAttribute('x',px); r2.setAttribute('y',py); r2.setAttribute('width',t); r2.setAttribute('height',half); }
        r1.setAttribute('fill',CFG.palette.corner50); r2.setAttribute('fill',CFG.palette.corner50); g.appendChild(r1); g.appendChild(r2);
      }else if((it.kind.indexOf('torre')===0 || ['counter','sofa2'].indexOf(it.kind)>=0)){
        var H2=(it.o===1||it.o===3); var wC=H2?2:1, hC=H2?1:2;
        var fill=(it.kind.indexOf('torre')===0? CFG.palette.torre : CFG.palette[it.kind]);
        var label=(it.kind.indexOf('torre')===0?'TOR': (it.kind==='counter'?'C1':'S2'));
        drawBoxRect(g,x,y,wC,hC,posX,posY,fill,null,label);
      }else if(it.kind==='columna50'){
        drawBoxRect(g,x,y,1,1,posX,posY,CFG.palette.columna50,null,'COL50');
      }else if(['p48','p55','p65'].indexOf(it.kind)>=0){
        var Hs=(it.o===1||it.o===3), dims=null;
        if(it.kind==='p48') dims = Hs?{w:2.0,h:0.4}:{w:0.4,h:2.0};
        if(it.kind==='p55') dims = Hs?{w:2.5,h:0.4}:{w:0.4,h:2.5};
        if(it.kind==='p65') dims = Hs?{w:2.8,h:0.4}:{w:0.4,h:2.8};
        var fillp=CFG.palette[it.kind], labelp=(it.kind==='p48'?'48"':(it.kind==='p55'?'55"':'65"'));
        drawBoxRect(g,x,y,dims.w,dims.h,posX,posY,fillp,null,labelp);
      }else if(['counter50','sofa1','led'].indexOf(it.kind)>=0){
        var fillb=(it.kind==='led')? 'url(#leddots)' : CFG.palette[it.kind];
        var stroke=(it.kind==='led')? CFG.palette.led : null;
        var labelb=(it.kind==='counter50'?'C0.5': (it.kind==='sofa1'?'S1':'LED'));
        drawBoxRect(g,x,y,1,1,posX,posY,fillb,stroke,labelb);
      }else if(it.kind==='banqueta'){
        var o1=drawBoxRect(g,x,y,1,1,posX,posY,'transparent',CFG.palette.banqueta,null);
        var r=document.createElementNS(g.namespaceURI,'rect');
        var vw=Math.floor(0.8*CFG.cell), vh=Math.floor(0.8*CFG.cell);
        r.setAttribute('x',o1.tx + (o1.w-vw)/2); r.setAttribute('y', o1.ty + (o1.h-vh)/2);
        r.setAttribute('width',vw); r.setAttribute('height',vh); r.setAttribute('fill',CFG.palette.banqueta); g.appendChild(r);
      }else if(it.kind==='columna40c'){
        drawBoxRect(g,x,y,1,1,posX,posY,'transparent',CFG.palette.columna40c,null);
        drawCircleInCell(g,x,y,0.8,posX,posY,CFG.palette.columna40c,CFG.palette.columna40c);
      }
    }
    svg.appendChild(g);
  }

  function drawCenefas(){
    var g=document.createElementNS(svg.namespaceURI,'g');
    g.setAttribute('transform','translate('+CFG.pad+','+CFG.pad+')');
    var thick=Math.max(2, Math.floor(CFG.cell/5));
    for(var i=0;i<S.cenefas.length;i++){
      var it=S.cenefas[i], gx=it.gx, gy=it.gy;
      var px=gx*CFG.cell, py=gy*CFG.cell;
      var posX=it.posX||'center', posY=it.posY||'center';
      var s=snapPos(it.kind, it.o||0, posX,posY); posX=s.x; posY=s.y;

      if(S.selectedOverlayIdx===i){
        var sel=document.createElementNS(g.namespaceURI,'rect');
        sel.setAttribute('x',px+2); sel.setAttribute('y',py+2); sel.setAttribute('width',CFG.cell-4); sel.setAttribute('height',CFG.cell-4);
        sel.setAttribute('fill','none'); sel.setAttribute('stroke',CFG.colors.selectionOverlay); sel.setAttribute('stroke-width','2'); sel.setAttribute('stroke-dasharray','3 3'); g.appendChild(sel);
      }
      var H=(it.o===1||it.o===3);
      var len=(it.kind.indexOf('50')>=0)? CFG.cell : (CFG.cell*2);
      var stroke=(it.kind.indexOf('cenefaApo')===0)? CFG.palette.cenefaApo : CFG.palette.cenefaSus;
      var dash=(it.kind.indexOf('cenefaApo')===0)? '6 6' : '2 4';
      if(H){
        var yLine=py + (posY==='top'?0:(posY==='bottom'? CFG.cell - thick : Math.floor(CFG.cell/2 - thick/2)));
        var xStart=px; if(len===CFG.cell*2 && (px + len > S.gridW*CFG.cell)) xStart=px - CFG.cell;
        var r=document.createElementNS(g.namespaceURI,'rect');
        r.setAttribute('x',xStart); r.setAttribute('y',yLine); r.setAttribute('width',len); r.setAttribute('height',thick);
        r.setAttribute('fill','none'); r.setAttribute('stroke',stroke); r.setAttribute('stroke-width','2'); r.setAttribute('stroke-dasharray',dash); g.appendChild(r);
      }else{
        var xLine=px + (posX==='left'?0:(posX==='right'? CFG.cell - thick : Math.floor(CFG.cell/2 - thick/2)));
        var yStart=py; if(len===CFG.cell*2 && (py + len > S.gridH*CFG.cell)) yStart=py - CFG.cell;
        var r2=document.createElementNS(g.namespaceURI,'rect');
        r2.setAttribute('x',xLine); r2.setAttribute('y',yStart); r2.setAttribute('width',thick); r2.setAttribute('height',len);
        r2.setAttribute('fill','none'); r2.setAttribute('stroke',stroke); r2.setAttribute('stroke-width','2'); r2.setAttribute('stroke-dasharray',dash); g.appendChild(r2);
      }
    }
    svg.appendChild(g);
  }

  function countsAndCosts(){
    var keys = ALL_KEYS.concat(['panel100','panel50','corner50','puerta','vidrio','columna50','columna40c']).concat(CENEFA_KEYS);
    var c={}; keys.forEach(function(i){c[i]=0;});
    for(var k in S.cells){ var kind=S.cells[k].kind; if(c.hasOwnProperty(kind)) c[kind]++; }
    for(var i=0;i<S.cenefas.length;i++){ var kind2=S.cenefas[i].kind; if(c.hasOwnProperty(kind2)) c[kind2]++; }
    var screenSides=['A','B','C','D'].filter(function(k){ return S.sides[k] && S.pantallas[k]; }).length;
    var p = (function(o){ try{ var out=Object.assign({}, o, (o&&o.items)||{});
        if(o&&o.floor){ out.floor=o.floor; if(o.items&&o.items.floor){ out.floor=Object.assign({}, o.floor, o.items.floor); } }
        if(o&&o.graphics){ out.graphics=o.graphics; if(o.items&&o.items.graphics){ out.graphics=Object.assign({}, o.graphics, o.items.graphics); } }
        return out; }catch(_){ return o||{}; } })(CFG.prices); var lines=[];
    // === Medianera fucsia integrada en resumen ===
    (function(){
      try{
        var mW = (S.gridW||0)/2, mH = (S.gridH||0)/2;
        var sides = S.sides||{};
        var ml = 0;
        if(sides.A) ml += mW;
        if(sides.B) ml += mH;
        if(sides.C) ml += mW;
        if(sides.D) ml += mH;
        var tarifa = (CFG && CFG.prices && typeof CFG.prices.medianeraPerM==='number') ? CFG.prices.medianeraPerM : 0;
        // Formato alineado a "Tarima ... m¬≤: X" -> "Medianera (m): X"
        // Qty = 1 para que el n√∫mero principal quede en el Concepto
        lines.push({ label: 'Medianera (m): ' + (Math.round(ml*10)/10), qty: 1, total: tarifa * ml });
      }catch(e){}
    })();
    // === fin medianera ===
    
    function push(label,qty,total){ if(qty>0 || total>0) lines.push({label:label, qty:qty, total:total}); }
    push('Panel 1.00 m', c.panel100, c.panel100*p.panel100);
    push('Panel 0.50 m', c.panel50, c.panel50*p.panel50);
    push('Esquinero 0.50√ó0.50', c.corner50, c.corner50*p.corner50);
    push('Puerta (apertura 1.00 m)', c.puerta, c.puerta*p.puerta);
    push('Vidrio 1.00 m', c.vidrio, c.vidrio*p.vidrio);
    push('Columna 0.50√ó0.50', c.columna50, c.columna50*p.columna50);
    push('Columna √ò0.40', c.columna40c, c.columna40c*p.columna40c);
    push('Cenefa apoyada 1.00 m', c.cenefaApo100, c.cenefaApo100*p.cenefaApo100);
    push('Cenefa apoyada 0.50 m', c.cenefaApo50, c.cenefaApo50*p.cenefaApo50);
    push('Cenefa suspendida 1.00 m', c.cenefaSus100, c.cenefaSus100*p.cenefaSus100);
    push('Cenefa suspendida 0.50 m', c.cenefaSus50, c.cenefaSus50*p.cenefaSus50);
    push('Torre (1√ó0.5)', c.torre, c.torre*p.torre);
    push('LED Wall (0.5√ó0.5)', c.led, c.led*p.led);
    push('Pantalla 48" (1.00√ó0.20)', c.p48, c.p48*p.p48);
    push('Pantalla 55" (1.20√ó0.20)', c.p55, c.p55*p.p55);
    push('Pantalla 65" (1.40√ó0.20)', c.p65, c.p65*p.p65);
    push('Mostrador 1.00 (1√ó0.5)', c.counter, c.counter*p.counter);
    push('Mostrador 0.50 (0.5√ó0.5)', c.counter50, c.counter50*p.counter50);
    push('Banqueta (0.4√ó0.4)', c.banqueta, c.banqueta*p.banqueta);
    push('Sill√≥n 2 cuerpos (1√ó0.5)', c.sofa2, c.sofa2*p.sofa2);
    push('Sill√≥n 1 cuerpo (0.5√ó0.5)', c.sofa1, c.sofa1*p.sofa1);
// (eliminado para evitar doble conteo) push('Pantallas en medianera (por lado)', screenSides, screenSides*p.pantalla);
    var m2=S.gridW*S.gridH*0.25, floorUnit=p.floor[S.floor]||0;
    lines.push({label:'Tarima ('+S.floor+') m¬≤: '+m2, qty:1, total:floorUnit*m2});
    var v=Math.max(0,S.gfxVinilo||0), l=Math.max(0,S.gfxLona||0), e=Math.max(0,S.gfxEsmerilado||0);
    if(v>0) lines.push({label:'Vinilo mate (m¬≤ '+v+')', qty:v, total:p.graphics.vinilo*v});
    if(l>0) lines.push({label:'Lona mate (m¬≤ '+l+')', qty:l, total:p.graphics.lona*l});
    if(e>0) lines.push({label:'Esmerilado (m¬≤ '+e+')', qty:e, total:p.graphics.esmerilado*e});
    
    (function(){
      var v = 0;
      try{
        var live = document.querySelector('input[data-price-key="laborMinFixed"]');
        if(live){ var vv = parseFloat(live.value); if(isFinite(vv)) v = vv; }
      }catch(_){}
      if(!v){ try{ v = +p.laborMinFixed || +((CFG&&CFG.prices&&CFG.prices.items&&CFG.prices.items.laborMinFixed)||0); }catch(_){ v = 0; } }
      if(v>0) (function(){
  var v = 0;
  try{
    // Igual que otros elementos: leer de items primero
    v = +(((window.CFG||{}).prices||{}).items||{}).laborMinFixed || +(((window.CFG||{}).prices)||{}).laborMinFixed || 0;
  }catch(_){ v = 0; }
  if(v>0) lines.push({label:'Trabajo m√≠nimo (fijo)', qty:1, total:v});
})();
    })();
    
    if(e>0) lines.push({label:'Esmerilado (m¬≤ '+e+')', qty:e, total:p.graphics.esmerilado*e});
    if(S.lightPack>0) lines.push({label:'Light Pack √ó '+S.lightPack, qty:S.lightPack, total:p.lightPack*S.lightPack});
    if(S.raPack>0) lines.push({label:'RA Pack √ó '+S.raPack, qty:S.raPack, total:p.raPack*S.raPack});
    if(S.audioPack>0) lines.push({label:'Audio Pack √ó '+S.audioPack, qty:S.audioPack, total:p.audioPack*S.audioPack});
    var subtotal=0; for(var ii=0;ii<lines.length;ii++) subtotal+=lines[ii].total;
    return {lines:lines, subtotal:subtotal};
  }
  function renderSummary(){
    var x=countsAndCosts(); var lines=x.lines, subtotal=x.subtotal;
    var fmt=function(n){return '$'+Math.round(n).toLocaleString();};
    var html='<div class="kpi"><strong>Concepto</strong><strong>Cant.</strong><strong>Total</strong></div><div class="hr"></div>';
    for(var i=0;i<lines.length;i++){ var L=lines[i]; html+='<div class="kpi"><span>'+L.label+'</span><span>'+(L.qty||'')+'</span><span>'+fmt(L.total)+'</span></div>'; }
    html+='<div class="hr"></div><div class="kpi"><strong>Total</strong><span></span><strong>'+fmt(subtotal)+'</strong></div>';
    document.getElementById('summary').innerHTML=html;
  }

  function xyFromEvent(evt){
    var rect=svg.getBoundingClientRect();
    var x=evt.clientX-rect.left, y=evt.clientY-rect.top;
    var vb=svg.viewBox.baseVal; var scaleX=vb.width/rect.width, scaleY=vb.height/rect.height;
    var sx=vb.x + x*scaleX, sy=vb.y + y*scaleY;
    var gx=Math.floor((sx-CFG.pad)/CFG.cell), gy=Math.floor((sy-CFG.pad)/CFG.cell);
    return {gx:gx, gy:gy};
  }
  function updateSelInfo(){
    var info=document.getElementById('selInfo');
    if(S.selectedOverlayIdx!=null){
      var it=S.cenefas[S.selectedOverlayIdx];
      info.textContent='Sel (cenefa): '+it.gx+','+it.gy+' ‚Äî '+it.kind+' o='+(it.o||0)+' ¬∑ posX='+(it.posX||'center')+' ¬∑ posY='+(it.posY||'center');
      return;
    }
    if(!S.selectedKey){ info.textContent='Sin selecci√≥n'; }
    else{
      var it2=S.cells[S.selectedKey];
      info.textContent='Sel: '+S.selectedKey+' ‚Äî '+it2.kind+(it2.o!=null?' o='+it2.o:'')+' ¬∑ posX='+(it2.posX||'center')+' ¬∑ posY='+(it2.posY||'center');
    }
  }
  function getSelectedRef(){
    if(S.selectedOverlayIdx!=null){
      var idx=S.selectedOverlayIdx;
      return {type:'overlay', idx:idx, get:function(){return S.cenefas[idx];}, set:function(obj){ S.cenefas[idx]=obj; }};
    }else if(S.selectedKey){
      var k=S.selectedKey; return {type:'base', key:k, get:function(){return S.cells[k];}, set:function(obj){ S.cells[k]=obj; }};
    }
    return null;
  }
  function setPos(px,py){
    var ref=getSelectedRef(); if(!ref) return; var it=ref.get(); if(!it) return;
    if(it.posX==null) it.posX='center'; if(it.posY==null) it.posY='center';
    if(it.kind==='corner50'){
      if(px==='left'&&py==='top') it.o=0;
      else if(px==='right'&&py==='top') it.o=1;
      else if(px==='right'&&py==='bottom') it.o=2;
      else if(px==='left'&&py==='bottom') it.o=3;
      else if(py==='top') it.o = it.o===1?1:0;
      else if(py==='bottom') it.o = it.o===2?2:3;
      else if(px==='left') it.o = it.o===3?3:0;
      else if(px==='right') it.o = it.o===2?2:1;
    }else{
      if(px) it.posX=px; if(py) it.posY=py;
    }
    ref.set(it); render();
  }
  function selRotate(){ var ref=getSelectedRef(); if(!ref) return; var it=ref.get(); if(it.o==null) it.o=0; it.o=(it.o+1)%4; ref.set(it); render(); }
  function selRotateCCW(){ var ref=getSelectedRef(); if(!ref) return; var it=ref.get(); if(it.o==null) it.o=0; it.o=(it.o+3)%4; ref.set(it); render(); }
  function selMirror(axis){ var ref=getSelectedRef(); if(!ref) return; var it=ref.get(); if(it.o==null) return; if(axis==='H'){ it.o=(it.o===1)?3: (it.o===3)?1:it.o; } else { it.o=(it.o===0)?2: (it.o===2)?0:it.o; } ref.set(it); render(); }
  function selDelete(){ var ref=getSelectedRef(); if(!ref) return; if(ref.type==='overlay'){ S.cenefas.splice(ref.idx,1); S.selectedOverlayIdx=null; } else { delete S.cells[ref.key]; S.selectedKey=null; } render(); }

  svg.addEventListener('click', function(e){
    var p=xyFromEvent(e); var gx=p.gx, gy=p.gy;
    if(gx<0||gy<0||gx>=S.gridW||gy>=S.gridH) return;
    if(S.tool==='erase'){
      var idx=-1; for(var i=0;i<S.cenefas.length;i++){ if(S.cenefas[i].gx===gx && S.cenefas[i].gy===gy){ idx=i; break; } }
      if(idx>=0){ S.cenefas.splice(idx,1); if(S.selectedOverlayIdx===idx) S.selectedOverlayIdx=null; render(); return; }
      var key=gx+','+gy; if(S.cells[key]){ delete S.cells[key]; if(S.selectedKey===key) S.selectedKey=null; render(); } return;
    }
    if(S.tool==='select'){
      var idx2=-1; for(var j=S.cenefas.length-1;j>=0;j--){ if(S.cenefas[j].gx===gx && S.cenefas[j].gy===gy){ idx2=j; break; } }
      if(idx2>=0){ S.selectedOverlayIdx=idx2; S.selectedKey=null; updateSelInfo(); render(); return; }
      var key2=gx+','+gy; S.selectedKey = (S.selectedKey===key2)? null : (S.cells[key2]? key2 : null); S.selectedOverlayIdx=null; updateSelInfo(); render(); return;
    }
    if(CENEFA_KEYS.indexOf(S.tool)>=0){
      var v={gx:gx, gy:gy, kind:S.tool, posX:'center', posY:'center', o:0};
      S.cenefas.push(v); S.selectedOverlayIdx=S.cenefas.length-1; S.selectedKey=null; updateSelInfo(); render(); return;
    }
    var key3=gx+','+gy; var rotKinds={}; ALL_KEYS.concat(['vidrio','puerta','corner50','panel100','panel50']).forEach(function(k){ rotKinds[k]=true; });
    if(S.cells[key3] && S.cells[key3].kind===S.tool && rotKinds[S.tool]){
      var it=S.cells[key3]; it.o=((it.o||0)+1)%4; S.selectedKey=key3; S.selectedOverlayIdx=null;
    }else{
      var v2={kind:S.tool, posX:'center', posY:'center'}; if(rotKinds[S.tool]) v2.o=0; S.cells[key3]=v2; S.selectedKey=key3; S.selectedOverlayIdx=null;
    }
    updateSelInfo(); render();
  });

  document.getElementById('resize').addEventListener('click', function(){
    var gw=parseInt(document.getElementById('gw').value)||S.gridW;
    var gh=parseInt(document.getElementById('gh').value)||S.gridH;
    S.gridW=Math.max(2,Math.min(60,gw)); S.gridH=Math.max(2,Math.min(60,gh));
    updateGridMeters();
    resizeSVG(); render();
  });
  document.getElementById('erase').addEventListener('click', function(){ S.tool='erase'; syncToolLabel(); });
  document.getElementById('reset').addEventListener('click', function(){ S.cells={}; S.cenefas=[]; S.selectedKey=null; S.selectedOverlayIdx=null; render(); });
  document.getElementById('floor').addEventListener('change', function(){ S.floor=this.value; render(); });
  document.getElementById('gfxVinilo').addEventListener('input', function(){ S.gfxVinilo=Math.max(0,parseInt(this.value)||0); render(); });
  document.getElementById('gfxLona').addEventListener('input', function(){ S.gfxLona=Math.max(0,parseInt(this.value)||0); render(); });
  document.getElementById('gfxEsmerilado').addEventListener('input', function(){ S.gfxEsmerilado=Math.max(0,parseInt(this.value)||0); render(); });
  document.getElementById('lightPack').addEventListener('input', function(){ S.lightPack=Math.max(0,parseInt(this.value)||0); render(); });
  document.getElementById('raPack').addEventListener('input', function(){ S.raPack=Math.max(0,parseInt(this.value)||0); render(); });
  document.getElementById('audioPack').addEventListener('input', function(){ S.audioPack=Math.max(0,parseInt(this.value)||0); render(); });
  document.getElementById('export').addEventListener('click', function(){
    var data=JSON.stringify(S); var blob=new Blob([data],{type:'application/json'}); var url=URL.createObjectURL(blob);
    var a=document.createElement('a'); a.href=url; a.download='config_dali_svg_plain_v10_2.json'; a.click(); URL.revokeObjectURL(url);
  });
  document.getElementById('import').addEventListener('click', function(){
    var inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
    inp.onchange=function(e){
      var f=e.target.files[0]; if(!f) return;
      var r=new FileReader(); r.onload=function(){
        try{
          var data=JSON.parse(r.result);
          if(data && data.gridW && data.gridH){
            for(var k in data) S[k]=data[k];
            document.getElementById('gw').value=S.gridW; document.getElementById('gh').value=S.gridH;
            document.getElementById('floor').value=S.floor;
            updateGridMeters();
            document.getElementById('gfxVinilo').value=S.gfxVinilo||0;
            document.getElementById('gfxLona').value=S.gfxLona||0;
            document.getElementById('gfxEsmerilado').value=S.gfxEsmerilado||0;
            document.getElementById('lightPack').value=S.lightPack||0;
            document.getElementById('raPack').value=S.raPack||0;
            document.getElementById('audioPack').value=S.audioPack||0;
            document.getElementById('lotType').value=S.lotType||'isla';
            refreshLotOrientationUI();
            ['A','B','C','D'].forEach(function(k){
              var el1=document.querySelector('input[data-side="'+k+'"]'); if(el1) el1.checked=!!S.sides[k];
              var el2=document.querySelector('input[data-side="'+k+'-pantalla"]'); if(el2) el2.checked=!!S.pantallas[k];
            });
            resizeSVG(); render();
          }
        }catch(err){ alert('Archivo inv√°lido'); }
      };
      r.readAsText(f);
    };
    inp.click();
  });
  document.getElementById('selectTool').addEventListener('click', function(){ S.tool='select'; syncToolLabel(); });

  document.getElementById('selRotate').addEventListener('click', selRotate);
  document.getElementById('selMirrorH').addEventListener('click', function(){ selMirror('H'); });
  document.getElementById('selMirrorV').addEventListener('click', function(){ selMirror('V'); });
  document.getElementById('posCenter').addEventListener('click', function(){ setPos('center','center'); });
  document.getElementById('posTop').addEventListener('click', function(){ setPos(null,'top'); });
  document.getElementById('posBottom').addEventListener('click', function(){ setPos(null,'bottom'); });
  document.getElementById('posLeft').addEventListener('click', function(){ setPos('left',null); });
  document.getElementById('posRight').addEventListener('click', function(){ setPos('right',null); });

  document.addEventListener('keydown', function(e){
    var k=e.key; var handled=false;
    if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','. ',',','h','H','v','V','c','C','Delete','Backspace'].indexOf(k)>=0) e.preventDefault();
    if(S.selectedOverlayIdx==null && !S.selectedKey) return;
    switch(k){
      case 'ArrowUp': setPos(null,'top'); handled=true; break;
      case 'ArrowDown': setPos(null,'bottom'); handled=true; break;
      case 'ArrowLeft': setPos('left',null); handled=true; break;
      case 'ArrowRight': setPos('right',null); handled=true; break;
      case '.': selRotate(); handled=true; break;
      case ',': selRotateCCW(); handled=true; break;
      case 'h': case 'H': selMirror('H'); handled=true; break;
      case 'v': case 'V': selMirror('V'); handled=true; break;
      case 'c': case 'C': setPos('center','center'); handled=true; break;
      case 'Delete': case 'Backspace': selDelete(); handled=true; break;
    }
    if(handled) updateSelInfo();
  });

  document.querySelectorAll('#sides input[type="checkbox"]').forEach(function(chk){
    chk.addEventListener('change', function(){
      var k=this.getAttribute('data-side');
      if(k.indexOf('-pantalla')>=0){ var s=k.split('-')[0]; S.pantallas[s]=this.checked; }
      else{ S.sides[k]=this.checked; }
      render();
    });
  });
  document.getElementById('lotType').addEventListener('change', function(){
    S.lotType=this.value; applyLotPreset(); refreshLotOrientationUI(); render();
  });
  document.getElementById('lotOrient').addEventListener('change', function(){ S.lotOrient=this.value; applyLotPreset(); render(); });

  document.getElementById('gw').value=S.gridW; document.getElementById('gh').value=S.gridH;
  document.getElementById('floor').value=S.floor;
            updateGridMeters();
  document.getElementById('gfxVinilo').value=S.gfxVinilo;
  document.getElementById('gfxLona').value=S.gfxLona;
  document.getElementById('gfxEsmerilado').value=S.gfxEsmerilado;
  refreshLotOrientationUI();
  updateGridMeters();
  renderGroupButtons();
  renderToolButtons();
  syncToolLabel();
  resizeSVG();
  render();

  function render(){
    clearSVG();
    svg.appendChild(defs());
    drawGrid();
    drawPerimeter();
    drawCells();
    drawCenefas();
    renderSummary();
  }
})();</script>
<!-- ===== AI ENHANCEMENTS (METROS) INJECTED ===== -->
<style>
  /* --- AI Addon Styles (metros build) --- */
  .ai-badges { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
  .ai-badge { display:inline-flex; align-items:center; gap:.4rem; padding:.25rem .55rem; border-radius:999px; font:500 12px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#111; color:#fff; opacity:.9; }
  .ai-bar { position:sticky; top:0; z-index:9999; display:flex; gap:.5rem; align-items:center; padding:.5rem; border-bottom:1px solid rgba(0,0,0,.08); background:linear-gradient(180deg,#fff, #fafafa); }
  .ai-bar button { padding:.45rem .7rem; border:1px solid rgba(0,0,0,.15); border-radius:.6rem; background:#fff; cursor:pointer; font:500 13px/1 system-ui; }
  .ai-bar button:active { transform:translateY(1px); }
  .ai-modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:10000; }
  .ai-modal { width:min(720px,92vw); background:#fff; border-radius:12px; box-shadow:0 20px 60px rgba(0,0,0,.25); overflow:hidden; }
  .ai-modal header { display:flex; align-items:center; justify-content:space-between; padding:12px 16px; background:#111; color:#fff; }
  .ai-modal .body { padding:16px; max-height:60vh; overflow:auto; }
  .ai-grid { display:grid; grid-template-columns:200px 1fr; gap:8px; align-items:center; }
  .ai-grid label { font:500 13px/1.2 system-ui; color:#333; }
  .ai-grid input { width:100%; padding:.45rem .55rem; border:1px solid rgba(0,0,0,.18); border-radius:8px; font:500 13px/1 system-ui; }
  .ai-row { display:flex; gap:.5rem; justify-content:flex-end; padding:12px 16px; border-top:1px solid rgba(0,0,0,.08); background:#fafafa; }
  .ai-muted { opacity:.7; }
  .ai-hidden { display:none !important; }
  .ai-compact-input { width:78px;padding:.25rem .4rem;border:1px solid rgba(0,0,0,.15);border-radius:8px; }
  .ai-selected { outline:2px dashed #3b82f6; outline-offset:2px; }
  /* Ocultar grilla de celdas base permanentemente */
  #grid, [data-grid="true"] { display:none !important; visibility:hidden !important; opacity:0 !important; }
</style>
<!-- === AI Addon Toolbar (metros build) === -->
<div class="ai-bar" id="aiBar">
<div class="ai-badges">
<span class="ai-badge" id="aiToolLabel">Herramienta</span>
<span class="ai-badge" id="aiGridMeters" title="Medidas del lote">W√óH</span>
</div>
<div style="flex:1"></div>
<!-- Lote en METROS -->
<div class="ai-badges" style="gap:.35rem;">
<span class="ai-badge">Lote (m):</span>
<input class="ai-compact-input" id="aiLotW" min="2" placeholder="Ancho (m)" step="0.5" type="number"/>
<span style="font:600 12px/1 system-ui;">√ó</span>
<input class="ai-compact-input" id="aiLotH" min="2" placeholder="Largo (m)" step="0.5" type="number"/>
<button id="aiApplyLot" title="Aplicar tama√±o de lote en metros">Aplicar</button>
</div>
<button id="aiBtnDuplicate" title="Duplicar selecci√≥n (Ctrl+D)">Duplicar selecci√≥n</button>
<button id="aiBtnExport" title="Exportar PNG del lienzo">Exportar PNG</button>
<button id="aiBtnPrices" title="Editar precios con contrase√±a">Editar precios</button>
</div>
<!-- === AI Modal for Prices === -->
<div aria-hidden="true" class="ai-modal-backdrop" id="aiModalBackdrop">
<div aria-labelledby="aiModalTitle" aria-modal="true" class="ai-modal" role="dialog">
<header>
<strong id="aiModalTitle">Editor de precios</strong>
<button id="aiModalClose" style="background:transparent;border:none;color:#fff;font:600 18px/1 system-ui;cursor:pointer;">‚úï</button>
</header>
<div class="body">
<p class="ai-muted" id="aiModalHint">Ingres√° la contrase√±a para habilitar la edici√≥n. Los cambios se guardan en este navegador (localStorage).</p>
<div style="display:flex; gap:.5rem; align-items:center; margin:8px 0 16px;">
<input id="aiPass" placeholder="Contrase√±a" style="flex:1; padding:.5rem .6rem; border:1px solid rgba(0,0,0,.25); border-radius:8px;" type="password">
<button id="aiUnlock">Desbloquear</button>
</input></div>
<div class="ai-grid ai-hidden" id="aiForm"></div>
</div>
<div class="ai-row">
<button class="ai-muted" id="aiReset">Restablecer</button>
<button disabled="" id="aiSave">Guardar</button>
</div>
</div>
</div>
<script>
// ===== AI Addon: Metros build =====
(() => {
  const PASS = "dali2025";
  const STORAGE_KEY = "CFG_prices_override_v10_2b";
  const SNAP_TOL = 12;
  const CELL_PX_DEFAULT = 48; // 0.5 m por celda (fallback si no hay gridEl)
  let strongSnap = true; // snap perimetral activado por defecto

  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  // Bloquear atajos globales cuando se escribe en inputs
  ['keydown','keypress','keyup'].forEach(evt => {
    document.addEventListener(evt, function(e){
      const t = e.target; if (!t) return;
      const tag = (t.tagName||'').toLowerCase();
      if (tag === 'input' || tag === 'textarea' || tag === 'select' || t.isContentEditable) {
        e.stopPropagation();
      }
    }, true);
  });

  const svg = $('svg, #canvas, [data-canvas="svg"]') || null;
  function vb(){ return (svg && svg.viewBox && svg.viewBox.baseVal) ? svg.viewBox.baseVal : null; }

  function toolLabelUpdate() {
    const el = $('#aiToolLabel'); if (!el) return;
    const existing = $('#toolLabel') || $('[data-tool-label]');
    el.textContent = existing?.textContent?.trim() || 'Seleccionar';
  }

  function cellPx(){
    const gridEl = $('#grid, [data-grid=\"true\"]');
    const v = Number(gridEl?.getAttribute('data-cell') || CELL_PX_DEFAULT);
    return isFinite(v) && v>0 ? v : CELL_PX_DEFAULT;
  }

  function computeMetersFromVB(){
    const v = vb(); if (!v) return {w:null,h:null};
    const px = cellPx();
    return { w: (v.width / px) * 0.5, h: (v.height / px) * 0.5 };
  }

  function updateMetersBadge(){
    const badge = $('#aiGridMeters'); if (!badge) return;
    const m = computeMetersFromVB();
    if (m.w && m.h) badge.textContent = `${m.w.toFixed(1)} √ó ${m.h.toFixed(1)} m`;
  }

  function writePrices(prices){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(prices));
    if (window.CFG && window.CFG.prices) {
      window.CFG.prices = prices;
      if (typeof window.updateCostSummary === 'function') try { window.updateCostSummary(); } catch(e){}
    }
  }

  function readPrices(){
    const override = localStorage.getItem(STORAGE_KEY);
    if (override) { try { return JSON.parse(override); } catch(e){} }
    if (window.CFG && window.CFG.prices) return JSON.parse(JSON.stringify(window.CFG.prices));
    return {
      module: 150, totem: 250, led: 400, audio: 120, counter: 180,
      counter50: 120, banqueta: 60, lightPack: 250, raPack: 180,
      graphicsPerM2: 30,
      floor: { carpet: 18, lowMelamine: 40, lowAggCarpet: 38, highModular: 65 }
    };
  }

  function buildPricesForm(prices){
    const form = $('#aiForm'); if (!form) return;
    form.innerHTML = '';
    const addField = (label, path, value) => {
      const id = 'p_' + path.join('_');
      const row = document.createElement('div');
      row.className = 'row';
      row.innerHTML = `
        <label for="${id}">${label}</label>
        <input id="${id}" type="number" step="0.01" value="${Number(value)}" data-path="${path.join('.')}" inputmode="decimal" pattern="[0-9.,-]*" />
      `;
      form.appendChild(row);
    };
    form.classList.add('ai-grid');
    for (const [k, v] of Object.entries(prices)) {
      if (typeof v === 'object' && v && !Array.isArray(v)) {
        for (const [kk, vv] of Object.entries(v)) addField(`${k}.${kk}`, [k, kk], vv);
      } else addField(k, [k], v);
    }
  }

  function openModal(){ $('#aiModalBackdrop').style.display = 'flex'; }
  function closeModal(){ $('#aiModalBackdrop').style.display = 'none'; }

  function attachSelection(){
    if (!svg) return;
    svg.addEventListener('click', (e) => {
      if (!(e.target instanceof Element)) return;
      const target = e.target.closest('[data-draggable], g, rect, path, image, use, foreignObject');
      if (!target || target === svg) return;
      $$('.ai-selected', svg).forEach(n => n.classList.remove('ai-selected'));
      target.classList.add('ai-selected');
    }, true);
  }

  function duplicateSelection(){
    if (!svg) return;
    const sel = $('.ai-selected', svg);
    if (!sel) { alert('Seleccion√° un elemento del lienzo.'); return; }
    const clone = sel.cloneNode(true);
    if (clone.hasAttribute('transform')) {
      const tr = clone.getAttribute('transform');
      clone.setAttribute('transform', tr + ' translate(24,24)');
    } else if (clone.hasAttribute('x') || clone.hasAttribute('y')) {
      const x = Number(clone.getAttribute('x')||0)+24;
      const y = Number(clone.getAttribute('y')||0)+24;
      clone.setAttribute('x', x); clone.setAttribute('y', y);
    } else {
      const g = document.createElementNS('http://www.w3.org/2000/svg','g');
      g.setAttribute('transform','translate(24,24)');
      sel.parentNode.insertBefore(g, sel.nextSibling);
      g.appendChild(clone);
      clone.classList.add('ai-selected');
      return;
    }
    sel.parentNode.insertBefore(clone, sel.nextSibling);
    $$('.ai-selected', svg).forEach(n => n.classList.remove('ai-selected'));
    clone.classList.add('ai-selected');
  }

  function attachSnap(){
    if (!svg) return;
    svg.addEventListener('mouseup', (e) => {
      if (!strongSnap) return;
      const target = e.target.closest('.ai-selected, [data-draggable]');
      if (!target || target === svg) return;
      try {
        const bbox = (target.getBBox ? target.getBBox() : null);
        const v = vb(); if (!bbox || !v) return;
        let dx=0, dy=0;
        const leftDist = Math.abs(bbox.x - v.x);
        const rightDist = Math.abs((bbox.x + bbox.width) - (v.x + v.width));
        const topDist = Math.abs(bbox.y - v.y);
        const bottomDist = Math.abs((bbox.y + bbox.height) - (v.y + v.height));
        if (leftDist < SNAP_TOL) dx = -leftDist; else if (rightDist < SNAP_TOL) dx = -rightDist;
        if (topDist < SNAP_TOL) dy = -topDist; else if (bottomDist < SNAP_TOL) dy = -bottomDist;
        if (dx!==0 || dy!==0) {
          if (target.hasAttribute('transform')) {
            const tr = target.getAttribute('transform') || '';
            target.setAttribute('transform', tr + ` translate(${dx},${dy})`);
          } else if (target.hasAttribute('x') || target.hasAttribute('y')) {
            const x = Number(target.getAttribute('x')||0)+dx;
            const y = Number(target.getAttribute('y')||0)+dy;
            target.setAttribute('x', x); target.setAttribute('y', y);
          } else if (target.tagName.toLowerCase() !== 'g') {
            const g = document.createElementNS('http://www.w3.org/2000/svg','g');
            g.setAttribute('transform', `translate(${dx},${dy})`);
            target.parentNode.insertBefore(g, target);
            g.appendChild(target);
          }
        }
      } catch(err){}
    }, true);
  }

  function drawMeterGrid(){
    if (!svg) return;
    const old = $('#aiMeterGrid', svg); if (old && old.parentNode) old.parentNode.removeChild(old);
    const v = vb(); if (!v) return;
    const px = cellPx();
    const meterPx = px * 2; // 1 m = 2 celdas (0,5 m por celda)

    const g = document.createElementNS('http://www.w3.org/2000/svg','g');
    g.setAttribute('id','aiMeterGrid');
    g.setAttribute('pointer-events','none');
    g.setAttribute('opacity','0.4');

    const totalM_W = Math.round(v.width / meterPx);
    const totalM_H = Math.round(v.height / meterPx);

    for (let m=0; m<=totalM_W; m++){
      const x = v.x + m * meterPx;
      const line = document.createElementNS('http://www.w3.org/2000/svg','line');
      line.setAttribute('x1', x); line.setAttribute('y1', v.y);
      line.setAttribute('x2', x); line.setAttribute('y2', v.y + v.height);
      line.setAttribute('stroke', m%5===0 ? '#222' : '#777');
      line.setAttribute('stroke-width', m%5===0 ? '1.0' : '0.6');
      line.setAttribute('stroke-dasharray', m%5===0 ? '' : '6 6');
      g.appendChild(line);

      const label = document.createElementNS('http://www.w3.org/2000/svg','text');
      label.setAttribute('x', x + 2);
      label.setAttribute('y', v.y + 11);
      label.setAttribute('font-size','9');
      label.setAttribute('fill', m%5===0 ? '#222' : '#555');
      label.textContent = `${m} m`;
      g.appendChild(label);
    }

    for (let m=0; m<=totalM_H; m++){
      const y = v.y + m * meterPx;
      const line = document.createElementNS('http://www.w3.org/2000/svg','line');
      line.setAttribute('x1', v.x); line.setAttribute('y1', y);
      line.setAttribute('x2', v.x + v.width); line.setAttribute('y2', y);
      line.setAttribute('stroke', m%5===0 ? '#222' : '#777');
      line.setAttribute('stroke-width', m%5===0 ? '1.0' : '0.6');
      line.setAttribute('stroke-dasharray', m%5===0 ? '' : '6 6');
      g.appendChild(line);

      const label = document.createElementNS('http://www.w3.org/2000/svg','text');
      label.setAttribute('x', v.x + 4);
      label.setAttribute('y', y - 2);
      label.setAttribute('font-size','9');
      label.setAttribute('fill', m%5===0 ? '#222' : '#555');
      label.textContent = `${m} m`;
      g.appendChild(label);
    }

    // Insertar como primer hijo para quedar detr√°s de todo
    if (svg.firstChild) svg.insertBefore(g, svg.firstChild); else svg.appendChild(g);
  }

  function applyLotMeters(){
    if (!svg) return alert('No se encontr√≥ el lienzo.');
    let wm = parseFloat(($('#aiLotW')||{}).value||'');
    let hm = parseFloat(($('#aiLotH')||{}).value||'');
    if (!isFinite(wm) || !isFinite(hm)) { alert('Ingres√° ancho y largo en metros.'); return; }
    // Paso 0.5, m√≠nimo 2
    wm = Math.max(2, Math.round(wm*2)/2);
    hm = Math.max(2, Math.round(hm*2)/2);
    (document.getElementById('aiLotW')||{}).value = wm;
    (document.getElementById('aiLotH')||{}).value = hm;

    const px = cellPx();         // px por celda (0,5 m)
    const wpx = (wm/0.5)*px;     // 2 celdas por metro
    const hpx = (hm/0.5)*px;
    svg.setAttribute('viewBox', `0 0 ${wpx} ${hpx}`);

    try { window.dispatchEvent(new Event('lotSizeChanged')); } catch(e){}
    drawMeterGrid();
    updateMetersBadge();
  }

  function ready(fn){ (document.readyState !== 'loading') ? fn() : document.addEventListener('DOMContentLoaded', fn); }

  ready(() => {
    // Wire metros inputs
    const w=$('#aiLotW'), h=$('#aiLotH'), b=$('#aiApplyLot');
    if (b) b.addEventListener('click', applyLotMeters);
    [w,h].forEach(el => el && el.addEventListener('keydown', e => { if (e.key==='Enter'){ e.preventDefault(); applyLotMeters(); }}));

    // Wire acciones
    const btnDup = $('#aiBtnDuplicate'); if (btnDup) {
      btnDup.addEventListener('click', duplicateSelection);
      document.addEventListener('keydown', (e) => { if ((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='d'){ e.preventDefault(); duplicateSelection(); }});
    }
    const btnExp = $('#aiBtnExport'); if (btnExp) btnExp.addEventListener('click', exportPNG);
    const btnPrices = $('#aiBtnPrices'); if (btnPrices) btnPrices.addEventListener('click', openModal);

    // Modal precios
    const pass=$('#aiPass'), unlock=$('#aiUnlock'), form=$('#aiForm'), save=$('#aiSave'), reset=$('#aiReset');
    let prices = readPrices(); buildPricesForm(prices);
    function setUnlocked(v){ form.classList.toggle('ai-hidden', !v); save.disabled = !v; form.querySelectorAll('input').forEach(inp=>{ inp.disabled=!v; inp.readOnly=!v; }); }
    if (unlock && pass) unlock.addEventListener('click', () => { (pass.value===PASS) ? setUnlocked(true) : alert('Contrase√±a incorrecta.'); });
    if (form) form.addEventListener('input', (e) => {
      const input = e.target; if (!(input instanceof HTMLInputElement)) return;
      const path = input.dataset.path?.split('.') || []; let cursor = prices;
      for (let i=0; i<path.length-1; i++){ const key = path[i]; cursor[key] = cursor[key] || {}; cursor = cursor[key]; }
      const last = path[path.length-1]; cursor[last] = Number(input.value);
    });
    if (save) save.addEventListener('click', () => { writePrices(prices); alert('Precios actualizados.'); closeModal(); });
    if (reset) reset.addEventListener('click', () => { localStorage.removeItem(STORAGE_KEY); prices = readPrices(); buildPricesForm(prices); alert('Valores restablecidos.'); });
    const close = $('#aiModalClose'); const backdrop = $('#aiModalBackdrop');
    if (close && backdrop){ close.addEventListener('click', closeModal); backdrop.addEventListener('click', (e) => { if (e.target===backdrop) closeModal(); }); }

    attachSelection(); attachSnap();
    toolLabelUpdate(); updateMetersBadge(); drawMeterGrid();

    // Forzar ocultar la grilla de celdas ante cualquier re-render
    const hideCells = () => {
      const g = $('#grid, [data-grid=\"true\"]');
      if (g) { g.style.display='none'; g.style.visibility='hidden'; g.style.opacity='0'; }
    };
    hideCells();
    // Si el proyecto dispara eventos, mantener badge y grilla consistentes
    window.addEventListener('resize', () => { drawMeterGrid(); updateMetersBadge(); });
    window.addEventListener('lotSizeChanged', () => { drawMeterGrid(); updateMetersBadge(); });
    window.addEventListener('toolChanged', toolLabelUpdate);
  });

  async function exportPNG(){
    if (!svg) { alert('No se encontr√≥ el lienzo SVG.'); return; }
    const clone = svg.cloneNode(true);
    clone.removeAttribute('class'); clone.removeAttribute('style');
    const v = vb(); if (!v) { alert('El lienzo no tiene viewBox definido.'); return; }
    const w = v.width, h = v.height;
    clone.setAttribute('width', w); clone.setAttribute('height', h);
    clone.setAttribute('xmlns','http://www.w3.org/2000/svg');
    const ser = new XMLSerializer().serializeToString(clone);
    const blob = new Blob([ser], {type:'image/svg+xml;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const img = new Image();
    await new Promise((res, rej) => { img.onload = () => res(); img.onerror = rej; img.src = url; });
    const canvas = document.createElement('canvas'); canvas.width = Math.ceil(w); canvas.height = Math.ceil(h);
    const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0);
    URL.revokeObjectURL(url);
    const pngURL = canvas.toDataURL('image/png');
    const a = document.createElement('a');
    const ts = new Date().toISOString().replace(/[:.]/g,'-');
    a.download = `dali_configurador_${ts}.png`; a.href = pngURL; a.click();
  }
})();
</script>
<!-- ===== END AI ENHANCEMENTS ===== -->
<script>
(function(){
  const $  = (s,r=document)=>r.querySelector(s);
  const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));

  // A) Controles: aplicar clases para spacing
  (function fixControls(){
    const btn = $$('button, input[type="button"]').find(b=>{
      const t=(b.textContent||b.value||'').toLowerCase();
      return t.includes('rotar 90') || t.includes('espejar h') || t.includes('espejar v');
    });
    if(!btn) return;
    const block = btn.closest('div, section, form') || btn.parentElement;
    block.classList.add('ui-controls-grid');
    $$('button, input[type="button"]', block).forEach(el=>{
      const t=(el.textContent||el.value||'').trim();
      if(['‚Üë','‚Üê','‚Üí','‚Üì'].includes(t)) el.classList.add('btn--arrow');
    });
    const next = block.nextElementSibling;
    if(next && next.nodeType===1) next.classList.add('ui-controls-meta');
  })();

  // B) Grilla en metros (ocultar celdas al usuario)
  function findGridUI(){
    const btn = $$('button, input[type="button"], input[type="submit"]').find(b=>{
      const t=(b.textContent||b.value||'').trim().toLowerCase();
      return t.includes('redimensionar');
    });
    if(!btn) return null;
    const container = btn.closest('form, section, div') || document.body;
    const wCells = document.getElementById('gw') || container.querySelectorAll('input[type="number"]')[0];
    const hCells = document.getElementById('gh') || container.querySelectorAll('input[type="number"]')[1];
    return {container, btn, wCells, hCells};
  }
  function clamp05m(v){ if(!isFinite(v)) return null; v=Math.max(2,v); return Math.round(v*2)/2; }
  function metersToCells(m){ return Math.max(1, Math.round(m*2)); }
  function cellsToMeters(c){ return Math.round(((Number(c)||0)/2)*2)/2; }

  function setLotMetersAndArea(wm, hm){
    const badge = document.getElementById('aiGridMeters');
    if(badge) badge.textContent = `${wm.toFixed(1)} √ó ${hm.toFixed(1)} m`;
    window.getLotMeters = () => ({w: wm, h: hm});
    window.getLotAreaSqm = () => wm*hm;
    try{ window.dispatchEvent(new CustomEvent('lotAreaChanged',{detail:{sqm:wm*hm,w:wm,h:hm}})); }catch(e){}
    ['updateCostSummary','refreshTotals','renderSummary'].forEach(fn=>{ try{ if(typeof window[fn]==='function') window[fn](); }catch(e){} });
  }

  function ensureMetersUI(){
    const ui = findGridUI(); if(!ui) return;
    const {container, btn, wCells, hCells} = ui;

    if(!document.getElementById('aiWm') || !document.getElementById('aiHm')){
      const wrap = document.createElement('div');
      wrap.style.display = 'flex';
      wrap.style.alignItems = 'center';
      wrap.style.gap = '.5rem';
      wrap.style.margin = '.5rem 0 .25rem';
      wrap.innerHTML = `
        <strong style="font:600 13px/1 system-ui">Grilla (m):</strong>
        <input id="aiWm" type="number" step="0.5" min="2" placeholder="Ancho (m)" style="width:88px;padding:.25rem .4rem;border:1px solid rgba(0,0,0,.15);border-radius:8px">
        <span style="font:700 12px/1 system-ui;opacity:.8">√ó</span>
        <input id="aiHm" type="number" step="0.5" min="2" placeholder="Profundidad (m)" style="width:88px;padding:.25rem .4rem;border:1px solid rgba(0,0,0,.15);border-radius:8px">
      `;
      (wCells || container).parentNode.insertBefore(wrap, (wCells || btn));
    }
    const Wm = document.getElementById('aiWm');
    const Hm = document.getElementById('aiHm');

    const initWm = clamp05m(wCells ? cellsToMeters(wCells.value||0) : 6);
    const initHm = clamp05m(hCells ? cellsToMeters(hCells.value||0) : 6);
    Wm.value = initWm; Hm.value = initHm;
    if (wCells) wCells.value = metersToCells(initWm);
    if (hCells) hCells.value = metersToCells(initHm);
    setLotMetersAndArea(initWm, initHm);

    function syncMeters(){
      let wm = clamp05m(parseFloat(Wm.value));
      let hm = clamp05m(parseFloat(Hm.value));
      if (wm==null || hm==null) return;
      Wm.value = wm; Hm.value = hm;
      if (wCells) wCells.value = metersToCells(wm);
      if (hCells) hCells.value = metersToCells(hm);
      setLotMetersAndArea(wm, hm);
    }
    Wm.addEventListener('input',  syncMeters);
    Hm.addEventListener('input',  syncMeters);
    Wm.addEventListener('change', syncMeters);
    Hm.addEventListener('change', syncMeters);
    [Wm,Hm].forEach(el=> el.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); btn.click(); }}));
    btn.addEventListener('click', ()=>{ syncMeters(); }, true);
  }

  if(document.readyState!=='loading') ensureMetersUI();
  else document.addEventListener('DOMContentLoaded', ensureMetersUI);
})();
</script>
<script>
/* ========== PATCH: Medianeras autom√°ticas ‚Üí costo como "medianeras fijas" ==========
   Qu√© hace:
   - Detecta "medianeras" en el SVG (l√≠neas o rects) marcadas con:
       data-role="medianera"  √≥  class="medianera"  √≥  data-typology*="medianera"
   - Convierte su largo a METROS (usa 1 m = 2 celdas = 2 * data-cell px, fallback 48 px por celda).
   - Expone helpers:
       window.getMedianeraMeters()     -> metros totales
       window.getMedianeraCost()       -> costo = metros * prices.medianeraPerM
       window.setMedianeraMeters(m)    -> setter manual (si tipolog√≠as ya lo calculan)
   - Integra al costeo: intenta actualizar elementos comunes:
       #cost-medianeras-fijas, .cost-medianeras, [data-cost="medianeras"]
       y suma al total si existe #cost-total, .js-cost-total, [data-field="costTotal"]
   - No rompe tu updateCostSummary(). Si existe, lo envolvemos para que re-calculen
     primero tus costos y luego agreguemos el extra de medianeras.
*/
(function(){
  const $  = (s,r=document)=>r.querySelector(s);
  const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
  const svg= $('svg, #canvas, [data-canvas="svg"]');
  const CELL_PX_DEFAULT = 48; // 0.5 m por celda (misma convenci√≥n previa)

  function cellPx(){
    const gridEl = $('#grid,[data-grid="true"]');
    const v = Number(gridEl?.getAttribute('data-cell') || CELL_PX_DEFAULT);
    return (isFinite(v) && v>0) ? v : CELL_PX_DEFAULT;
  }
  function pxToMeters(px){ const pxPerMeter = cellPx()*2; return px / pxPerMeter; }

  // --- Heur√≠stica de detecci√≥n ---
  function isMedianeraEl(el){
    if(!(el instanceof Element)) return false;
    const c = (el.getAttribute('class')||'').toLowerCase();
    const r = (el.getAttribute('data-role')||'').toLowerCase();
    const t = (el.getAttribute('data-typology')||'').toLowerCase();
    return c.includes('medianera') || r.includes('medianera') || t.includes('medianera');
  }

  function lineLenPx(el){
    const x1=Number(el.getAttribute('x1')||0), y1=Number(el.getAttribute('y1')||0);
    const x2=Number(el.getAttribute('x2')||0), y2=Number(el.getAttribute('y2')||0);
    const dx=x2-x1, dy=y2-y1;
    return Math.sqrt(dx*dx + dy*dy);
  }

  function rectLenPx(el){
    const w=Math.abs(Number(el.getAttribute('width')||0));
    const h=Math.abs(Number(el.getAttribute('height')||0));
    // Si es una franja delgada, tomamos el lado mayor como "largo"
    return Math.max(w,h);
  }

  function sumMedianerasMetersFromSVG(){
    if(!svg) return 0;
    let meters = 0;
    // <line>
    $$('line', svg).forEach(el=>{
      if(!isMedianeraEl(el)) return;
      meters += pxToMeters(lineLenPx(el));
    });
    // <rect>
    $$('rect', svg).forEach(el=>{
      if(!isMedianeraEl(el)) return;
      meters += pxToMeters(rectLenPx(el));
    });
    // Otros nodos (path): no calculamos por defecto; pueden setearse con setMedianeraMeters()
    return meters;
  }

  // --- Estado y helpers p√∫blicos ---
  let manualMeters = null; // si se usa setter expl√≠cito desde tipolog√≠as
  window.setMedianeraMeters = (m)=>{ manualMeters = Math.max(0, Number(m)||0); updateMedianeraCosts(); };
  window.getMedianeraMeters = ()=> (manualMeters!=null ? manualMeters : sumMedianerasMetersFromSVG());

  // Precio por metro (nuevo campo si no existe)
  function ensurePriceField(){
    const fallback = 45; // precio default por metro (ajustalo si quer√©s otro)
    if(!window.CFG) window.CFG = {};
    if(!window.CFG.prices) window.CFG.prices = {};
    if(typeof window.CFG.prices.medianeraPerM !== 'number'){
      window.CFG.prices.medianeraPerM = fallback;
    }
    return window.CFG.prices.medianeraPerM;
  }

  window.getMedianeraCost = ()=>{
    const perM = ensurePriceField();
    return window.getMedianeraMeters() * perM;
  };

  // --- Pintar en UI y sumar a total si hay total ---
  function fmt(n){ return (Math.round(n*100)/100).toFixed(2); }
  function updateMedianeraCosts(){
    const perM = ensurePriceField();
    const m = window.getMedianeraMeters();
    const cost = m * perM;

    // Escribir en campos est√°ndar si existen
    const lineTargets = ['#cost-medianeras-fijas', '.cost-medianeras', '[data-cost="medianeras"]'];
    const metersTargets = ['#meters-medianeras', '.meters-medianeras', '[data-meters="medianeras"]'];
    lineTargets.forEach(sel => $$(sel).forEach(el => {
      if('value' in el) el.value = fmt(cost);
      else el.textContent = fmt(cost);
    }));
    metersTargets.forEach(sel => $$(sel).forEach(el => {
      if('value' in el) el.value = fmt(m);
      else el.textContent = fmt(m);
    }));

    // Sumar al total si tenemos un campo total com√∫n
    const totalEls = ['#cost-total', '.js-cost-total', '[data-field="costTotal"]'];
    totalEls.forEach(sel => {
      $$(sel).forEach(el => {
        // Intentamos leer n√∫mero actual y sumarle el extra
        const raw = ('value' in el) ? (el.value||'') : (el.textContent||'');
        const num = parseFloat(String(raw).replace(/[^0-9.,-]/g,'').replace(',','.')) || 0;
        const newVal = num + cost;
        if('value' in el) el.value = fmt(newVal);
        else el.textContent = fmt(newVal);
      });
    });
  }

  // --- Integraci√≥n con updateCostSummary si existe ---
  const origUpdate = (typeof window.updateCostSummary === 'function') ? window.updateCostSummary : null;
  window.updateCostSummary = function(){
    if(origUpdate) { try{ origUpdate(); }catch(e){} }
    updateMedianeraCosts();
  };

  // Reaccionar a cambios t√≠picos
  ['typologyChanged','lotSizeChanged','medianerasChanged'].forEach(ev => {
    window.addEventListener(ev, ()=>{ updateMedianeraCosts(); });
  });

  // Observador por si agregan/quitan medianeras en el DOM
  if (svg && 'MutationObserver' in window){
    const mo = new MutationObserver(()=>{ updateMedianeraCosts(); });
    mo.observe(svg, {childList:true, subtree:true, attributes:true, attributeFilter:['class','data-role','data-typology','x1','y1','x2','y2','width','height']});
  }

  // Primera corrida
  ensurePriceField();
  updateMedianeraCosts();
})();
</script>
<script>
/* ===== Robust medianeras cost integration (v2) =====
   - Detecta <line>, <rect>, <path>, y nodos con id/class/data-role/data-typology que contengan "medianera".
   - Convierte a METROS usando escala real del viewBox (preferente) o fallback 1m=2 celdas (48px por celda).
   - Suma al costeo con prices.medianeraPerM (se crea si falta).
   - Enlazado fuerte con updateCostSummary() y eventos t√≠picos.
*/
(function(){
  const $  = (s,r=document)=>r.querySelector(s);
  const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
  const svg = $('svg, #canvas, [data-canvas="svg"]');
  if(!svg) return;

  // ===== Escalas a metros =====
  function metersPerUnit(){
    const vb = svg.viewBox && svg.viewBox.baseVal ? svg.viewBox.baseVal : null;
    if(!vb) return null;
    // Preferimos helpers si existen (definen metros reales del lote)
    if (typeof window.getLotMeters === 'function'){
      try{
        const lot = window.getLotMeters(); // {w,h}
        const sx = lot.w / vb.width;
        const sy = lot.h / vb.height;
        // asumimos escala uniforme -> promedio
        return (sx + sy) / 2;
      }catch(_){}
    }
    // Fallback: 1m = 2 celdas, 1 celda = data-cell px (o 48)
    const gridEl = $('#grid,[data-grid="true"]');
    const cellPx = Number(gridEl?.getAttribute('data-cell') || 48) || 48;
    const pxPerMeter = cellPx * 2;
    return 1 / pxPerMeter; // metros por px
  }

  function isMedianeraEl(el){
    if(!(el instanceof Element)) return false;
    const id = (el.getAttribute('id')||'').toLowerCase();
    const cls = (el.getAttribute('class')||'').toLowerCase();
    const role = (el.getAttribute('data-role')||'').toLowerCase();
    const typ = (el.getAttribute('data-typology')||'').toLowerCase();
    const tag = el.tagName.toLowerCase();
    // Tambi√©n aceptamos data-type, data-tag, data-kind
    const dt  = (el.getAttribute('data-type')||'').toLowerCase();
    const dtag= (el.getAttribute('data-tag')||'').toLowerCase();
    const dk  = (el.getAttribute('data-kind')||'').toLowerCase();
    const hit = s => s.includes('medianera') || s.includes('partywall') || s.includes('median');
    return hit(id) || hit(cls) || hit(role) || hit(typ) || hit(dt) || hit(dtag) || hit(dk) || tag==='medianera';
  }

  function lengthUnits(el){
    const tag = el.tagName.toLowerCase();
    if(tag==='line'){
      const x1=Number(el.getAttribute('x1')||0), y1=Number(el.getAttribute('y1')||0);
      const x2=Number(el.getAttribute('x2')||0), y2=Number(el.getAttribute('y2')||0);
      const dx=x2-x1, dy=y2-y1;
      return Math.hypot(dx,dy);
    }
    if(tag==='rect'){
      const w=Math.abs(Number(el.getAttribute('width')||0));
      const h=Math.abs(Number(el.getAttribute('height')||0));
      return Math.max(w,h);
    }
    if(tag==='path' && el.getTotalLength){
      try { return el.getTotalLength(); } catch(_){ return 0; }
    }
    // Si es un <g> medianera, sumamos hijos
    if(tag==='g'){
      let sum=0;
      el.querySelectorAll('line,rect,path').forEach(ch=> sum += lengthUnits(ch));
      return sum;
    }
    return 0;
  }

  // Precio por metro garantizado
  function ensurePrice(){
    if(!window.CFG) window.CFG = {};
    if(!window.CFG.prices) window.CFG.prices = {};
    if(typeof window.CFG.prices.medianeraPerM !== 'number'){
      window.CFG.prices.medianeraPerM = 45; // default, ajustable
    }
    return window.CFG.prices.medianeraPerM;
  }

  // Estado manual opcional
  let manualMeters = null;
  window.setMedianeraMeters = (m)=>{ manualMeters = Math.max(0, Number(m)||0); scheduleUpdate(); };
  window.getMedianeraMeters = ()=>{
    if(manualMeters!=null) return manualMeters;
    const k = metersPerUnit();
    if(!k) return 0;
    let sum = 0;
    // Buscamos elementos calificados
    const candidates = $$('line, rect, path, g', svg).filter(isMedianeraEl);
    candidates.forEach(el => sum += lengthUnits(el) * k);
    return sum;
  };
  window.getMedianeraCost = ()=> window.getMedianeraMeters() * ensurePrice();

  // UI wiring: si existen elementos est√°ndar, pintamos
  function fmt(n){ return (Math.round(n*100)/100).toFixed(2); }
  function applyToTargets(selList, text){
    selList.forEach(sel => $$(sel).forEach(el => {
      if('value' in el) el.value = text;
      else el.textContent = text;
    }));
  }
  function render(){
    const m = window.getMedianeraMeters();
    const perM = ensurePrice();
    const cost = m * perM;

    applyToTargets(['#meters-medianeras','.meters-medianeras','[data-meters="medianeras"]'], fmt(m));
    applyToTargets(['#cost-medianeras-fijas','.cost-medianeras','[data-cost="medianeras"]'], fmt(cost));

    // Si hay total conocido, lo incrementamos (sin conocer su breakdown)
    ['#cost-total','.js-cost-total','[data-field="costTotal"]'].forEach(sel=>{
      $$(sel).forEach(el=>{
        const raw = ('value' in el ? el.value : el.textContent) || '0';
        const num = parseFloat(String(raw).replace(/[^0-9.,-]/g,'').replace(',','.')) || 0;
        const next = num + cost;
        if('value' in el) el.value = fmt(next);
        else el.textContent = fmt(next);
      });
    });
  }

  // Integraci√≥n fuerte con updateCostSummary
  const orig = (typeof window.updateCostSummary === 'function') ? window.updateCostSummary : null;
  window.updateCostSummary = function(){
    if(orig) { try{ orig(); }catch(e){ console.warn('updateCostSummary original fall√≥:', e); } }
    try { render(); } catch(e){ console.warn('medianeras render error:', e); }
  };

  // Scheduler simple para evitar demasiados c√°lculos
  let rafId = 0;
  function scheduleUpdate(){
    if(rafId) cancelAnimationFrame(rafId);
    rafId = requestAnimationFrame(()=>{
      rafId = 0;
      try { window.updateCostSummary(); } catch(e){}
    });
  }

  // Observers / eventos que disparan rec√°lculo
  ['DOMContentLoaded','load','resize','typologyChanged','lotSizeChanged','medianerasChanged','lotAreaChanged']
    .forEach(ev => window.addEventListener(ev, scheduleUpdate, {passive:true}));

  if('MutationObserver' in window){
    const mo = new MutationObserver(scheduleUpdate);
    mo.observe(svg, {childList:true, subtree:true, attributes:true, attributeFilter:['class','id','data-role','data-typology','data-type','data-tag','data-kind','x1','y1','x2','y2','width','height','d']});
  }

  // Primera corrida
  scheduleUpdate();
})();
</script>
<!-- ===== Badge visible de medianeras en la barra (si falta) ===== -->
<style>
  .ai-badge{display:inline-flex;align-items:center;gap:.4rem;padding:.25rem .55rem;border-radius:999px;font:600 12px/1 system-ui;background:#111;color:#fff;opacity:.95}
  .ai-badge--secondary{background:#2a2a2a}
</style>
<script>
(function(){
  const $  = (s,r=document)=>r.querySelector(s);
  const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));

  // Inserta un badge para visualizar metros y costo de medianeras
  function ensureMedianeraBadges(){
    const bar = document.getElementById('aiBar') || document.querySelector('.ai-bar') || document.body;
    if(!bar) return;
    if(!document.getElementById('aiMedianeraBadge')){
      const wrap = document.createElement('div');
      wrap.style.display='flex'; wrap.style.gap='.5rem'; wrap.style.alignItems='center'; wrap.style.marginLeft='.5rem';
      wrap.innerHTML = `
        <span id="aiMedianeraBadge" class="ai-badge ai-badge--secondary" title="Medianeras detectadas">Med: 0.00 m</span>
        <span id="aiMedianeraCostBadge" class="ai-badge ai-badge--secondary" title="Costo medianeras">$ 0.00</span>
      `;
      // Insertamos cerca de los dem√°s badges si existen
      const badges = bar.querySelector('.ai-badges') || bar.firstElementChild || bar;
      badges.parentNode.insertBefore(wrap, badges.nextSibling);
    }
  }

  // Integramos la versi√≥n robusta si a√∫n no est√°
  if(!window.__medianerasV3){
    window.__medianerasV3 = true;

    function metersPerUnit(){
      const svg = document.querySelector('svg, #canvas, [data-canvas="svg"]');
      const vb = svg && svg.viewBox && svg.viewBox.baseVal ? svg.viewBox.baseVal : null;
      if(!vb) return null;
      if (typeof window.getLotMeters === 'function'){
        try{
          const lot = window.getLotMeters(); // {w,h}
          const sx = lot.w / vb.width;
          const sy = lot.h / vb.height;
          return (sx + sy) / 2;
        }catch(_){}
      }
      const gridEl = document.querySelector('#grid,[data-grid="true"]');
      const cellPx = Number(gridEl?.getAttribute('data-cell') || 48) || 48;
      const pxPerMeter = cellPx * 2;
      return 1 / pxPerMeter;
    }

    function isMedianeraEl(el){
      const id = (el.getAttribute('id')||'').toLowerCase();
      const cls = (el.getAttribute('class')||'').toLowerCase();
      const role = (el.getAttribute('data-role')||'').toLowerCase();
      const typ = (el.getAttribute('data-typology')||'').toLowerCase();
      const dt  = (el.getAttribute('data-type')||'').toLowerCase();
      const dtag= (el.getAttribute('data-tag')||'').toLowerCase();
      const dk  = (el.getAttribute('data-kind')||'').toLowerCase();
      const tag = (el.tagName||'').toLowerCase();
      const hit = s => s.includes('medianera') || s.includes('partywall') || s.includes('median');
      return hit(id)||hit(cls)||hit(role)||hit(typ)||hit(dt)||hit(dtag)||hit(dk)||tag==='medianera';
    }
    function lengthUnits(el){
      const tag = (el.tagName||'').toLowerCase();
      if(tag==='line'){
        const x1=Number(el.getAttribute('x1')||0), y1=Number(el.getAttribute('y1')||0);
        const x2=Number(el.getAttribute('x2')||0), y2=Number(el.getAttribute('y2')||0);
        return Math.hypot(x2-x1, y2-y1);
      }
      if(tag==='rect'){
        const w=Math.abs(Number(el.getAttribute('width')||0));
        const h=Math.abs(Number(el.getAttribute('height')||0));
        return Math.max(w,h);
      }
      if(tag==='path' && el.getTotalLength){ try{ return el.getTotalLength(); }catch(e){ return 0; } }
      if(tag==='g'){ let sum=0; el.querySelectorAll('line,rect,path').forEach(ch=> sum+=lengthUnits(ch)); return sum; }
      return 0;
    }

    function ensurePrice(){
      if(!window.CFG) window.CFG = {};
      if(!window.CFG.prices) window.CFG.prices = {};
      if(typeof window.CFG.prices.medianeraPerM !== 'number'){
        window.CFG.prices.medianeraPerM = 45; // default si no existe
      }
      return window.CFG.prices.medianeraPerM;
    }

    window.setMedianeraMeters = (m)=>{ window.__medianeraManual = Math.max(0, Number(m)||0); scheduleUpdate(); };
    window.getMedianeraMeters = ()=>{
      if(window.__medianeraManual!=null) return window.__medianeraManual;
      const k = metersPerUnit(); if(!k) return 0;
      const svg = document.querySelector('svg, #canvas, [data-canvas="svg"]'); if(!svg) return 0;
      let sum = 0;
      svg.querySelectorAll('line, rect, path, g').forEach(el=>{ if(isMedianeraEl(el)) sum += lengthUnits(el)*k; });
      return sum;
    };
    window.getMedianeraCost = ()=> window.getMedianeraMeters()*ensurePrice();

    function fmt(n){ return (Math.round(n*100)/100).toFixed(2); }
    function applyToTargets(selList, text){
      selList.forEach(sel => $$(sel).forEach(el => {
        if('value' in el) el.value = text; else el.textContent = text;
      }));
    }
    function render(){
      ensureMedianeraBadges();
      const m = window.getMedianeraMeters();
      const perM = ensurePrice();
      const cost = m * perM;

      const mBadge = $('#aiMedianeraBadge');
      const cBadge = $('#aiMedianeraCostBadge');
      if(mBadge) mBadge.textContent = `Med: ${fmt(m)} m`;
      if(cBadge) cBadge.textContent = `$ ${fmt(cost)}`;

      applyToTargets(['#meters-medianeras','.meters-medianeras','[data-meters="medianeras"]'], fmt(m));
      applyToTargets(['#cost-medianeras-fijas','.cost-medianeras','[data-cost="medianeras"]'], fmt(cost));

      const totalSelectors = [
        '#cost-total', '.js-cost-total', '[data-field="costTotal"]',
        '.total', '.total-value', '.sum-total', '[data-total]'
      ];
      totalSelectors.forEach(sel=>{
        $$(sel).forEach(el=>{
          // Si el total tiene atributo data-base-total, lo usamos como base "sin medianeras"
          let base = el.getAttribute('data-base-total');
          let num;
          if(base!=null){
            num = parseFloat(String(base).replace(/[^0-9.,-]/g,'').replace(',','.')) || 0;
          }else{
            const raw = ('value' in el ? el.value : el.textContent) || '0';
            num = parseFloat(String(raw).replace(/[^0-9.,-]/g,'').replace(',','.')) || 0;
            // Guardamos como base para no duplicar al siguiente render
            el.setAttribute('data-base-total', num.toString());
          }
          const next = num + cost;
          if('value' in el) el.value = fmt(next);
          else el.textContent = fmt(next);
        });
      });
    }

    const orig = (typeof window.updateCostSummary === 'function') ? window.updateCostSummary : null;
    window.updateCostSummary = function(){
      if(orig){ try{ orig(); }catch(e){} }
      render();
    };

    let rafId=0;
    function scheduleUpdate(){
      if(rafId) cancelAnimationFrame(rafId);
      rafId = requestAnimationFrame(()=>{ rafId=0; try{ window.updateCostSummary(); }catch(e){} });
    }

    ['DOMContentLoaded','load','resize','typologyChanged','lotSizeChanged','medianerasChanged','lotAreaChanged']
      .forEach(ev => window.addEventListener(ev, scheduleUpdate, {passive:true}));

    const svgEl = document.querySelector('svg, #canvas, [data-canvas="svg"]');
    if('MutationObserver' in window && svgEl){
      const mo = new MutationObserver(scheduleUpdate);
      mo.observe(svgEl, {childList:true, subtree:true, attributes:true, attributeFilter:['class','id','data-role','data-typology','data-type','data-tag','data-kind','x1','y1','x2','y2','width','height','d']});
    }

    ensureMedianeraBadges();
    scheduleUpdate();
  }
})();
</script>
</div>
<script>
(function(){
  function move(sel, targetId, appendParent=false){
    var el = document.querySelector(sel);
    var target = document.getElementById(targetId);
    if(el && target){
      if(appendParent) target.appendChild(el);
      else while(el.firstChild){ target.appendChild(el.firstChild); }
    }
  }
  var root = document.getElementById('layout3');
  var btn = document.getElementById('toggleCompact');
  if(btn) btn.addEventListener('click', function(){ root.classList.toggle('compact-off'); });

  // 1) Mover barra AI si existe
  var aiBar = document.getElementById('aiBar');
  if(aiBar){
    document.querySelector('.app-topbar').appendChild(aiBar);
  }

  // 2) Mover lienzo: usamos el .gridwrap que contiene toolbar + svg
  var gridwrap = document.querySelector('.right .gridwrap');
  if(gridwrap){
    document.getElementById('canvasMount').appendChild(gridwrap);
  } else {
    // fallback: mover #svg solo
    var svg = document.getElementById('svg');
    if(svg) document.getElementById('canvasMount').appendChild(svg);
  }

  // 3) Mover resumen: la card que contiene #summary
  var summaryCard = null;
  var sum = document.getElementById('summary');
  if(sum){
    summaryCard = sum.closest('.card') || sum;
    document.getElementById('rightMountBottom').appendChild(summaryCard);
  }

  // 4) Mover panel izquierdo (todas las secciones/controles/elementos)
  var leftCard = document.querySelector('.left.card');
  if(leftCard){
    var mount = document.getElementById('leftMount');
    while(leftCard.firstChild){ mount.appendChild(leftCard.firstChild); }
    // eliminar contenedor vac√≠o
    leftCard.remove();
  }

  // 5) Sticky headers dentro de paneles
  document.querySelectorAll('.pane h3').forEach(function(h){
    h.style.position='sticky'; h.style.top='0'; h.style.background='#fff'; h.style.zIndex='2'; h.style.padding='6px 0';
  });
})();
</script>
<script>
(function(){
  // ---- Helpers to read/set sides ----
  function setSide(k, val){
    var el = document.querySelector('input[data-side="'+k+'"]');
    if(el){ el.checked = !!val; el.dispatchEvent(new Event('change', {bubbles:true})); }
  }
  function setSidesMap(map){
    ['A','B','C','D'].forEach(function(k){ setSide(k, !!map[k]); });
  }
  function currentLotType(){ var el=document.getElementById('lotType'); return el? el.value : 'isla'; }
  function currentOrient(){
    var el=document.getElementById('lotOrient');
    var v = el? el.value : null;
    if(!v){
      // default orientation per type
      var t = currentLotType();
      if(t==='punta') v='AB';
      else if(t==='peninsula' || t==='medianeras') v='A';
    }
    return v;
  }

  // ---- Enforce rules regardless of internal implementation ----
  function enforceSides(){
    try{
      var t = currentLotType();
      var o = currentOrient();
      if(t==='isla'){
        setSidesMap({A:false,B:false,C:false,D:false});
      }else if(t==='peninsula'){
        // exactly one medianera: the orientation letter
        var m = {A:false,B:false,C:false,D:false}; if(o) m[o]=true; setSidesMap(m);
      }else if(t==='punta'){
        // orientation AB/BC/CD/DA = FRONTS; medianeras are the other two
        var fronts = {}; (o||'AB').split('').forEach(function(k){ fronts[k]=true; });
        var m = {A:false,B:false,C:false,D:false};
        ['A','B','C','D'].forEach(function(k){ if(!fronts[k]) m[k]=true; });
        setSidesMap(m);
      }else if(t==='medianeras'){
        // exactly three: all except the "front" (orientation)
        var front = o || 'A';
        var m = {A:true,B:true,C:true,D:true}; m[front]=false; setSidesMap(m);
      }
    }catch(e){ /* no-op */ }
  }

  // ---- Ensure correct default on first change to 'punta' ----
  document.addEventListener('change', function(e){
    if(e && e.target && e.target.id==='lotType'){
      // If changing to 'punta' and lotOrient empty, set AB then enforce
      var t = currentLotType();
      if(t==='punta'){
        var lo = document.getElementById('lotOrient');
        if(lo && !lo.value){ lo.value='AB'; }
      }
      setTimeout(enforceSides, 0);
    }else if(e && e.target && e.target.id==='lotOrient'){
      setTimeout(enforceSides, 0);
    }
  }, true);

  // Run once after load
  window.addEventListener('load', function(){ setTimeout(enforceSides, 60); });

  // ---- Costs: default + unlock + persist ----
  try{
    window.CFG = window.CFG || {}; CFG.prices = CFG.prices || {};
    if(typeof CFG.prices.medianeraPerM !== 'number') CFG.prices.medianeraPerM = 45;
  }catch(e){}

  function isUnlocked(){ try{ return localStorage.getItem('cfg_costs_unlock')==='1'; } catch(_){ return false; } }
  function setUnlocked(v){ try{ localStorage.setItem('cfg_costs_unlock', v? '1':'0'); } catch(_){ } }

  function showCostPanel(){
    var panel = document.getElementById('costPanel'); if(panel) panel.style.display='block';
    var input = document.getElementById('medianeraPrice2');
    if(input){
      input.disabled = false;
      input.value = String((CFG && CFG.prices && typeof CFG.prices.medianeraPerM==='number') ? CFG.prices.medianeraPerM : 45);
      input.oninput = function(){
        var v = parseFloat(this.value); if(!isFinite(v)) v = 0;
        window.CFG = window.CFG || {}; CFG.prices = CFG.prices || {};
        CFG.prices.medianeraPerM = v;
        if(typeof window.scheduleUpdate==='function') scheduleUpdate(); else if(typeof window.render==='function') render();
      };
    }
  }

  document.addEventListener('click', function(e){
    var btn = e.target && (e.target.id==='unlockCosts'? e.target : (e.target.closest && e.target.closest('#unlockCosts')));
    if(!btn) return;
    if(isUnlocked()){ showCostPanel(); return; }
    var k = prompt('Ingres√° la clave de edici√≥n de costos:');
    if(k==='dalicfg'){ setUnlocked(true); showCostPanel(); }
    else if(k!=null){ alert('Clave incorrecta'); }
  }, true);

  window.addEventListener('load', function(){
    if(isUnlocked()) showCostPanel();
  });
})();
</script>

<script>
(function(){
  var PASS = 'dalicfg';
  function isUnlocked(){ try{ return localStorage.getItem('cfg_costs_unlock')==='1'; } catch(_){ return false; } }
  function setUnlocked(v){ try{ localStorage.setItem('cfg_costs_unlock', v? '1':'0'); } catch(_){ } }

  function showCostPanel(){
    var panel = document.getElementById('costPanel'); if(panel) panel.style.display='block';
    var input = document.getElementById('medianeraPrice2');
    if(input){
      input.disabled = false;
      var v = (window.CFG && CFG.prices && typeof CFG.prices.medianeraPerM==='number') ? CFG.prices.medianeraPerM : 45;
      input.value = String(v);
      input.oninput = function(){
        var nv = parseFloat(this.value); if(!isFinite(nv)) nv = 0;
        window.CFG = window.CFG || {}; CFG.prices = CFG.prices || {};
        CFG.prices.medianeraPerM = nv;
        if(typeof window.scheduleUpdate==='function') scheduleUpdate(); else if(typeof window.render==='function') render();
      };
    }
  }

  function revealUnlockRow(){
    var row = document.getElementById('unlockRow');
    if(row){ row.style.display = 'flex'; }
    var p = document.getElementById('unlockPass');
    if(p){ p.value=''; p.focus(); }
  }

  function tryUnlock(){
    var p = document.getElementById('unlockPass');
    var val = p ? p.value : '';
    if(val === PASS){
      setUnlocked(true);
      var row = document.getElementById('unlockRow'); if(row) row.style.display='none';
      showCostPanel();
    }else{
      alert('Clave incorrecta');
    }
  }

  // Button clicks
  document.addEventListener('click', function(e){
    var btn = e.target && (e.target.id==='unlockCosts' ? e.target : (e.target.closest && e.target.closest('#unlockCosts')));
    if(btn){
      if(isUnlocked()){ showCostPanel(); } else { revealUnlockRow(); }
      return;
    }
    if(e.target && e.target.id==='unlockGo'){ tryUnlock(); return; }
  }, true);

  // Enter to submit password
  document.addEventListener('keydown', function(e){
    if(e.key === 'Enter'){
      var row = document.getElementById('unlockRow');
      if(row && row.style.display!=='none'){ tryUnlock(); }
    }
    // Shortcut Ctrl+Shift+K to toggle unlock row
    if(e.key.toLowerCase() === 'k' && e.ctrlKey && e.shiftKey){
      e.preventDefault();
      if(isUnlocked()){ showCostPanel(); }
      else revealUnlockRow();
    }
  });

  // Auto-open if previously unlocked
  window.addEventListener('load', function(){
    if(isUnlocked()) showCostPanel();
  });
})();
</script>

<script>
(function(){
  // Add dblclick on summary title area to reveal unlock row (in case button is obstructed)
  var sum = document.getElementById('summary');
  if(sum){
    sum.addEventListener('dblclick', function(e){
      var row = document.getElementById('unlockRow');
      if(row && row.style.display==='none'){
        row.style.display='flex';
        var p = document.getElementById('unlockPass'); if(p) p.focus();
      }
    });
  }

  // Alt + C toggles unlock row if locked, opens panel if unlocked
  document.addEventListener('keydown', function(e){
    if(e.altKey && (e.key.toLowerCase()==='c')){
      e.preventDefault();
      try{
        var unlocked = (localStorage.getItem('cfg_costs_unlock')==='1');
        if(unlocked){
          var panel = document.getElementById('costPanel'); if(panel) panel.style.display='block';
        }else{
          var row = document.getElementById('unlockRow'); if(row) row.style.display='flex';
          var p = document.getElementById('unlockPass'); if(p) p.focus();
        }
      }catch(_){}
    }
  });
})();
</script>

<!-- Floating Costos FAB + Modal -->
<style>
  #costsFab{
    position:fixed; right:16px; bottom:16px; z-index:2147483647;
    padding:10px 14px; border-radius:999px; background:#111; color:#fff; font:600 14px/1 system-ui;
    box-shadow:0 6px 24px rgba(0,0,0,.25); cursor:pointer; user-select:none;
  }
  #costsFab:hover{ opacity:.9 }
  #costsOverlay{
    position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:2147483646; display:none;
  }
  #costsModal{ max-height:92vh; overflow:auto;
    position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
    background:#fff; color:#111; border-radius:14px; padding:16px; width:min(92vw,380px);
    box-shadow:0 10px 40px rgba(0,0,0,.35); z-index:2147483647; display:none;
    font:500 14px/1.35 system-ui;
  }
  #costsModal h3{ margin:0 0 8px 0; font:700 16px/1.2 system-ui }
  #costsModal .row{ margin:8px 0; display:flex; align-items:center; gap:8px; }
  #costsModal input[type="number"], #costsModal input[type="password"]{
    width:140px; padding:6px 8px; border:1px solid #ddd; border-radius:8px;
  }
  #costsModal .btn{ padding:8px 10px; border-radius:8px; background:#111; color:#fff; border:none; cursor:pointer; }
  #costsModal .btn.secondary{ background:#2a2a2a }
  #costsClose{ position:absolute; right:10px; top:10px; background:transparent; border:none; cursor:pointer; font-size:18px }
</style>
<div id="costsFab">‚öôÔ∏é Costos</div>
<div id="costsOverlay"></div>
<div id="costsModal" role="dialog" aria-modal="true" aria-label="Editor de costos">
  <button id="costsClose" title="Cerrar">√ó</button>
  <h3>Editor de costos</h3>
  <div id="costsLock" class="row">
    <input id="costsPass" type="password" placeholder="Clave (p.ej. dalicfg)" />
    <button id="costsUnlock" class="btn">Desbloquear</button>
  </div>
  <div id="costsContent" style="display:none"><div id="costsDyn">
  <div id="aiPlanoItemsBlock" style="margin-top:6px">
    <div class="row"><strong>ELEMENTOS DEL PLANO</strong></div>

    <div class="card" style="padding:8px; margin:6px 0">
      <div class="row"><strong>TABIQUES</strong></div>
      <div class="row" style="gap:8px"><label>Panel 1.00 m (2 celdas)</label><input type="number" data-price-key="panel100" style="width:120px"/></div>
      <div class="row" style="gap:8px"><label>Panel 0.50 m (1 celda)</label><input type="number" data-price-key="panel50" style="width:120px"/></div>
      <div class="row" style="gap:8px"><label>Esquinero 0.50√ó0.50</label><input type="number" data-price-key="corner50" style="width:120px"/></div>
      <div class="row" style="gap:8px"><label>Puerta (1.00 m)</label><input type="number" data-price-key="puerta" style="width:120px"/></div>
      <div class="row" style="gap:8px"><label>Vidrio 1.00 m</label><input type="number" data-price-key="vidrio" style="width:120px"/></div>
      <div class="row" style="gap:8px"><label>Columna 0.50√ó0.50 (1√ó1)</label><input type="number" data-price-key="columna50" style="width:120px"/></div>
      <div class="row" style="gap:8px"><label>Columna √ò0.40 (en 1√ó1)</label><input type="number" data-price-key="columna40c" style="width:120px"/></div>
    </div>

    <div class="card" style="padding:8px; margin:6px 0">
      <div class="row"><strong>TECNOLOGIA</strong></div>
      <div class="row" style="gap:8px"><label>LED Wall (0.50√ó0.50)</label><input type="number" data-price-key="led" style="width:120px"/></div>
      <div class="row" style="gap:8px"><label>Pantalla 48&quot; (1.00√ó0.20)</label><input type="number" data-price-key="p48" style="width:120px"/></div>
      <div class="row" style="gap:8px"><label>Pantalla 55&quot; (1.20√ó0.20)</label><input type="number" data-price-key="p55" style="width:120px"/></div>
      <div class="row" style="gap:8px"><label>Pantalla 65&quot; (1.40√ó0.20)</label><input type="number" data-price-key="p65" style="width:120px"/></div>
    </div>

    <div class="card" style="padding:8px; margin:6px 0">
      <div class="row"><strong>MOBILIARIO</strong></div>
      <div class="row" style="gap:8px"><label>Mostrador 1.00 (2√ó1)</label><input type="number" data-price-key="counter" style="width:120px"/></div>
      <div class="row" style="gap:8px"><label>Mostrador 0.50 (1√ó1)</label><input type="number" data-price-key="counter50" style="width:120px"/></div>
      <div class="row" style="gap:8px"><label>Banqueta (0.4√ó0.4)</label><input type="number" data-price-key="banqueta" style="width:120px"/></div>
      <div class="row" style="gap:8px"><label>Sill√≥n 2 cuerpos (2√ó1)</label><input type="number" data-price-key="sofa2" style="width:120px"/></div>
      <div class="row" style="gap:8px"><label>Sill√≥n 1 cuerpo (1√ó1)</label><input type="number" data-price-key="sofa1" style="width:120px"/></div>
    </div>

    <div class="card" style="padding:8px; margin:6px 0">
      <div class="row"><strong>TORRES</strong></div>
      <div class="row" style="gap:8px"><label>Torre 3.0 m (1√ó0.5 = 2√ó1)</label><input type="number" data-price-key="torre3" style="width:120px"/></div>
      <div class="row" style="gap:8px"><label>Torre 3.5 m (1√ó0.5 = 2√ó1)</label><input type="number" data-price-key="torre35" style="width:120px"/></div>
      <div class="row" style="gap:8px"><label>Torre 4.0 m (1√ó0.5 = 2√ó1)</label><input type="number" data-price-key="torre4" style="width:120px"/></div>
      <div class="row" style="gap:8px"><label>Torre 4.5 m (1√ó0.5 = 2√ó1)</label><input type="number" data-price-key="torre45" style="width:120px"/></div>
      <div class="row" style="gap:8px"><label>Torre 5.0 m (1√ó0.5 = 2√ó1)</label><input type="number" data-price-key="torre5" style="width:120px"/></div>
      <div class="row" style="gap:8px"><label>Torre 5.5 m (1√ó0.5 = 2√ó1)</label><input type="number" data-price-key="torre55" style="width:120px"/></div>
      <div class="row" style="gap:8px"><label>Torre 6.0 m (1√ó0.5 = 2√ó1)</label><input type="number" data-price-key="torre6" style="width:120px"/></div>
    </div>

    <div class="card" style="padding:8px; margin:6px 0">
      <div class="row"><strong>CENEFA</strong></div>
      <div class="row" style="gap:8px"><label>Cenefa apoyada 1.00 m</label><input type="number" data-price-key="cenefaApo100" style="width:120px"/></div>
      <div class="row" style="gap:8px"><label>Cenefa apoyada 0.50 m</label><input type="number" data-price-key="cenefaApo50" style="width:120px"/></div>
      <div class="row" style="gap:8px"><label>Cenefa suspendida 1.00 m</label><input type="number" data-price-key="cenefaSus100" style="width:120px"/></div>
      <div class="row" style="gap:8px"><label>Cenefa suspendida 0.50 m</label><input type="number" data-price-key="cenefaSus50" style="width:120px"/></div>
    </div>

    <div class="card" style="padding:8px; margin:6px 0">
      <div class="row"><strong>EXTRAS</strong></div>
      <div class="row" style="gap:8px"><label>Audio</label><input type="number" data-price-key="audio" style="width:120px"/></div>
      <div class="row" style="gap:8px"><label>Pack de iluminaci√≥n</label><input type="number" data-price-key="lightPack" style="width:120px"/></div>
      <div class="row" style="gap:8px"><label>Alfombra ($/m¬≤)</label><input type="number" data-path="floor.carpet" style="width:120px"/></div>
<div class="row" style="gap:8px"><label>Doble placa + alfombra ($/m¬≤)</label><input type="number" data-path="floor.lowAggCarpet" style="width:120px"/></div>
<div class="row" style="gap:8px"><label>Doble placa acabado melamina ($/m¬≤)</label><input type="number" data-path="floor.lowMelamine" style="width:120px"/></div>
<div class="row" style="gap:8px"><label>Tarima 10 cm modular ($/m¬≤)</label><input type="number" data-path="floor.highModular" style="width:120px"/></div>
      <div class="row" style="gap:8px"><label>Vinilo mate ($/m¬≤)</label><input type="number" data-path="graphics.vinilo" style="width:120px"/></div>
<div class="row" style="gap:8px"><label>Lona mate ($/m¬≤)</label><input type="number" data-path="graphics.lona" style="width:120px"/></div>
<div class="row" style="gap:8px"><label>Esmerilado ($/m¬≤)</label><input type="number" data-path="graphics.esmerilado" style="width:120px"/></div>
      <div class="row" style="gap:8px"><label>Pantalla LED en medianera ($/m)</label><input type="number" data-price-key="pantallaMedianeraPerM" style="width:120px"/></div>
          <div class="row" style="gap:8px"><label>Trabajo m√≠nimo (fijo)</label><input type="number" data-price-key="laborMinFixed" style="width:120px"/></div>
    </div>
  </div>
</div>
    <div class="row">
      <label>Precio medianera ($/m)</label>
      <input id="costsMedianera" type="number" inputmode="decimal" step="1" min="0" />
    </div>
    <div class="row" style="justify-content:flex-end">
      <button id="costsSave" class="btn">Guardar</button>
      <button id="costsRelock" class="btn secondary">Bloquear</button>
          <div class="row" style="gap:8px"><label>Trabajo m√≠nimo (fijo)</label><input type="number" data-price-key="laborMinFixed" style="width:120px"/></div>
    </div>
  </div>
</div>
<script>
(function(){
  var PASS = 'dalicfg';
  function isUnlocked(){ try{ return localStorage.getItem('cfg_costs_unlock')==='1'; }catch(_){ return false; } }
  function setUnlocked(v){ try{ localStorage.setItem('cfg_costs_unlock', v?'1':'0'); }catch(_){ } }

  function ensureDefaults(){
    try{
      window.CFG = window.CFG || {}; CFG.prices = CFG.prices || {};
      if(typeof CFG.prices.medianeraPerM !== 'number') CFG.prices.medianeraPerM = 45;
    }catch(e){}
  }
  function openModal(){
    document.getElementById('costsOverlay').style.display='block';
    document.getElementById('costsModal').style.display='block';
    refreshModal();
  }
  function closeModal(){
    document.getElementById('costsOverlay').style.display='none';
    document.getElementById('costsModal').style.display='none';
  }
  function refreshModal(){
    ensureDefaults();
    var locked = !isUnlocked();
    document.getElementById('costsLock').style.display = locked ? 'flex' : 'none';
    document.getElementById('costsContent').style.display = locked ? 'none' : 'block';
    if(!locked){
      var v = (CFG && CFG.prices && typeof CFG.prices.medianeraPerM==='number') ? CFG.prices.medianeraPerM : 45;
      var inp = document.getElementById('costsMedianera'); inp.value = String(v);
      setTimeout(function(){ try{ inp.focus(); inp.select && inp.select(); }catch(_){ } }, 0);
    }else{
      var p = document.getElementById('costsPass'); p.value=''; setTimeout(function(){ try{ p.focus(); }catch(_){ } }, 0);
    }
  }
  function saveCosts(){
    var inp = document.getElementById('costsMedianera');
    var v = parseFloat(inp.value); if(!isFinite(v)) v = 0;
    window.CFG = window.CFG || {}; CFG.prices = CFG.prices || {};
    CFG.prices.medianeraPerM = v;
    if(typeof window.scheduleUpdate==='function') scheduleUpdate();
    else if(typeof window.render==='function') render();
    closeModal();
  }

  // Events
  document.getElementById('costsFab').addEventListener('click', openModal);
  document.getElementById('costsOverlay').addEventListener('click', closeModal);
  document.getElementById('costsClose').addEventListener('click', closeModal);
  document.getElementById('costsUnlock').addEventListener('click', function(){
    var val = (document.getElementById('costsPass').value||'').trim();
    if(val===PASS){ setUnlocked(true); refreshModal(); }
    else alert('Clave incorrecta');
  });
  document.getElementById('costsRelock').addEventListener('click', function(){
    setUnlocked(false); refreshModal();
  });
  document.getElementById('costsSave').addEventListener('click', saveCosts);

  // Keyboard: Esc closes; Ctrl+Shift+K opens
  document.addEventListener('keydown', function(e){
    if(e.key==='Escape'){ closeModal(); }
    if(e.key && e.key.toLowerCase()==='k' && e.ctrlKey && e.shiftKey){ openModal(); }
  });

  // First load: ensure defaults; if previously unlocked, keep it unlocked
  ensureDefaults();
  if(isUnlocked()) { /* stay unlocked */ }
})();</script>

<script>
(function(){
  function ensurePrices(){
    window.CFG = window.CFG || {}; CFG.prices = CFG.prices || {};
    if(typeof CFG.prices.medianeraPerM !== 'number') CFG.prices.medianeraPerM = 45;
  }
  function buildField(name, value, path){
  // Translate internal keys to friendly labels
  var NAME_MAP = {
    floor: 'Tarima (por tipo)',
    graphicsPerM2: 'Gr√°fica impresa (m¬≤)',
    medianeraPerM: 'Precio medianera ($/m)',
    pantallaMedianeraPerM: 'Pantalla sobre medianera ($/m)',
    module: 'M√≥dulo',
    totem: 'T√≥tem',
    audio: 'Audio',
    lightPack: 'Pack de iluminaci√≥n',
    raPack: 'Rack Pack',
    counter: 'Mostrador 1.00 (2√ó1)',
    counter50: 'Mostrador 0.50 (1√ó1)',
    banqueta: 'Banqueta (0.4√ó0.4)',
    led: 'LED Wall (0.50√ó0.50)'
  };
  var display = NAME_MAP[name] || name;
  var wrap = document.createElement('div'); wrap.className='row';
  var label = document.createElement('label'); label.textContent = display;
  var input = document.createElement('input'); input.type='number'; input.step='1'; input.min='0'; input.inputMode='decimal'; input.style.width='120px';
  input.value = String(value);
  input.dataset.path = path;
  wrap.appendChild(label); wrap.appendChild(input);
  return wrap;
}
  function buildGroup(name){
    var g = document.createElement('div'); g.className='card'; g.style.padding='8px'; g.style.margin='6px 0';
    var h = document.createElement('div'); h.className='row'; h.innerHTML = '<strong>'+name+'</strong>';
    g.appendChild(h);
    return g;
  }
  function setByPath(obj, path, val){
    var parts = path.split('.'); var ref = obj;
    for(var i=0;i<parts.length-1;i++){ var k=parts[i]; if(!(k in ref) || typeof ref[k]!=='object') ref[k] = {}; ref = ref[k]; }
    ref[parts[parts.length-1]] = val;
  }
  function getPricesFlat(){
    ensurePrices();
    var out = {};
    function walk(prefix, o){
      Object.keys(o).forEach(function(k){
        var v = o[k];
        if(v && typeof v === 'object' && !Array.isArray(v)){
          walk(prefix? (prefix+'.'+k): k, v);
        }else if(typeof v === 'number'){
          out[(prefix? (prefix+'.'+k): k)] = v;
        }
      });
    }
    walk('', CFG.prices);
    return out;
  }
  function renderDynEditor(){
  var host = document.getElementById('costsDyn'); if(!host) return;
  host.innerHTML = '';

  // helpers
  function ensurePrices(){
    window.CFG = window.CFG || {}; CFG.prices = CFG.prices || {}; CFG.prices.items = CFG.prices.items || {};
  }
  function currentPrice(key){
    ensurePrices();
    if (typeof CFG.prices.items[key] === 'number') return CFG.prices.items[key];
    if (typeof CFG.prices[key] === 'number') return CFG.prices[key];
    return 0;
  }
  function row(label, key){
    var r = document.createElement('div'); r.className = 'row'; r.style.gap='8px';
    var lab = document.createElement('label'); lab.textContent = label;
    var inp = document.createElement('input'); inp.type='number'; inp.step='1'; inp.min='0'; inp.inputMode='decimal'; inp.style.width='120px';
    inp.value = String(currentPrice(key)); inp.dataset.priceKey = key;
    r.appendChild(lab); r.appendChild(inp); return r;
  }
  function card(title){ var c=document.createElement('div'); c.className='card'; c.style.padding='8px'; c.style.margin='6px 0';
    var h=document.createElement('div'); h.className='row'; h.innerHTML='<strong>'+title+'</strong>'; c.appendChild(h); return c; }

  // === 5 grupos del PLANO (desde GROUPS) ===
  var order = ['tabiques','tecnologia','mobiliario','torres','cenefas'];
  order.forEach(function(gname){
    var items = (window.GROUPS && GROUPS[gname]) ? GROUPS[gname] : []; if(items.length===0) return;
    var title = (gname==='tabiques'?'TABIQUES': gname==='tecnologia'?'TECNOLOGIA': gname==='mobiliario'?'MOBILIARIO': gname==='torres'?'TORRES':'CENEFA');
    var c = card(title);
    items.forEach(function(it){ c.appendChild(row(it.label, it.key)); });
    host.appendChild(c);
  });

  // === EXTRAS expl√≠citos (filtrados) ===
  var extras = card('EXTRAS');
  var EXTRA_LIST = [
    {key:'audio', label:'Audio'},
    {key:'lightPack', label:'Pack de iluminaci√≥n'},
    {key:'floor', label:'Piso / Tarima ($/m¬≤)'},
    {key:'graphicsPerM2', label:'Gr√°fica (m¬≤)'},
    {key:'medianeraPerM', label:'Precio medianera ($/m)'},
    {key:'pantallaMedianeraPerM', label:'Pantalla LED en medianera ($/m)'}
  ];
  EXTRA_LIST.forEach(function(x){ if(typeof currentPrice(x.key) === 'number'){ extras.appendChild(row(x.label, x.key)); } });
  host.appendChild(extras);

  // Input binding ‚Üí guarda overrides y refresca resumen/presupuesto
  host.addEventListener('input', function(e){
    var t = e.target; if(!t || !t.dataset || !t.dataset.priceKey) return;
    var v = parseFloat(t.value); if(!isFinite(v)) v = 0;
    ensurePrices(); CFG.prices.items[t.dataset.priceKey] = v;
    
    // Mirror 'laborMinFixed' into CFG.prices.root for compatibility
    try{ if(t.dataset.priceKey==='laborMinFixed'){ CFG.prices.laborMinFixed = v; } }catch(_){}
    // Persist the whole structure if writePrices exists, otherwise fallback to localStorage
    try{
      if(typeof writePrices==='function'){ writePrices(Object.assign({}, CFG.prices, CFG.prices.items||{})); }
      else if(typeof localStorage!=='undefined'){
        var KEY = (typeof STORAGE_KEY!=='undefined' && STORAGE_KEY) ? STORAGE_KEY : 'dali_cfg_prices_v1';
        var merged = {};
        try{ Object.assign(merged, CFG.prices||{}); Object.assign(merged, (CFG.prices&&CFG.prices.items)||{}); }catch(_){}
        localStorage.setItem(KEY, JSON.stringify(merged));
      }
    }catch(_){}
    try{ if(typeof window.scheduleUpdate==='function') scheduleUpdate(); else if(typeof window.render==='function') render(); }catch(_){}
    try{ if(typeof window.applyMedianeraCost==='function') applyMedianeraCost(); }catch(_){}
  }, {once:false});

// extra refresh for laborMinFixed to ensure summary updates
try{ if(typeof window.updateCostSummary==='function') window.updateCostSummary(); }catch(_){}
try{ if(typeof window.render==='function') window.render(); }catch(_){}

}
functionfunction parseNumberLike(s){
    var n = parseFloat(String(s).replace(/[^0-9.,-]/g,'').replace(',','.'));
    return isFinite(n) ? n : 0;
  }
  function formatNum(n){
    return (Math.round(n)===n) ? String(n) : (Math.round(n*100)/100).toFixed(2);
  }
  function getMedianeraMetersSafe(){
    try{
      if(typeof window.getMedianeraMeters === 'function') return window.getMedianeraMeters();
      return 0;
    }catch(_){ return 0; }
  }
  function applyMedianeraCost(){
    try{
      ensurePrices();
      var m = getMedianeraMetersSafe();
      var perM = (CFG && CFG.prices && typeof CFG.prices.medianeraPerM==='number') ? CFG.prices.medianeraPerM : 0;
      var cost = m * perM;

      var sum = document.getElementById('summary');
      if(sum){
        var line = document.getElementById('aiMedianeraLine');
        if(!line){
          line = document.createElement('div'); line.id='aiMedianeraLine';
          line.className='row'; line.style.marginTop='4px';
          sum.appendChild(line);
        }
        line.textContent = 'Medianeras fijas: ' + formatNum(m) + ' m √ó $' + formatNum(perM) + ' = $ ' + formatNum(cost);
      }

      var selectors = ['#cost-total','.js-cost-total','[data-field="costTotal"]','.total','.total-value','.sum-total','[data-total]'];
      selectors.forEach(function(sel){
        var els = document.querySelectorAll(sel);
        els.forEach(function(el){
          var base = el.getAttribute('data-base-total');
          var num;
          if(base!=null){
            num = parseNumberLike(base);
          }else{
            var raw = ('value' in el ? el.value : el.textContent) || '0';
            num = parseNumberLike(raw);
            el.setAttribute('data-base-total', String(num));
          }
          var next = num + cost;
          if('value' in el) el.value = formatNum(next);
          else el.textContent = formatNum(next);
        });
      });

    }catch(_){}
  }

  var _timer = null;
  function scheduleAiUpdate(){
    clearTimeout(_timer); _timer = setTimeout(function(){
      applyMedianeraCost();
    }, 50);
  }
  var origRender = window.render;
  window.render = function(){ if(origRender) origRender.apply(this, arguments); scheduleAiUpdate(); };
  if(typeof window.scheduleUpdate === 'function'){
    var origSched = window.scheduleUpdate;
    window.scheduleUpdate = function(){ origSched.apply(this, arguments); scheduleAiUpdate(); };
  }
  window.addEventListener('load', function(){
    scheduleAiUpdate();
    var svg = document.querySelector('svg, #svg'); if(svg && window.MutationObserver){
      var mo = new MutationObserver(scheduleAiUpdate);
      mo.observe(svg, {childList:true, subtree:true, attributes:true});
    }
  });

  var costsFab = document.getElementById('costsFab');
  if(costsFab){
    costsFab.addEventListener('click', function(){ setTimeout(renderDynEditor, 0); }, {once:false});
  }
  document.addEventListener('click', function(e){
    if(e && e.target && (e.target.id==='costsUnlock' || e.target.id==='costsSave')){
      setTimeout(function(){ renderDynEditor(); scheduleAiUpdate(); }, 0);
    }
  });
})();
</script>

<script>
(function(){
  try{
    window.CFG = window.CFG || {}; CFG.prices = CFG.prices || {};
    var D = {
      module: 150,
      totem: 250,
      led: 400,
      audio: 120,
      counter: 180,
      counter50: 120,
      banqueta: 60,
      lightPack: 250,
      raPack: 180,
      graphicsPerM2: 30,
      floor: { carpet: 18, lowMelamine: 40, lowAggCarpet: 38, highModular: 65 },
      medianeraPerM: (typeof CFG.prices.medianeraPerM==='number') ? CFG.prices.medianeraPerM : 45,
      pantallaMedianeraPerM: (typeof CFG.prices.pantallaMedianeraPerM==='number') ? CFG.prices.pantallaMedianeraPerM : 110
    };
    function fill(dst, src){
      Object.keys(src).forEach(function(k){
        if(src[k] && typeof src[k]==='object' && !Array.isArray(src[k])){
          if(typeof dst[k] !== 'object' || Array.isArray(dst[k])) dst[k] = {};
          fill(dst[k], src[k]);
        }else if(typeof dst[k] !== 'number'){
          dst[k] = src[k];
        }
      });
    }
    fill(CFG.prices, D);
  }catch(e){}
})();
</script>

<script>
(function(){
  function parseNumberLike(s){
    var n = parseFloat(String(s).replace(/[^0-9.,-]/g,'').replace(',','.'));
    return isFinite(n) ? n : 0;
  }
  function formatNum(n){
    return (Math.round(n)===n) ? String(n) : (Math.round(n*100)/100).toFixed(2);
  }
  function ensurePrices(){
    window.CFG = window.CFG || {}; CFG.prices = CFG.prices || {};
    if(typeof CFG.prices.medianeraPerM!=='number') CFG.prices.medianeraPerM=45;
  }
  function getMedianeraMetersSafe(){
    try{ return (typeof window.getMedianeraMeters==='function') ? window.getMedianeraMeters() : 0; }catch(_){ return 0; }
  }
  window.applyMedianeraCost = function(){
    ensurePrices();
    var m = getMedianeraMetersSafe();
    var perM = (CFG && CFG.prices && typeof CFG.prices.medianeraPerM==='number') ? CFG.prices.medianeraPerM : 0;
    var cost = m * perM;

    var sum = document.getElementById('summary');
    if(sum){
      var line = document.getElementById('aiMedianeraLine');
      if(!line){
        line = document.createElement('div'); line.id='aiMedianeraLine';
        line.className='row'; line.style.marginTop='4px';
        sum.appendChild(line);
      }
      line.textContent = 'Medianeras fijas: ' + formatNum(m) + ' m √ó $' + formatNum(perM) + ' = $ ' + formatNum(cost);
    }

    var selectors = ['#cost-total','.js-cost-total','[data-field="costTotal"]','.total','.total-value','.sum-total','[data-total]'];
    selectors.forEach(function(sel){
      document.querySelectorAll(sel).forEach(function(el){
        var baseAttr = el.getAttribute('data-base-total');
        var medAttr = el.getAttribute('data-med-added');
        var base = (baseAttr!=null) ? parseNumberLike(baseAttr) : (function(){
          var raw = ('value' in el ? el.value : el.textContent) || '0';
          var n = parseNumberLike(raw);
          el.setAttribute('data-base-total', String(n));
          return n;
        })();
        var prev = (medAttr!=null) ? parseNumberLike(medAttr) : 0;
        var next = base - prev + cost;
        el.setAttribute('data-med-added', String(cost));
        if('value' in el) el.value = formatNum(next);
        else el.textContent = formatNum(next);
      });
    });
  };

  // Hook into existing render/scheduleUpdate to call our updater
  var origRender = window.render;
  window.render = function(){ if(origRender) origRender.apply(this, arguments); try{ window.applyMedianeraCost(); }catch(_){ } };
  if(typeof window.scheduleUpdate === 'function'){
    var origSched = window.scheduleUpdate;
    window.scheduleUpdate = function(){ origSched.apply(this, arguments); try{ window.applyMedianeraCost(); }catch(_){ } };
  }
  window.addEventListener('load', function(){ try{ window.applyMedianeraCost(); }catch(_){ } });
})();
</script>

<script>
(function hideTopEditPrices(){
  function tryHide(){
    try{
      var btns = document.querySelectorAll('.app-topbar .btn, .app-topbar button, .app-topbar [role="button"]');
      btns.forEach(function(b){
        var t = (b.textContent||'').trim().toLowerCase();
        if(t.indexOf('editar precios')>=0){ b.style.display='none'; b.id='editPrices'; }
      });
    }catch(_){}
  }
  tryHide();
  if(window.MutationObserver){
    var mo = new MutationObserver(tryHide);
    mo.observe(document.body, {childList:true, subtree:true});
  } else {
    setInterval(tryHide, 800);
  }
})();
</script>

<script>
(function(){
  function parseNumberLike(s){
    var n = parseFloat(String(s).replace(/[^0-9.,-]/g,'').replace(',','.'));
    return isFinite(n) ? n : 0;
  }
  function fmt(n){ return (Math.round(n)===n) ? String(n) : (Math.round(n*100)/100).toFixed(2); }
  function ensurePrices(){
    window.CFG = window.CFG || {}; CFG.prices = CFG.prices || {};
    if(typeof CFG.prices.medianeraPerM!=='number') CFG.prices.medianeraPerM=45;
  }
  function getMedianeraMetersSafe(){
    try{ return (typeof window.getMedianeraMeters==='function') ? window.getMedianeraMeters() : 0; }catch(_){ return 0; }
  }
  function findMedianeraRow(){
    var sum = document.getElementById('summary'); if(!sum) return null;
    var nodes = sum.querySelectorAll('*');
    for(var i=0;i<nodes.length;i++){
      var el = nodes[i];
      var txt = (el.textContent||'').replace(/\s+/g,' ').trim();
      if(/^Medianera \(m\):/i.test(txt)) return el;
    }
    return null;
  }
  function setRightAmount(el, amount){
    if(!el) return;
    var tag = el.querySelector('.ai-cost-right');
    if(!tag){
      tag = document.createElement('span');
      tag.className = 'ai-cost-right';
      tag.style.cssText = 'float:right; font-weight:600;';
      el.appendChild(tag);
    }
    tag.textContent = '$ ' + fmt(amount);
  }
  function applyMedianeraToSummary(){
    ensurePrices();
    var meters = getMedianeraMetersSafe();
    var price = (CFG && CFG.prices && typeof CFG.prices.medianeraPerM==='number') ? CFG.prices.medianeraPerM : 0;
    var cost = meters * price;

    // Update concept row
    var row = findMedianeraRow();
    if(row){ setRightAmount(row, cost); }

    // Adjust total as delta
    var selectors = ['#cost-total','.js-cost-total','[data-field="costTotal"]','.total','.total-value','[data-total]'];
    selectors.forEach(function(sel){
      document.querySelectorAll(sel).forEach(function(el){
        var baseAttr = el.getAttribute('data-base-total');
        var prevAttr = el.getAttribute('data-med-added');
        var base = (baseAttr!=null) ? parseNumberLike(baseAttr) : (function(){
          var raw = ('value' in el ? el.value : el.textContent) || '0';
          var n = parseNumberLike(raw);
          el.setAttribute('data-base-total', String(n));
          return n;
        })();
        var prev = (prevAttr!=null) ? parseNumberLike(prevAttr) : 0;
        var next = base - prev + cost;
        el.setAttribute('data-med-added', String(cost));
        if('value' in el) el.value = fmt(next);
        else el.textContent = '$ ' + fmt(next);
      });
    });
  }

  // Hook
  var origRender = window.render;
  window.render = function(){ if(origRender) origRender.apply(this, arguments); try{ applyMedianeraToSummary(); }catch(_){ } };
  if(typeof window.scheduleUpdate === 'function'){
    var origSched = window.scheduleUpdate;
    window.scheduleUpdate = function(){ origSched.apply(this, arguments); try{ applyMedianeraToSummary(); }catch(_){ } };
  }
  window.addEventListener('load', function(){ try{ applyMedianeraToSummary(); }catch(_){ } });
})();
</script>

<script>
(function(){
  // ==== FIX15: Lista completa de elementos del plano (labels iguales al editor) ====
  function ensurePricesRoot(){
    window.CFG = window.CFG || {}; CFG.prices = CFG.prices || {};
    CFG.prices.items = CFG.prices.items || {};
  }
  function makeGroupCard(title){
    var card = document.createElement('div');
    card.className = 'card'; card.style.padding='8px'; card.style.margin='6px 0';
    var h = document.createElement('div'); h.className='row';
    h.innerHTML = '<strong>'+title+'</strong>';
    card.appendChild(h);
    return card;
  }
  function makeItemRow(label, key, value){
    var row = document.createElement('div'); row.className='row'; row.style.gap='8px';
    var lab = document.createElement('label'); lab.textContent = label;
    var inp = document.createElement('input'); inp.type='number'; inp.step='1'; inp.min='0'; inp.inputMode='decimal'; inp.style.width='120px';
    inp.value = String(value||0);
    inp.dataset.priceKey = key;
    row.appendChild(lab); row.appendChild(inp);
    return row;
  }
  function renderPlanoItems(){
    try{
      ensurePricesRoot();
      var host = document.getElementById('costsDyn'); if(!host) return;
      // Insert a block at the top with items from GROUPS, before existing dynamic groups
      var top = document.createElement('div');
      top.id = 'aiPlanoItemsBlock';
      var title = document.createElement('div'); title.className='row'; title.innerHTML = '<strong>ELEMENTOS DEL PLANO</strong>';
      top.appendChild(title);

      if(typeof window.GROUPS === 'object'){
        ['tabiques','tecnologia','mobiliario','torres','cenefas'].forEach(function(gname){
  var card = makeGroupCard(gname.toUpperCase());
  (GROUPS[gname]||[]).forEach(function(it){
    var key = it.key, label = it.label;
    var v = (CFG.prices.items && typeof CFG.prices.items[key]==='number') ? CFG.prices.items[key] : 0;
    card.appendChild(makeItemRow(label, key, v));
  });
  top.appendChild(card);
});
      }

      // Prepend
      host.insertBefore(top, host.firstChild);

      // Change handler
      top.addEventListener('input', function(e){
        var t = e.target; if(!t || !t.dataset || !t.dataset.priceKey) return;
        var v = parseFloat(t.value); if(!isFinite(v)) v = 0;
        ensurePricesRoot();
        CFG.prices.items[t.dataset.priceKey] = v;
        if(typeof window.scheduleUpdate==='function') scheduleUpdate(); else if(typeof window.render==='function') render();
      });
    }catch(_){}
  }

  // Hook render of dynamic editor if exists
  var onOpen = function(){
    // If costsDyn exists, augment with plano items
    if(document.getElementById('costsDyn')){
      // Avoid duplicating block
      if(!document.getElementById('aiPlanoItemsBlock')) renderPlanoItems();
    }
  };
  // When modal opens via FAB
  var fab = document.getElementById('costsFab');
  if(fab){ fab.addEventListener('click', function(){ setTimeout(onOpen, 0); }); }
  // Also on unlock/save clicks
  document.addEventListener('click', function(e){
    var id = e.target && e.target.id;
    if(id==='costsUnlock' || id==='costsSave'){ setTimeout(onOpen, 0); }
  }, true);
})();
</script>

<script>
(function(){
  function ensure(){ window.CFG=window.CFG||{}; CFG.prices=CFG.prices||{}; CFG.prices.items=CFG.prices.items||{}; }
  function prime(root){
    root.querySelectorAll('input[data-price-key]').forEach(function(inp){
      ensure(); var k=inp.dataset.priceKey;
      var v=(typeof CFG.prices.items[k]==='number')?CFG.prices.items[k]:(typeof CFG.prices[k]==='number'?CFG.prices[k]:0);
      inp.value=String(v||0);
    });
    root.addEventListener('input', function(e){
      var t=e.target; if(!t||!t.dataset) return;
      if(t.dataset.priceKey){
        var v = parseFloat(t.value); if(!isFinite(v)) v=0;
        ensure(); CFG.prices.items[t.dataset.priceKey]=v;
      } else if(t.dataset.path){
        var v = parseFloat(t.value); if(!isFinite(v)) v=0;
        ensure();
        var parts = t.dataset.path.split('.'); var ref = CFG.prices.items; if(!ref) CFG.prices.items={}; ref = CFG.prices.items;
        for(var i=0;i<parts.length-1;i++){ var k=parts[i]; if(!(k in ref) || typeof ref[k] !== 'object') ref[k]={}; ref=ref[k]; }
        ref[parts[parts.length-1]] = v;
      }
       if(!isFinite(v)) v=0; ensure(); CFG.prices.items[t.dataset.priceKey]=v;
      try{ if(typeof window.scheduleUpdate==='function') scheduleUpdate(); else if(typeof window.render==='function') render(); }catch(_){}
    });
  }
  function injectIfNeeded(){ try{ renderDynEditor(); }catch(e){} return true; }
return true;
  }
  // Hook on modal open
  var origOpen = window.openModal;
  window.openModal = function(){ var r = origOpen && origOpen.apply(this, arguments); setTimeout(injectIfNeeded, 0); return r; };
  // Also try when clicking the costos button (by id or text)
  document.addEventListener('click', function(e){
    var id = e.target && e.target.id;
    if(id==='btnCosts' || id==='openCostsBtn' || (e.target.matches && e.target.matches('[data-open=costs]'))) setTimeout(injectIfNeeded, 0);
  }, true);
  // Fallback: run every time DOM changes while modal is visible
  var mo = new MutationObserver(function(){ injectIfNeeded(); });
  mo.observe(document.documentElement, {subtree:true, childList:true});
})();
</script>


<script>
(function(){
  function ensure(){ window.CFG=window.CFG||{}; CFG.prices=CFG.prices||{}; CFG.prices.items=CFG.prices.items||{}; }
  function prime(host){
    ensure();
    host.querySelectorAll('input[data-price-key]').forEach(function(inp){
      var k=inp.dataset.priceKey;
      var v=(typeof CFG.prices.items[k]==='number')?CFG.prices.items[k]:(typeof CFG.prices[k]==='number'?CFG.prices[k]:0);
      inp.value = String(v||0);
    });
    host.querySelectorAll('input[data-path]').forEach(function(inp){
      var path = inp.dataset.path; var v=0; try{
        var parts = path.split('.'); var ref = Object.assign({}, CFG.prices, CFG.prices.items||{});
        for(var i=0;i<parts.length;i++){ ref = ref && ref[parts[i]]; }
        if(typeof ref==='number') v=ref;
      }catch(e){}
      inp.value = String(v||0);
    });
      var v=(typeof CFG.prices.items[k]==='number')?CFG.prices.items[k]:(typeof CFG.prices[k]==='number'?CFG.prices[k]:0);
      inp.value = String(v||0);
    });
    host.addEventListener('input', function(e){
      var t=e.target; if(!t||!t.dataset||!t.dataset.priceKey) return;
      var v=parseFloat(t.value); if(!isFinite(v)) v=0;
      ensure(); CFG.prices.items[t.dataset.priceKey]=v;
      try{ if(typeof window.scheduleUpdate==='function') scheduleUpdate(); else if(typeof window.render==='function') render(); }catch(_){}
      try{ if(typeof window.applyMedianeraCost==='function') applyMedianeraCost(); }catch(_){}
    });
  }
  document.addEventListener('DOMContentLoaded', function(){
    var host=document.getElementById('costsDyn'); if(host) prime(host);
  });
})();
</script>


<script>
(function(){
  function ensure(){ window.CFG=window.CFG||{}; CFG.prices=CFG.prices||{}; CFG.prices.items=CFG.prices.items||{}; }
  function getByPath(path){
    ensure();
    var parts = path.split('.'); var ref = (function(o){ try{ return Object.assign({}, o, o.items||{}); }catch(_){ return o||{}; } })(CFG.prices);
    for(var i=0;i<parts.length;i++){ if(!ref) return 0; ref = ref[parts[i]]; }
    return (typeof ref === 'number') ? ref : 0;
  }
  function setByPath(path, val){
    ensure();
    var parts = path.split('.'); var ref = CFG.prices.items; for(var i=0;i<parts.length-1;i++){ var k=parts[i]; if(!(k in ref) || typeof ref[k] !== 'object') ref[k]={}; ref = ref[k]; }
    ref[parts[parts.length-1]] = val;
  }
  function prime(){
    var host=document.getElementById('costsDyn'); if(!host) return;
    host.querySelectorAll('input[data-path]').forEach(function(inp){
      inp.value = String(getByPath(inp.dataset.path)||0);
    });
    host.addEventListener('input', function(e){
      var t=e.target; if(!t||!t.dataset) return;
      if(t.dataset.path){
        var v=parseFloat(t.value); if(!isFinite(v)) v=0; setByPath(t.dataset.path, v);
        try{ if(typeof window.scheduleUpdate==='function') scheduleUpdate(); else if(typeof window.render==='function') render(); }catch(_){}
        try{ if(typeof window.applyMedianeraCost==='function') applyMedianeraCost(); }catch(_){}
      }
    }, true);
  }
  document.addEventListener('DOMContentLoaded', prime);
})();
</script>


<script>
(function(){
  window.CFG = window.CFG||{}; CFG.prices = CFG.prices||{}; CFG.prices.items = CFG.prices.items||{};
  var base = {"panel100": 90, "panel50": 55, "corner50": 40, "puerta": 180, "vidrio": 150, "columna50": 80, "columna40c": 70, "led": 400, "p48": 120, "p55": 160, "p65": 200, "counter": 180, "counter50": 120, "banqueta": 60, "sofa2": 220, "sofa1": 140, "torre3": 250, "torre35": 270, "torre4": 290, "torre45": 310, "torre5": 330, "torre55": 350, "torre6": 370, "cenefaApo100": 70, "cenefaApo50": 40, "cenefaSus100": 90, "cenefaSus50": 55, "audio": 120, "lightPack": 220, "medianeraPerM": 45, "pantallaMedianeraPerM": 110, "laborMinFixed": 250};
  Object.keys(base).forEach(function(k){ if(typeof (CFG.prices[k])!=='number' && typeof (CFG.prices.items[k])!=='number') CFG.prices[k]=base[k]; });
  CFG.prices.floor = Object.assign({"carpet": 18, "lowAggCarpet": 32, "lowMelamine": 45, "highModular": 65}, CFG.prices.floor||{});
  if(CFG.prices.items.floor) CFG.prices.floor = Object.assign(CFG.prices.floor, CFG.prices.items.floor);
  CFG.prices.graphics = Object.assign({"vinilo": 28, "lona": 24, "esmerilado": 36}, CFG.prices.graphics||{});
  if(CFG.prices.items.graphics) CFG.prices.graphics = Object.assign(CFG.prices.graphics, CFG.prices.items.graphics);
})();
</script>


<script>
// AUTO apply seeded defaults to the budget on load
(function(){
  function go(){
    try{ if(typeof window.scheduleUpdate==='function') scheduleUpdate(); else if(typeof window.render==='function') render(); }catch(_){}
    try{ if(typeof window.applyMedianeraCost==='function') applyMedianeraCost(); }catch(_){}
  }
  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    setTimeout(go, 0);
  } else {
    document.addEventListener('DOMContentLoaded', function(){ setTimeout(go, 0); });
  }
})();
</script>
<!--/*AUTO_REFRESH_AFTER_DEFAULTS*/-->


<script>
/*SEED_FROM_EDITOR_BASE*/
(function(){
  window.CFG = window.CFG||{}; CFG.prices = CFG.prices||{}; CFG.prices.items = CFG.prices.items||{};
  var flat = {"panel100":90,"panel50":55,"corner50":40,"puerta":180,"vidrio":150,"columna50":80,"columna40c":70,
              "led":400,"p48":120,"p55":160,"p65":200,"counter":180,"counter50":120,"banqueta":60,"sofa2":220,"sofa1":140,
              "torre3":250,"torre35":270,"torre4":290,"torre45":310,"torre5":330,"torre55":350,"torre6":370,
              "cenefaApo100":70,"cenefaApo50":40,"cenefaSus100":90,"cenefaSus50":55,
              "audio":120,"lightPack":220,"medianeraPerM":45,"pantallaMedianeraPerM":110,"laborMinFixed":250};
  Object.keys(flat).forEach(function(k){ if(typeof CFG.prices.items[k] !== 'number') CFG.prices.items[k]=flat[k]; });
  CFG.prices.items.floor = Object.assign({"carpet":18,"lowAggCarpet":32,"lowMelamine":45,"highModular":65}, CFG.prices.items.floor||{});
  CFG.prices.items.graphics = Object.assign({"vinilo":28,"lona":24,"esmerilado":36}, CFG.prices.items.graphics||{});
  function prime(){
    var host=document.getElementById('costsDyn'); if(!host) return;
    host.querySelectorAll('input[data-price-key]').forEach(function(inp){ var k=inp.dataset.priceKey; inp.value=String(CFG.prices.items[k]||0); });
    host.querySelectorAll('input[data-path]').forEach(function(inp){
      var parts=inp.dataset.path.split('.'); var ref=CFG.prices.items;
      for(var i=0;i<parts.length;i++){ ref = (ref && typeof ref==='object') ? ref[parts[i]] : undefined; }
      inp.value=String((typeof ref==='number')?ref:0);
    });
    host.addEventListener('input', function(e){
      var t=e.target; if(!t||!t.dataset) return;
      if(t.dataset.priceKey){ var v=parseFloat(t.value); if(!isFinite(v)) v=0; CFG.prices.items[t.dataset.priceKey]=v; }
      if(t.dataset.path){ var v=parseFloat(t.value); if(!isFinite(v)) v=0; var ps=t.dataset.path.split('.'); var r=CFG.prices.items;
        for(var i=0;i<ps.length-1;i++){ var k=ps[i]; if(!(k in r) || typeof r[k]!=='object') r[k]={}; r=r[k]; }
        r[ps[ps.length-1]] = v;
      }
      try{ if(typeof window.scheduleUpdate==='function') scheduleUpdate(); else if(typeof window.render==='function') render(); }catch(_){}
      try{ if(typeof window.applyMedianeraCost==='function') applyMedianeraCost(); }catch(_){}
    }, {once:false});
  }
  if(document.readyState==='complete'||document.readyState==='interactive'){ setTimeout(prime,0); } else { document.addEventListener('DOMContentLoaded', function(){ setTimeout(prime,0); }); }
  function applyNow(){ try{ if(typeof window.scheduleUpdate==='function') scheduleUpdate(); else if(typeof window.render==='function') render(); }catch(_){}
                      try{ if(typeof window.applyMedianeraCost==='function') applyMedianeraCost(); }catch(_){} }
  if(document.readyState==='complete'||document.readyState==='interactive'){ setTimeout(applyNow,0); } else { document.addEventListener('DOMContentLoaded', function(){ setTimeout(applyNow,0); }); }
})();
</script>


<script>
// --- Live prices shim: ALWAYS read from Editor (CFG.prices.items) ---
(function(){
  function mergedPrices(){
    var o = (window.CFG && CFG.prices) || {};
    try {
      var out = Object.assign({}, o, (o && o.items) || {});
      if (o && o.floor){
        out.floor = Object.assign({}, o.floor, (o.items && o.items.floor) || {});
      }
      if (o && o.graphics){
        out.graphics = Object.assign({}, o.graphics, (o.items && o.items.graphics) || {});
      }
      return out;
    } catch(_) { return o || {}; }
  }

  // Make global "p" a live getter so legacy code sees fresh values
  try {
    var _p_store = mergedPrices();
    Object.defineProperty(window, 'p', {
      get: function(){ return mergedPrices(); },
      set: function(v){ _p_store = v; },
      configurable: true
    });
  } catch(_) {}

  // Wrap countsAndCosts so it recomputes right before summing
  function wrapCounts(){
    var orig = window.countsAndCosts;
    if (!orig || orig.__wrappedLivePrices) return;
    function wrapped(){
      try { window.p = mergedPrices(); } catch(_){}
      return orig.apply(this, arguments);
    }
    wrapped.__wrappedLivePrices = true;
    window.countsAndCosts = wrapped;
  }

  // Also wrap render/scheduleUpdate to be safe
  function wrapIf(fnName){
    var fn = window[fnName];
    if (!fn || fn.__wrappedLivePrices) return;
    function wrapped(){
      try { window.p = mergedPrices(); } catch(_){}
      return fn.apply(this, arguments);
    }
    wrapped.__wrappedLivePrices = true;
    window[fnName] = wrapped;
  }

  function init(){
    wrapCounts();
    wrapIf('render');
    wrapIf('scheduleUpdate');
    try { if(typeof window.applyMedianeraCost==='function') wrapIf('applyMedianeraCost'); } catch(_){}
  }

  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    setTimeout(init, 0);
  } else {
    document.addEventListener('DOMContentLoaded', function(){ setTimeout(init, 0); });
  }
})();
</script>


<!-- sync hook for laborMinFixed (no visual change) -->
<script>
(function(){
  try{
    var root = document;
    root.addEventListener('input', function(e){
      var t=e && e.target;
      if(!t || !t.dataset) return;
      if(t.dataset.priceKey === 'laborMinFixed'){
        var v = parseFloat(t.value); if(!isFinite(v)) v = 0;
        window.CFG = window.CFG || {}; CFG.prices = CFG.prices || {}; CFG.prices.items = CFG.prices.items || {};
        CFG.prices.items.laborMinFixed = v;
        CFG.prices.laborMinFixed = v;
        try{ if(typeof writePrices==='function'){ writePrices(Object.assign({}, CFG.prices, CFG.prices.items||{})); } }catch(_){}
        try{ if(typeof render==='function') render(); }catch(_){}
      }
    }, true);
  }catch(_){}
})();
</script>


<script>
(function(){
  // Reforzar sincron√≠a como los otros items
  try{
    var c = document.getElementById('costsDyn') || document;
    c.addEventListener('input', function(ev){
      var t = ev.target;
      if(!t || !t.dataset || t.dataset.priceKey!=='laborMinFixed') return;
      var v = parseFloat(t.value); if(!isFinite(v)) v = 0;
      window.CFG = window.CFG || {}; CFG.prices = CFG.prices || {}; CFG.prices.items = CFG.prices.items || {};
      CFG.prices.items.laborMinFixed = v; // igual que los otros
      try{ if(typeof render==='function') render(); }catch(_){}
    }, true);
  }catch(_){}
})();
</script>


<script id="dali-buttons-js">
(function(){
  function byHeading(text){
    const heads = [...document.querySelectorAll('.sidebar h1, .sidebar h2, .sidebar h3')];
    return heads.find(h => new RegExp('^\s*'+text+'\s*$', 'i').test((h.textContent||'').trim()));
  }

  // 1) Build PACKS rows (label + small qty input)
  function fixPacks(){
    const h = byHeading('PACKS'); if(!h) return;
    const container = document.createElement('div'); container.className = 'packs-section';
    h.insertAdjacentElement('afterend', container);

    // collect blocks until next heading
    const stop = new Set(['H1','H2','H3']);
    let el = container.nextElementSibling;
    while (el && !stop.has(el.tagName)) {
      const input = el.querySelector && el.querySelector('input[type="number"], input[type="text"]');
      const label = el.querySelector && el.querySelector('label');
      if (input && label){
        const row = document.createElement('div'); row.className = 'qty-row';
        row.appendChild(label); row.appendChild(input);
        container.appendChild(row);
        el.remove();
        el = container.nextElementSibling; // restart since DOM changed
        continue;
      }
      el = el.nextElementSibling;
    }
  }

  // 2) Mark element buttons list
  function fixElements(){
    const h = byHeading('HERRAMIENTAS (ELEMENTOS)'); if(!h) return;
    const stop = new Set(['H1','H2','H3']);
    const list = document.createElement('div'); list.className = 'element-list';
    h.insertAdjacentElement('afterend', list);
    let el = list.nextElementSibling;
    while (el && !stop.has(el.tagName)) {
      // move any button-only blocks into the list
      const btn = el.tagName==='BUTTON' ? el : (el.querySelector && el.querySelector('button'));
      if (btn && el.querySelectorAll('button').length<=1) {
        list.appendChild(btn);
        el.remove();
        el = list.nextElementSibling;
        continue;
      }
      el = el.nextElementSibling;
    }
  }

  // 3) Center selection controls row
  function fixControls(){
    const h = byHeading('CONTROLES DE SELECCI√ìN'); if(!h) return;
    let next = h.nextElementSibling;
    const wrap = document.createElement('div'); wrap.className = 'selection-controls';
    h.insertAdjacentElement('afterend', wrap);
    const stop = new Set(['H1','H2','H3']);
    while(next && !stop.has(next.tagName)){
      const buttons = next.querySelectorAll ? next.querySelectorAll('button') : [];
      if(buttons.length){
        buttons.forEach(b=>wrap.appendChild(b));
        next.remove();
        next = wrap.nextElementSibling;
        continue;
      }
      next = next.nextElementSibling;
    }
  }

  window.addEventListener('load', function(){
    // delay to allow any scripts to render
    setTimeout(function(){
      fixPacks();
      fixElements();
      fixControls();
    }, 60);
  });
})();
</script>

<script id="sidebar-packs-stack-js">
(function(){
  // Idempotente y acotado a la barra izquierda
  var left=document.querySelector('.left.card')||document.querySelector('.left');
  if(!left) return;

  // Detectar la secci√≥n PACKS por su encabezado (h3/h4)
  var packsHeader=[].slice.call(left.querySelectorAll('h1,h2,h3,h4')).find(function(h){
    return /packs/i.test((h.textContent||'').normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase());
  });
  if(!packsHeader) return;

  // Recorremos hermanos hasta el pr√≥ximo encabezado y convertimos las filas con input number
  var node=packsHeader.nextElementSibling;
  while(node && !/^(H1|H2|H3|H4)$/i.test(node.tagName)){
    (function(row){
      var input=row && row.querySelector && row.querySelector('input[type="number"]');
      if(!input || row.classList.contains('packs--field')) return;

      // 1) Capturar texto/label existente
      var labelText='';
      var explicit=row.querySelector('label, strong, b, span');
      if(explicit) labelText=(explicit.textContent||'').trim();
      if(!labelText){
        var txt='';
        row.childNodes.forEach(function(n){ if(n.nodeType===3) txt+=(n.nodeValue||'').trim()+' '; });
        labelText=txt.trim();
      }
      if(!labelText) labelText='Pack';

      // 2) Limpiar restos de etiquetas duplicadas (sin tocar el input)
      row.querySelectorAll('label, strong, b, span').forEach(function(n){ if(n!==input) n.remove(); });

      // 3) Aplicar layout vertical
      row.classList.add('packs--field');

      var lab=document.createElement('label');
      lab.className='packs--label';
      lab.textContent=labelText;

      // Insertar label arriba y mover input debajo
      row.insertBefore(lab, row.firstChild);
      input.classList.add('packs--input');
      row.appendChild(input);
    })(node);

    node=node.nextElementSibling;
  }
})();
</script>


<script id="packs-aesthetic-detail-js">
(function(){
  var left=document.querySelector('.left.card')||document.querySelector('.left');
  if(!left) return;
  // Localizar el encabezado PACKS
  var headers=[].slice.call(left.querySelectorAll('h1,h2,h3,h4'));
  var packsH=headers.find(function(h){ return /packs/i.test((h.textContent||'').toLowerCase()); });
  if(!packsH) return;

  var stop=/^(H1|H2|H3|H4)$/i;
  var node=packsH.nextElementSibling;
  while(node && !stop.test(node.tagName)){
    (function(row){
      if(!row.querySelector) return;
      var input=row.querySelector('input[type="number"]');
      if(!input) return;

      // si ya tiene estructura, no volver a aplicar
      if(row.classList.contains('packs--field')) return;

      // Tomar label text
      var labelText='';
      var labelNode=row.querySelector('label, strong, b, span');
      if(labelNode) labelText=(labelNode.textContent||'').trim();
      if(!labelText){
        var t=''; row.childNodes.forEach(function(n){ if(n.nodeType===3) t+=(n.nodeValue||'').trim()+' '; });
        labelText=t.trim();
      }
      if(!labelText) labelText='Pack';

      // Limpiar restos de nodos de texto/label que queden sueltos (sin tocar input)
      row.querySelectorAll('label, strong, b, span').forEach(function(n){ if(n!==input) n.remove(); });

      // Construir estructura
      row.classList.add('packs--field');
      var lab=document.createElement('div'); lab.className='packs--label'; lab.textContent=labelText;
      var div=document.createElement('div'); div.className='packs--divider';
      var wrap=document.createElement('div'); wrap.className='pack-wrap';

      // mover input al wrap
      wrap.appendChild(input);

      // vaciar el row y rearmar
      while(row.firstChild) row.removeChild(row.firstChild);
      row.appendChild(lab);
      row.appendChild(div);
      row.appendChild(wrap);
    })(node);
    node=node.nextElementSibling;
  }
})();
</script>


<!-- Modal cotizaci√≥n (p√∫blico) -->
<div id="quoteModal" style="position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.45);z-index:9999;padding:20px;">
  <div style="width:min(820px,100%);max-height:85vh;overflow:auto;background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:14px;">
    <h3 style="margin:4px 0 10px;font:700 16px system-ui">Enviar dise√±o para cotizaci√≥n</h3>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
      <div>
        <label style="display:block;margin-bottom:6px">Nombre y empresa</label>
        <input id="q_name" placeholder="Nombre / Empresa" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px">
        <label style="display:block;margin:10px 0 6px">Email o WhatsApp</label>
        <input id="q_contact" placeholder="email o +54 9 ..." style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px">
        <label style="display:block;margin:10px 0 6px">Mensaje</label>
        <textarea id="q_msg" rows="5" placeholder="Fecha del evento, ciudad, servicios extra, etc." style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px"></textarea>
      </div>
      <div>
        <div style="font:600 12px system-ui;margin-bottom:6px;opacity:.8">Vista previa del boceto</div>
        <img id="q_preview" style="max-width:100%;border:1px solid #e5e7eb;border-radius:10px">
        <div style="margin-top:8px;font:500 12px system-ui;opacity:.8">Se adjuntar√° la imagen y el JSON del dise√±o.</div>
      </div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px">
      <button id="q_send" class="btn">Enviar</button>
      <button id="q_copyJSON" class="btn">Copiar JSON</button>
      <span id="q_info" style="margin-left:auto;font:500 12px system-ui;opacity:.75"></span>
      <button id="q_close" class="btn">Cerrar</button>
    </div>
  </div>
</div>
<script>
(function(){
  // Buscar el SVG del lienzo (usa id="svg" si existe; si no, primer <svg>)
  function getSVG(){
    return document.getElementById('svg') || document.querySelector('svg');
  }
  // Serializar SVG a PNG (con fondo blanco)
  function svgToPNGDataURL(svgEl, bgColor="#ffffff"){
    const xml = new XMLSerializer().serializeToString(svgEl);
    const svg64 = btoa(unescape(encodeURIComponent(xml)));
    const image64 = "data:image/svg+xml;base64," + svg64;
    return new Promise((resolve, reject)=>{
      const img = new Image();
      img.onload = function(){
        const vb = svgEl.viewBox && svgEl.viewBox.baseVal ? svgEl.viewBox.baseVal : null;
        const w = vb ? vb.width : (svgEl.width && svgEl.width.baseVal ? svgEl.width.baseVal.value : 1200);
        const h = vb ? vb.height : (svgEl.height && svgEl.height.baseVal ? svgEl.height.baseVal.value : 800);
        const canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = bgColor; ctx.fillRect(0,0,w,h);
        ctx.drawImage(img,0,0);
        resolve(canvas.toDataURL('image/png'));
      };
      img.onerror = reject;
      img.src = image64;
    });
  }

  // Construir payload p√∫blico sin costos (intenta leer tus estructuras S/CFG)
  function buildPublicPayload(pngDataURL){
    const lotType = (window.S && S.lotType) || document.getElementById('lotType')?.value || 'isla';
    const gridW = (window.S && S.gridW) || 12;
    const gridH = (window.S && S.gridH) || 12;
    const floor = (window.S && S.floor) || (window.CFG && CFG.floor) || 'carpet';
    const placed = (window.S && S.placed) || (window.S && S.cells) || {};
    const sides = (window.S && S.sides) || {};
    const cenefas = (window.S && S.cenefas) || [];
    return {
      meta:{ app:"Dal√≠ Configurador ‚Äî P√∫blico", ts:new Date().toISOString(), version:"pub-1.0.0" },
      design:{ lotType, gridW, gridH, floor, placed, sides, cenefas },
      preview: pngDataURL
    };
  }

  // Botones
  const btnDownload = document.getElementById('btnDownloadPNG');
  const btnQuote = document.getElementById('btnQuote');
  const modal = document.getElementById('quoteModal');
  const qPrev = document.getElementById('q_preview');
  const qSend = document.getElementById('q_sendMailto');
  const qCopy = document.getElementById('q_copyJSON');
  const qClose = document.getElementById('q_close');
  const qInfo  = document.getElementById('q_info');

  function openModal(){ modal.style.display = 'grid'; }
  function closeModal(){ modal.style.display = 'none'; qInfo.textContent = ''; }

  if(btnDownload){
    btnDownload.addEventListener('click', async function(){
      const svg = getSVG(); if(!svg){ alert('No se encontr√≥ el lienzo SVG'); return; }
      const dataURL = await svgToPNGDataURL(svg);
      const a = document.createElement('a');
      a.href = dataURL; a.download = `boceto_dali_${Date.now()}.png`;
      document.body.appendChild(a); a.click(); a.remove();
    });
  }

  if(btnQuote){
    btnQuote.addEventListener('click', async function(){
      const svg = getSVG(); if(!svg){ alert('No se encontr√≥ el lienzo SVG'); return; }
      const dataURL = await svgToPNGDataURL(svg);
      qPrev.src = dataURL;
      openModal();
    });
  }
  if(qClose){ qClose.addEventListener('click', closeModal); }

  if(qCopy){
    qCopy.addEventListener('click', async function(){
      const svg = getSVG(); if(!svg){ alert('No se encontr√≥ el lienzo SVG'); return; }
      const dataURL = qPrev.src || await svgToPNGDataURL(svg);
      const payload = buildPublicPayload(dataURL);
      await navigator.clipboard.writeText(JSON.stringify(payload, null, 2));
      qInfo.textContent = "JSON copiado ‚úÖ";
      setTimeout(()=> qInfo.textContent = "", 1800);
    });
  }

  if(qSend){
    qSend.addEventListener('click', async function(){
      const name = document.getElementById('q_name').value || '';
      const contact = document.getElementById('q_contact').value || '';
      const msg = document.getElementById('q_msg').value || '';
      const svg = getSVG(); if(!svg){ alert('No se encontr√≥ el lienzo SVG'); return; }
      const dataURL = qPrev.src || await svgToPNGDataURL(svg);
      const payload = buildPublicPayload(dataURL);
      const subject = encodeURIComponent(`Solicitud de cotizaci√≥n ¬∑ Dal√≠ Arquitectura ¬∑ ${new Date().toLocaleDateString()}`);
      const body = encodeURIComponent(
`Nombre/Empresa: ${name}
Contacto: ${contact}

Mensaje:
${msg}

Dise√±o (JSON):
${JSON.stringify(payload.design)}

Imagen (dataURL ‚Äî peg√° en navegador si tu cliente no adjunta):
${(payload.preview || '').substring(0,120)}...`
      );
      window.location.href = `mailto:dario@dali-arquitectura.com.ar?subject=${subject}&body=${body}`;
      qInfo.textContent = "Abriendo tu cliente de correo‚Ä¶";
    });
  }
})();
</script>
/* ========= CONFIG ========= */
const WHATSAPP_NUMBER = "5491160410607";  // tu n√∫mero (solo d√≠gitos)

/* ========= UTILIDADES ========= */
const reEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
const $ = id => document.getElementById(id);
const digits = s => String(s||"").replace(/\D+/g,"");
function setInfo(m){ const el=$('q_info'); if(el) el.textContent=m; }

/* Convertir la preview a JPEG (canvas/svg/img) */
async function getPreviewJPEG(){
  // 1) canvas (preferido)
  const cvs = document.querySelector("canvas#stage, canvas.preview, canvas");
  if (cvs && cvs.toDataURL) {
    const c = document.createElement("canvas");
    c.width = cvs.width; c.height = cvs.height;
    const ctx = c.getContext("2d");
    ctx.fillStyle = "#ffffff"; ctx.fillRect(0,0,c.width,c.height);
    ctx.drawImage(cvs,0,0);
    return c.toDataURL("image/jpeg", 0.9);
  }
  // 2) svg
  const svg = document.getElementById("svg") || document.querySelector("svg");
  if (svg) {
    const xml = new XMLSerializer().serializeToString(svg);
    const img = new Image();
    img.src = "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(xml)));
    await new Promise(res => { img.onload = res; });
    const c = document.createElement("canvas");
    c.width = img.width || 1600; c.height = img.height || 1200;
    const ctx = c.getContext("2d");
    ctx.fillStyle = "#ffffff"; ctx.fillRect(0,0,c.width,c.height);
    ctx.drawImage(img,0,0,c.width,c.height);
    return c.toDataURL("image/jpeg", 0.9);
  }
  // 3) <img id="preview">
  const im = $("preview");
  if (im && im.src) {
    const tmp = new Image(); tmp.src = im.src;
    await new Promise(r=> tmp.onload = r);
    const c = document.createElement("canvas");
    c.width = tmp.naturalWidth || tmp.width || 1600;
    c.height = tmp.naturalHeight || tmp.height || 1200;
    const ctx = c.getContext("2d");
    ctx.fillStyle = "#ffffff"; ctx.fillRect(0,0,c.width,c.height);
    ctx.drawImage(tmp,0,0,c.width,c.height);
    return c.toDataURL("image/jpeg", 0.9);
  }
  return "";
}

/* Copiar imagen al portapapeles (si el navegador lo permite) */
async function copyImageToClipboard(jpegDataUrl){
  try{
    if(!jpegDataUrl) return;
    if (navigator.clipboard && window.ClipboardItem){
      const res = await fetch(jpegDataUrl);
      const blob = await res.blob();
      await navigator.clipboard.write([new ClipboardItem({[blob.type]: blob})]);
      setInfo("Imagen copiada. Pegala en WhatsApp (Ctrl+V).");
    }
  }catch(e){ /* ignorar */ }
}

/* Webhook Email con fallbacks */
async function postWebhook(payload){
  const url = (window.CONTACT && CONTACT.webhook_url) || "";
  if(!url) return {ok:false};
  try{
    const r = await fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
    if(r.ok) return {ok:true,via:"json"};
  }catch(e){}
  try{
    await fetch(url,{method:"POST",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify(payload),mode:"no-cors"});
    return {ok:true,via:"text/plain-no-cors"};
  }catch(e){}
  try{
    let ifr=$('send_target_iframe'); if(!ifr){ ifr=document.createElement('iframe'); ifr.name=ifr.id='send_target_iframe'; ifr.style.display='none'; document.body.appendChild(ifr); }
    const f=document.createElement('form'); f.action=url; f.method='POST'; f.enctype='text/plain'; f.target='send_target_iframe';
    const t=document.createElement('textarea'); t.name='raw'; t.value=JSON.stringify(payload);
    f.appendChild(t); document.body.appendChild(f); f.submit(); setTimeout(()=>{try{f.remove()}catch{}},800);
    return {ok:true,via:"form-post"};
  }catch(e){}
  return {ok:false};
}

/* Enviar una copia por mail cuando el canal es WhatsApp */
async function sendLeadCopyEmail(payload){
  const copy = {
    meta: { channel: "whatsapp", ts: new Date().toISOString() },
    contact: {
      name: payload?.contact?.name || "",
      contact: payload?.contact?.contact || "", // tel√©fono escrito por el usuario
      msg: payload?.contact?.msg || ""
    },
    design: payload?.design || {},
    image: payload?.image || ""  // JPEG ya generado
  };
  try { postWebhook(copy); } catch(e) {}
}

/* Abrir TU WhatsApp directo y preparar imagen */
async function openWhatsAppDirect(payload){
  setInfo("Preparando WhatsApp‚Ä¶");

  // forzar JPEG y copiarlo si se puede
  payload.image = await getPreviewJPEG();
  await copyImageToClipboard(payload.image);

  const name = payload?.contact?.name || "";
  const msg  = payload?.contact?.msg  || "";
  const texto = encodeURIComponent(`Quiero cotizar este dise√±o.\n\nNombre/Empresa: ${name}\n${msg||""}`);

  // forzado a tu chat
  const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${texto}`;
  window.open(url, "_blank");

  // enviar copia por mail para registrar el lead
  sendLeadCopyEmail(payload);
  setInfo("WhatsApp abierto. Envi√© copia por mail ‚úÖ");
}

/* Listener del bot√≥n: valida, decide canal y env√≠a */
(function wireSend(){
  const btn = $("q_send"); if(!btn) return;
  const clone = btn.cloneNode(true); btn.parentNode.replaceChild(clone, btn);

  clone.addEventListener("click", async (e)=>{
    e.preventDefault();

    const name    = ($("q_name")?.value || $("c_name")?.value || "").trim();
    const contact = ($("q_contact")?.value || $("c_contact")?.value || "").trim();
    const msg     = ($("q_msg")?.value || $("c_msg")?.value || "").trim();

    if(!name){ setInfo("Complet√° tu nombre / empresa."); ($("q_name")||$("c_name"))?.focus(); return; }
    if(!contact){ setInfo("Complet√° Email o WhatsApp."); ($("q_contact")||$("c_contact"))?.focus(); return; }

    // Construir payload desde tu funci√≥n si existe
    let payload = (typeof buildPayload==="function") ? await buildPayload() : {contact:{}, design:{}, image:""};
    payload.contact = Object.assign({}, payload.contact, { name, contact, msg });

    const isMail = reEmail.test(contact);

    if (isMail){
      // EMAIL ‚Üí webhook
      setInfo("Enviando‚Ä¶");
      const r = await postWebhook(payload);
      setInfo(r.ok ? "Enviado ‚úÖ" : "No se pudo confirmar el env√≠o");
    } else {
      // WHATSAPP ‚Üí tu chat + copia por mail
      await openWhatsAppDirect(payload);
    }
  });
})();
</script>

</body>
</html>
